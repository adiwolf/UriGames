<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××©×—×§ ×”×“×•×‘ ×”×¨×¢×‘ - ×’×¨×¡×” ××•× ×¤×©×ª</title>
    <!-- ×˜×¢×™× ×ª Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            background-image: url('https://placehold.co/1200x800/e0f2f1/004d40?text=Forest+Background'); /* ×ª××•× ×ª ×™×¢×¨ ×›×¨×§×¢ */
            background-size: cover;
            background-position: center;
        }
        .game-container {
            max-width: 600px; /* ×”×’×“×œ×ª ×”××™×›×œ ×œ×§× ×‘×¡ */
            min-height: 700px;
        }
        canvas {
            background-color: #6d936e; /* ×¨×§×¢ ×™×¢×¨ ×‘×”×™×¨ */
            border: 4px solid #4a2c17; /* ××¡×’×¨×ª ×¢×¥ */
            border-radius: 1rem;
            display: block;
            width: 100%;
            height: 400px; /* ×’×•×‘×” ×§×‘×•×¢ ×œ×§× ×‘×¡ */
            margin-bottom: 1rem;
            cursor: pointer;
        }
        .bear-message {
            min-height: 4rem;
        }
    </style>
</head>
<body class="p-4 flex items-center justify-center min-h-screen">

    <div id="gameContainer" class="game-container bg-white p-6 md:p-8 rounded-2xl shadow-2xl text-center border-4 border-yellow-700/50">
        <!-- ×›×•×ª×¨×ª ×•× ×™×§×•×“ -->
        <h1 class="text-3xl font-extrabold text-yellow-800 mb-2">××©×—×§ ×”×“×•×‘ ×”×¨×¢×‘ ğŸ•¹ï¸</h1>
        <p class="text-base text-gray-600 mb-4">×”×©×ª××©×• ×‘××§×©×™ **×”×—×™×¦×™×** ××• **×”×§×œ×™×§×•** ×¢×œ ×”××–×•×Ÿ ×›×“×™ ×œ×”×–×™×– ××ª ×”×“×•×‘ ×•×œ×‘×—×•×¨.</p>

        <div class="mb-4 bg-yellow-100 p-3 rounded-xl shadow-inner border-2 border-yellow-500 flex justify-between items-center">
            <p id="scoreDisplay" class="text-2xl font-bold text-yellow-700">× ×™×§×•×“: 50</p>
            <p class="text-sm text-gray-500">××©×ª××©: <span id="userIdDisplay">×˜×•×¢×Ÿ...</span></p>
        </div>

        <!-- ×§× ×‘×¡ ×œ××©×—×§ ×”××•× ×¤×© -->
        <canvas id="gameCanvas" width="550" height="400"></canvas>

        <!-- ×ª×¦×•×’×ª ×”×”×•×“×¢×” -->
        <div id="messageDisplay" class="bear-message bg-yellow-600/10 text-yellow-800 p-3 rounded-xl border border-yellow-600 font-semibold italic mb-4 flex items-center justify-center">
            ×œ×—×¦×• ×¢×œ ××§×© ×—×¥ ×›×“×™ ×œ×”×ª×—×™×œ!
        </div>

        <!-- ×›×¤×ª×•×¨ ××™×¤×•×¡ -->
        <button id="resetButton" class="mt-2 w-full bg-gray-300 text-gray-700 p-2 rounded-xl font-bold hover:bg-gray-400/80 transition focus:outline-none focus:ring-4 focus:ring-gray-300">
            ××™×¤×•×¡ × ×™×§×•×“
        </button>
        
        <!-- ×”×•×“×¢×•×ª ×¡×˜×˜×•×¡ (×˜×¢×™× ×”/×©×’×™××”) -->
        <div id="statusMessage" class="mt-4 text-sm text-center text-gray-500">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
    </div>

    <!-- ×˜×¢×™× ×ª Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, runTransaction, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ×”×’×“×¨×ª ××©×ª× ×™× ×’×œ×•×‘×œ×™×™× ×œ-Firebase
        let app, db, auth, userId = null;
        let currentScore = 50;
        let isProcessing = false; // ×“×’×œ ×œ×× ×™×¢×ª ×”×§×œ×§×•×ª/×”×ª× ×’×©×•×™×•×ª ×›×¤×•×œ×•×ª ×‘×–××Ÿ ×¢×“×›×•×Ÿ × ×™×§×•×“

        // ×”×¤×•× ×§×¦×™×•×ª ×”×××™×¨×•×ª × ×ª×•× ×™× ×’×œ×•×‘×œ×™×™×
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // ×”×’×“×¨×ª ×¨××ª ×œ×•×’ ×¢×‘×•×¨ Firestore (×œ×¦×•×¨×š ×“×™×‘×•×’)
        setLogLevel('Debug');

        // ××œ×× ×˜×™× ×‘-DOM
        const scoreDisplay = document.getElementById('scoreDisplay');
        const messageDisplay = document.getElementById('messageDisplay');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const statusMessage = document.getElementById('statusMessage');
        const resetButton = document.getElementById('resetButton');
        
        // Canvas elements and setup
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // ×”×’×“×¨×•×ª ×”××©×—×§
        const INITIAL_SCORE = 50;
        const SCORE_REF_PATH = (uid) => `artifacts/${appId}/users/${uid}/bear_game_scores/current`;

        // ××•×‘×™×™×§×˜ ×ª×•×¦××•×ª ×œ×©×œ×‘ 1
        const outcomes = {
            fish: { scoreChange: 5, message: "×™×××™! ×”×“×’ ×˜×¢×™×! ×”×“×•×‘ ×©××— ×××•×“. ğŸ˜Š", emoji: "ğŸ˜‹", nextStage: 'shop' },
            banana: { scoreChange: -5, message: "××•×™, ×‘× × ×”... ×™×© ×œ×• ×›××‘ ×‘×˜×Ÿ! ğŸ˜–", emoji: "ğŸ¤¢", nextStage: 'main' },
            honey: { scoreChange: -5, message: "×›×œ ×›×š ××ª×•×§... ×™×© ×›××‘ ×©×™× ×™×™× × ×•×¨××™! ğŸ˜¬", emoji: "ğŸ¦·", nextStage: 'main' }
        };

        // ××•×‘×™×™×§×˜ ×ª×•×¦××•×ª ×œ×©×œ×‘ 2 (×—× ×•×ª ×”×“×’×™×)
        const fishShopOutcomes = {
            // *** ×©×™× ×•×™: ×”××™××•×’'×™ ×”×•× ×”×“×•×‘ (ğŸ») ×•×”×× ×™××¦×™×” ×”×™× ×”'×¨×™×§×•×“' ***
            small: { cost: 2, message: "×”×“×’ ×”×§×˜×Ÿ ××¡×¤×§! ×”×“×•×‘ ×©××— ×•××ª×’×œ×’×œ ××¦×—×•×§! ğŸ¥³", emoji: "ğŸ»", bearAction: 'happy_spin' }, 
            // *** ×©×™× ×•×™: ×”××™××•×’'×™ ×”×•× ×”×“×•×‘ (ğŸ») ***
            medium: { cost: 7, message: "×“×’ ×‘×™× ×•× ×™ ×›×‘×“... ×”×“×•×‘ ×§×•×¨× ×œ×—×‘×¨ ×œ×¢×–×¨×”! ğŸ¤", emoji: "ğŸ»", bearAction: null }, 
            // *** ×©×™× ×•×™: ×”××™××•×’'×™ ×”×•× ×”×“×•×‘ (ğŸ») ×•×”×× ×™××¦×™×” ×”×™× ×”'×‘×œ×‘×•×œ' ***
            large: { cost: 10, message: "×“×’ ×¢× ×§! ×”×“×•×‘ × ×•×¤×œ ×¢×œ ×”×’×‘ ×•××¡×ª×•×‘×‘ ×‘×‘×œ×‘×•×œ. ğŸ¤•", emoji: "ğŸ»", bearAction: 'confused_spin' }
        };

        // ×¤×¨××˜×¨×™× ×©×œ ×”××©×—×§ ×•×”×“×•×‘
        const BEAR_SPEED = 5;
        // *** × ×•×¡×£: ×××¤×™×™× ×™ ×¡×™×‘×•×‘ ×œ×“×•×‘ ***
        let bear = { 
            x: canvas.width / 2, 
            y: canvas.height / 2, 
            size: 30, 
            emoji: "ğŸ»", 
            rotationAngle: 0, 
            rotationActive: false, 
            rotationDirection: 1, 
            bearAction: null 
        };
        let keys = {};
        let currentStage = 'main'; // 'main' or 'shop'
        let items = []; // Current items on the canvas

        // ×”×’×“×¨×ª ×¤×¨×™×˜×™× ×œ×©×œ×‘ ×”×¨××©×™
        const mainItems = [
            { name: 'fish', emoji: 'ğŸŸ', x: canvas.width * 0.15, y: canvas.height * 0.25, size: 20, outcome: outcomes.fish },
            { name: 'banana', emoji: 'ğŸŒ', x: canvas.width * 0.50, y: canvas.height * 0.75, size: 20, outcome: outcomes.banana },
            { name: 'honey', emoji: 'ğŸ¯', x: canvas.width * 0.85, y: canvas.height * 0.25, size: 20, outcome: outcomes.honey }
        ];

        // ×”×’×“×¨×ª ×¤×¨×™×˜×™× ×œ×©×œ×‘ ×”×—× ×•×ª
        const shopItems = [
            { name: 'small', emoji: 'ğŸ ', x: canvas.width * 0.15, y: canvas.height * 0.5, size: 20, cost: fishShopOutcomes.small.cost, outcome: fishShopOutcomes.small },
            { name: 'medium', emoji: 'ğŸ¡', x: canvas.width * 0.50, y: canvas.height * 0.5, size: 20, cost: fishShopOutcomes.medium.cost, outcome: fishShopOutcomes.medium },
            { name: 'large', emoji: 'ğŸ‹', x: canvas.width * 0.85, y: canvas.height * 0.5, size: 20, cost: fishShopOutcomes.large.cost, outcome: fishShopOutcomes.large }
        ];


        /**
         * ×¤×•× ×§×¦×™×” ×œ×”××ª× ×” (×”×©×”×™×™×ª ×§×•×“)
         * @param {number} ms - ×–××Ÿ ×”×”××ª× ×” ×‘××œ×¤×™×•×ª ×”×©× ×™×™×”
         */
        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));
        
        // --- Canvas Drawing and Game Logic ---

        /**
         * ××©×¨×˜×˜ ××™××•×’'×™ ×‘××¨×›×– × ×§×•×“×”
         * @param {string} emoji - ×”××™××•×’'×™ ×œ×©×¨×˜×•×˜
         * @param {number} x - ×§×•××•×¨×“×™× ×˜×ª X ××¨×›×–
         * @param {number} y - ×§×•××•×¨×“×™× ×˜×ª Y ××¨×›×–
         * @param {number} size - ×’×•×“×œ ×”×¤×•× ×˜
         */
        function drawEmoji(emoji, x, y, size) {
            ctx.font = `${size}px sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(emoji, x, y);
        }

        /**
         * ××©×¨×˜×˜ ××ª ×”×“×•×‘ ×•×¤×¨×™×˜×™ ×”××–×•×Ÿ
         */
        function drawGame() {
            // ×× ×§×” ××ª ×”×§× ×‘×¡
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // ×©×¨×˜×•×˜ ×”×¤×¨×™×˜×™× (××–×•×Ÿ ××• ×“×’×™× ×‘×—× ×•×ª)
            items.forEach(item => {
                
                // ×©×¨×˜×•×˜ ×”××™××•×’'×™ ×©×œ ×”×¤×¨×™×˜
                drawEmoji(item.emoji, item.x, item.y - 15, item.size * 1.5);

                // ×× ×× ×—× ×• ×‘×—× ×•×ª, ××¦×™×’×™× ××ª ×”××—×™×¨
                if (currentStage === 'shop' && item.cost !== undefined) {
                     ctx.font = '12px Inter, sans-serif';
                     // *** ×ª×™×§×•×Ÿ: ×¦×‘×¢ ××“×•× ×× ××™×Ÿ ××¡×¤×™×§ × ×§×•×“×•×ª ***
                     ctx.fillStyle = currentScore < item.cost ? '#cc0000' : '#1e3a8a'; 
                     ctx.fillText(`-${item.cost} × ×§'`, item.x, item.y + item.size + 10);
                }
            });

            // ×©×¨×˜×•×˜ ×”×“×•×‘ ×¢× ×¡×™×‘×•×‘ ×× ×¦×¨×™×š
            ctx.save();
            ctx.translate(bear.x, bear.y);
            ctx.rotate(bear.rotationAngle);
            // ×©×¨×˜×•×˜ ×”×“×•×‘ ×‘× ×§×•×“×” (0,0) ×œ××—×¨ ×©×‘×•×¦×¢×• ×ª×¨×’×•× ×•×¡×™×‘×•×‘
            drawEmoji(bear.emoji, 0, 0, bear.size * 2); 
            ctx.restore();
        }

        /**
         * ×¢×“×›×•×Ÿ ××™×§×•× ×”×“×•×‘
         */
        function updatePosition() {
            let newX = bear.x;
            let newY = bear.y;

            if (keys['ArrowUp'] || keys['w']) newY -= BEAR_SPEED;
            if (keys['ArrowDown'] || keys['s']) newY += BEAR_SPEED;
            if (keys['ArrowLeft'] || keys['a']) newX -= BEAR_SPEED;
            if (keys['ArrowRight'] || keys['d']) newX += BEAR_SPEED;

            // ×”×’×‘×œ×ª ×ª× ×•×¢×” ×‘×’×‘×•×œ×•×ª ×”×§× ×‘×¡
            const halfSize = bear.size;
            bear.x = Math.max(halfSize, Math.min(newX, canvas.width - halfSize));
            bear.y = Math.max(halfSize, Math.min(newY, canvas.height - halfSize));

            checkCollisions();
        }

        /**
         * ×‘×“×™×§×ª ×”×ª× ×’×©×•×ª ×‘×™×Ÿ ×”×“×•×‘ ×œ×¤×¨×™×˜×™ ×”××–×•×Ÿ
         */
        function checkCollisions() {
            if (isProcessing) return; // ××•× ×¢ ×”×ª× ×’×©×•×ª ×‘×–××Ÿ ×¢×™×‘×•×“ × ×™×§×•×“

            items.forEach(item => {
                const dx = bear.x - item.x;
                const dy = bear.y - item.y;
                const distance = Math.sqrt(dx * dx + dy * dy);

                // ×× ×™×© ×”×ª× ×’×©×•×ª
                if (distance < bear.size + item.size * 0.5) { // ×¨×“×™×•×¡ ×”×ª× ×’×©×•×ª
                    if (currentStage === 'main') {
                        handleChoice(item.name); 
                    } else if (currentStage === 'shop') {
                        handlePurchase(item.name); 
                    }
                }
            });
        }

        /**
         * ×œ×•×œ××ª ×”××©×—×§ ×”×¨××©×™×ª (×× ×™××¦×™×”)
         */
        function gameLoop() {
            if (!isProcessing) {
                updatePosition();
            }
            
            // *** ×œ×•×’×™×§×ª ×¡×™×‘×•×‘ ×”×“×•×‘ ***
            if (bear.rotationActive) {
                if (bear.bearAction === 'happy_spin') {
                    // ×¡×™×‘×•×‘ ×§×œ ××¦×“ ×œ×¦×“ (×¨×™×§×•×“)
                    const maxAngle = Math.PI / 8; // ×–×•×•×™×ª ××§×¡×™××œ×™×ª (22.5 ××¢×œ×•×ª)
                    const rotationSpeed = 0.15;

                    bear.rotationAngle += rotationSpeed * bear.rotationDirection;
                    
                    // ×”×—×œ×¤×ª ×›×™×•×•×Ÿ ×›×©×”×’×¢× ×• ×œ×’×‘×•×œ
                    if (bear.rotationAngle > maxAngle) {
                        bear.rotationDirection = -1;
                    } else if (bear.rotationAngle < -maxAngle) {
                        bear.rotationDirection = 1;
                    }
                } 
                else if (bear.bearAction === 'confused_spin') {
                    // ×¡×™×‘×•×‘ ×¨×¦×™×£ (×‘×œ×‘×•×œ)
                    bear.rotationAngle += 0.2; 
                }
            } 
            
            drawGame();
            requestAnimationFrame(gameLoop);
        }

        // --- Input Handling (Keyboard and Touch) ---

        document.addEventListener('keydown', (e) => {
            keys[e.key] = true;
        });

        document.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        // Touch/Click handling on the canvas for mobile input
        canvas.addEventListener('click', (e) => {
            if (isProcessing) return;

            const rect = canvas.getBoundingClientRect();
            // ×—×™×©×•×‘ ××™×§×•× ×”×œ×—×™×¦×” ×™×—×¡×™×ª ×œ×§× ×‘×¡
            const clickX = (e.clientX - rect.left) * (canvas.width / rect.width);
            const clickY = (e.clientY - rect.top) * (canvas.height / rect.height);

            items.forEach(item => {
                const dx = clickX - item.x;
                const dy = clickY - item.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                // ×× ×”××©×ª××© ×œ×—×¥ ×§×¨×•×‘ ×œ×¤×¨×™×˜
                if (distance < item.size * 3) { // ×”×’×“×œ×ª ×©×˜×— ×”×œ×—×™×¦×” ×œ× ×•×—×•×ª
                    // ×”×–×–×ª ×”×“×•×‘ ××œ ×”×¤×¨×™×˜ ×•×‘×—×™×¨×” ××•×˜×•××˜×™×ª (×¢×•×‘×¨ ×“×¨×š checkCollisions)
                    bear.x = item.x;
                    bear.y = item.y; 
                    // ×”×¤×¢×œ×ª ×‘×“×™×§×ª ×”×”×ª× ×’×©×•×ª ××™×“
                    checkCollisions();
                }
            });
        });

        // --- Firebase and Game Stage Functions (Adapted) ---

        /**
         * ××¢×‘×¨ ×‘×™×Ÿ ×©×œ×‘×™ ×”××©×—×§
         * @param {string} stage - 'main' ××• 'shop'
         */
        function setStage(stage) {
            currentStage = stage;
            bear.emoji = "ğŸ»"; // ××™×¤×•×¡ ××™××•×’'×™ ×”×“×•×‘
            bear.rotationActive = false; // ××™×¤×•×¡ ×¡×™×‘×•×‘
            bear.rotationAngle = 0; // ××™×¤×•×¡ ×–×•×•×™×ª

            // ××™×§×•× ×‘×¨×™×¨×ª ×”××—×“×œ - ××¨×›×–
            bear.x = canvas.width / 2;
            bear.y = canvas.height / 2; 

            if (stage === 'shop') {
                items = shopItems;
                messageDisplay.textContent = "×‘×¨×•×š ×”×‘× ×œ×—× ×•×ª ×”×“×’×™×! ×‘×—×¨ ×“×’ (×”× ×§×•×“×•×ª ×™×¨×“×• ××”× ×™×§×•×“ ×”×›×œ×œ×™).";
                bear.emoji = "ğŸ»"; 
                // ** ×”×“×•×‘ ××ª×—×™×œ ×œ××¢×œ×” ×‘×—× ×•×ª ×”×“×’×™× **
                bear.y = bear.size * 2; 
            } else { // 'main'
                items = mainItems;
                messageDisplay.textContent = "×”×“×•×‘ ×”×¨×¢×‘ ××—×›×” ×œ×‘×—×™×¨×” ×©×œ×š...";
                bear.emoji = "ğŸ»";
                // × ×©××¨ ×‘××™×§×•× ×‘×¨×™×¨×ª ×”××—×“×œ ×‘××¨×›×–
            }
            
            toggleResetButton(true);
            drawGame(); 
        }

        /**
         * ×¢×“×›×•×Ÿ ×”× ×™×§×•×“ ×‘-Firestore ×‘×××¦×¢×•×ª ×˜×¨× ×–×§×¦×™×”
         * @param {number} change - ×”×©×™× ×•×™ ×‘× ×™×§×•×“ (+/-)
         * @param {string} msg - ×”×”×•×“×¢×” ×”×—×“×©×”
         * @param {string} emoji - ×”××™××•×’'×™ ×”×—×“×©
         * @param {string} nextStage - ×”×©×œ×‘ ×”×‘× ('main' ××• 'shop')
         * @param {string} [bearAction=null] - ×¤×¢×•×œ×ª ×× ×™××¦×™×” ×œ×“×•×‘
         */
        async function updateScoreInFirestore(change, msg, emoji, nextStage, bearAction = null) {
            if (!db || !userId || isProcessing) {
                return false;
            }
            
            isProcessing = true;
            
            const scoreRef = doc(db, SCORE_REF_PATH(userId));
            let success = false;

            try {
                await runTransaction(db, async (transaction) => {
                    const docSnapshot = await transaction.get(scoreRef);
                    let newScore = docSnapshot.exists() && docSnapshot.data().score !== undefined ? docSnapshot.data().score + change : INITIAL_SCORE + change;

                    if (change < 0 && newScore < 0) {
                         throw new Error("××™×Ÿ ××¡×¤×™×§ × ×§×•×“×•×ª ×œ×‘×™×¦×•×¢ ×¤×¢×•×œ×” ×–×•!");
                    }
                    
                    newScore = Math.max(0, newScore); 

                    transaction.set(scoreRef, { score: newScore, updated: new Date().toISOString() });
                    
                    currentScore = newScore;
                    scoreDisplay.textContent = `× ×™×§×•×“: ${currentScore}`;
                    messageDisplay.textContent = msg;
                    bear.emoji = emoji; // ×¢×“×›×•×Ÿ ××™××•×’'×™ ×”×“×•×‘ ×‘×§× ×‘×¡
                    success = true;
                });
            } catch (e) {
                console.error("Transaction failed: ", e);
                messageDisplay.textContent = `×©×’×™××”: ${e.message.includes('points') ? e.message : '×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”× ×™×§×•×“'}`;
                bear.emoji = "âŒ";
            } finally {
                if (success) {
                    // *** ×”×•×¡×¤×ª ×œ×•×’×™×§×” ×œ×¡×™×‘×•×‘ ×”×“×•×‘ ***
                    if (bearAction === 'happy_spin' || bearAction === 'confused_spin') {
                         bear.bearAction = bearAction;
                         bear.rotationActive = true;
                         bear.rotationDirection = 1; 
                         
                         // ×¢×¦×™×¨×ª ×”×¡×™×‘×•×‘ ××—×¨×™ 3 ×©× ×™×•×ª
                         setTimeout(() => { 
                             bear.rotationActive = false; 
                             bear.bearAction = null; 
                             bear.rotationAngle = 0; // ××™×¤×•×¡ ×–×•×•×™×ª
                         }, 3000); 
                    }
                    // *** ×¡×•×£ ×œ×•×’×™×§×ª ×”×¡×™×‘×•×‘ ***

                    await delay(2000); 
                }
                isProcessing = false;
                
                // ×× ×”×™×™×ª×” ×©×’×™××ª ××—×¡×•×¨ ×‘× ×™×§×•×“ ×‘×—× ×•×ª, × ×©××¨×™× ×‘×—× ×•×ª. ××—×¨×ª ×¢×•×‘×¨×™× ×œ×©×œ×‘ ×”×‘×.
                const finalNextStage = success ? nextStage : (e.message.includes('points') && currentStage === 'shop' ? 'shop' : 'main');
                setStage(finalNextStage);
            }
            return success;
        }

        /**
         * ×¤×•× ×§×¦×™×” ×”××˜×¤×œ×ª ×‘×‘×—×™×¨×ª ×”××•×›×œ ×”×¨××©×™×ª (××•×¤×¢×œ×ª ×“×¨×š checkCollisions)
         * @param {string} choice - ×©× ×”×‘×—×™×¨×” ('fish', 'banana', 'honey')
         */
        function handleChoice(choice) {
            const outcome = outcomes[choice];

            if (outcome) {
                const nextStage = choice === 'fish' ? 'shop' : 'main'; 
                // ××™×Ÿ ×¤×¢×•×œ×ª ×× ×™××¦×™×” ××™×•×—×“×ª ×œ×©×œ×‘ ×–×”, ×œ×›×Ÿ ××¢×‘×™×¨×™× null
                updateScoreInFirestore(outcome.scoreChange, outcome.message, outcome.emoji, nextStage, null); 
            }
        }
        
        /**
         * ×¤×•× ×§×¦×™×” ×”××˜×¤×œ×ª ×‘×§× ×™×™×ª ×”×“×’ ×‘×—× ×•×ª (××•×¤×¢×œ×ª ×“×¨×š checkCollisions)
         * @param {string} size - ×’×•×“×œ ×”×“×’ ×”× ×‘×—×¨ ('small', 'medium', 'large')
         */
        function handlePurchase(size) {
            const outcome = fishShopOutcomes[size];
            
            if (outcome) {
                const change = -outcome.cost; 
                
                // ×‘×“×™×§×” ××§×“×™××” ×›×“×™ ×œ×ª×ª ×¤×™×“×‘×§ ××”×™×¨ ×œ×¤× ×™ ×”×˜×¨× ×–×§×¦×™×”
                if (currentScore + change < 0) {
                     messageDisplay.textContent = "××™×Ÿ ×œ×š ××¡×¤×™×§ × ×§×•×“×•×ª ×œ×§× ×™×™×ª ×“×’ ×–×”!";
                     bear.emoji = "ğŸ˜”";
                     delay(2000).then(() => setStage('shop')); // × ×©××¨×™× ×‘×—× ×•×ª
                     return;
                }
                
                // ××¢×‘×™×¨×™× ××ª bearAction ×¢×‘×•×¨ ×”×¡×™×‘×•×‘
                updateScoreInFirestore(change, outcome.message, outcome.emoji, 'main', outcome.bearAction);
            }
        }

        /**
         * ×¤×•× ×§×¦×™×” ×œ××™×¤×•×¡ ×”× ×™×§×•×“ ×œ× ×™×§×•×“ ×”×”×ª×—×œ×ª×™
         */
        async function resetScore() {
             if (!db || !userId) {
                console.error("Firebase is not initialized or user ID is missing.");
                return;
            }
            
            if (!await showConfirmation('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××¤×¡ ××ª ×”× ×™×§×•×“ ×œ-50?')) return;
            
            const scoreRef = doc(db, SCORE_REF_PATH(userId));
            try {
                toggleResetButton(false);
                messageDisplay.textContent = "×××¤×¡ × ×™×§×•×“...";
                await setDoc(scoreRef, { score: INITIAL_SCORE, updated: new Date().toISOString() });
                messageDisplay.textContent = "×”× ×™×§×•×“ ××•×¤×¡ ×œ-50. ×”×ª×—×œ ××—×“×©! ğŸ˜Š";
                bear.emoji = "ğŸ»";
            } catch (e) {
                console.error("Error resetting score:", e);
                messageDisplay.textContent = `×©×’×™××” ×‘××™×¤×•×¡: ${e.message}`;
            } finally {
                setStage('main'); 
                toggleResetButton(true);
            }
        }

        /**
         * × ×˜×¨×•×œ/×”×¤×¢×œ×ª ×›×¤×ª×•×¨ ×”××™×¤×•×¡ ×‘×œ×‘×“
         * @param {boolean} enable - ×”×× ×œ×”×¤×¢×™×œ (true) ××• ×œ× ×˜×¨×œ (false)
         */
        function toggleResetButton(enable) {
            resetButton.disabled = !enable;
            resetButton.classList.toggle('opacity-50', !enable);
            resetButton.classList.toggle('cursor-not-allowed', !enable);
        }
        
        /**
         * ×™×¦×™×¨×ª ×•×”×¦×’×ª ×ª×™×‘×ª ××™×©×•×¨ ××•×ª×××ª ××™×©×™×ª ×‘××§×•× alert()/confirm()
         */
        function showConfirmation(message) {
            return new Promise(resolve => {
                const modalOverlay = document.createElement('div');
                modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modalOverlay.dir = 'rtl';

                const modal = document.createElement('div');
                modal.className = 'bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full text-center';

                const p = document.createElement('p');
                p.className = 'text-lg font-semibold mb-6 text-gray-800';
                p.textContent = message;

                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'flex justify-around gap-4';

                const confirmBtn = document.createElement('button');
                confirmBtn.className = 'bg-red-500 text-white p-2 rounded-lg font-bold w-full hover:bg-red-600 transition';
                confirmBtn.textContent = '××™×©×•×¨ ××™×¤×•×¡';

                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'bg-gray-300 text-gray-800 p-2 rounded-lg font-bold w-full hover:bg-gray-400 transition';
                cancelBtn.textContent = '×‘×™×˜×•×œ';

                confirmBtn.onclick = () => {
                    document.body.removeChild(modalOverlay);
                    resolve(true);
                };
                
                cancelBtn.onclick = () => {
                    document.body.removeChild(modalOverlay);
                    resolve(false);
                };

                buttonContainer.appendChild(cancelBtn);
                buttonContainer.appendChild(confirmBtn);
                modal.appendChild(p);
                modal.appendChild(buttonContainer);
                modalOverlay.appendChild(modal);
                document.body.appendChild(modalOverlay);
            });
        }
        
        /**
         * ××ª×—×•×œ Firebase ×•×”××–× ×” ×œ× ×™×§×•×“
         */
        async function initializeGame() {
            try {
                statusMessage.textContent = "××ª×—×‘×¨ ×œ-Firebase...";
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        statusMessage.textContent = "××—×•×‘×¨. ×˜×•×¢×Ÿ × ×™×§×•×“...";
                        
                        listenToScoreUpdates(userId);
                        resetButton.addEventListener('click', resetScore);

                        setStage('main'); 
                    } else {
                        userIdDisplay.textContent = "×œ× ××—×•×‘×¨";
                        statusMessage.textContent = "×©×’×™××”: ×œ× × ×™×ª×Ÿ ×œ×”×ª×—×‘×¨ ×œ××¢×¨×›×ª.";
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                statusMessage.textContent = `×©×’×™××ª ××ª×—×•×œ: ${error.message}`;
            }
        }

        /**
         * ×”××–× ×” ×œ×©×™× ×•×™×™× ×‘× ×™×§×•×“ ×”××©×ª××©
         * @param {string} uid - ××–×”×” ×”××©×ª××©
         */
        function listenToScoreUpdates(uid) {
            const scoreRef = doc(db, SCORE_REF_PATH(uid));
            onSnapshot(scoreRef, (docSnapshot) => {
                if (docSnapshot.exists() && docSnapshot.data().score !== undefined) {
                    currentScore = docSnapshot.data().score;
                    scoreDisplay.textContent = `× ×™×§×•×“: ${currentScore}`;
                    statusMessage.textContent = "×”× ×™×§×•×“ × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”.";
                } else {
                    currentScore = INITIAL_SCORE;
                    scoreDisplay.textContent = `× ×™×§×•×“: ${currentScore}`;
                    setDoc(scoreRef, { score: INITIAL_SCORE, updated: new Date().toISOString() }).catch(e => console.error("Error setting initial score:", e));
                    statusMessage.textContent = "× ×™×§×•×“ ×”×ª×—×œ×ª×™ (50) × ×§×‘×¢.";
                }
            }, (error) => {
                console.error("Error listening to score:", error);
                statusMessage.textContent = `×©×’×™××” ×‘××–× ×” ×œ× ×™×§×•×“: ${error.message}`;
            });
        }

        // ×”×ª×—×œ×ª ×”××©×—×§ (×©×™××•×© ×‘-window.onload ×›×“×™ ×œ×•×•×“× ×©×›×œ ×”-DOM × ×˜×¢×Ÿ)
        window.onload = function () {
            initializeGame();
            requestAnimationFrame(gameLoop); // ×”×ª×—×œ×ª ×œ×•×œ××ª ×”××©×—×§
        }

    </script>
</body>
</html>
