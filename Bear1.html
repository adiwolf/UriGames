<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>砖拽  专注</title>
    <!-- 注转 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            background-image: url('https://placehold.co/1200x800/e0f2f1/004d40?text=Forest+Background'); /* 转转 注专 专拽注 */
            background-size: cover;
            background-position: center;
        }
        .game-container {
            max-width: 480px;
            min-height: 500px;
        }
        .bear-message {
            min-height: 6rem;
        }
        .choice-button {
            transition: all 0.2s;
            transform: scale(1);
        }
        .choice-button:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="p-4 flex items-center justify-center min-h-screen">

    <div id="gameContainer" class="game-container bg-white p-6 md:p-8 rounded-2xl shadow-2xl text-center border-4 border-yellow-700/50">
        <!-- 转专转 拽 -->
        <h1 class="text-4xl font-extrabold text-yellow-800 mb-2">砖拽  专注</h1>
        <p class="text-lg text-gray-600 mb-6">注专  专转  砖!</p>

        <div class="mb-6 bg-yellow-100 p-3 rounded-xl shadow-inner border-2 border-yellow-500">
            <p id="scoreDisplay" class="text-3xl font-bold text-yellow-700">拽: 50</p>
            <p class="text-sm text-gray-500"> 砖转砖: <span id="userIdDisplay">注...</span></p>
        </div>

        <!-- 转爪转 转 注 -->
        <div class="flex flex-col items-center mb-6">
            <div class="text-6xl mb-4" id="bearEmoji"></div>
            <div id="messageDisplay" class="bear-message bg-yellow-600/10 text-yellow-800 p-3 rounded-xl border border-yellow-600 font-semibold italic">
                 专注  专 砖...
            </div>
        </div>

        <!-- 砖 1: 专转  专砖转 -->
        <div id="mainChoiceContainer">
            <div id="choiceButtons" class="grid grid-cols-3 gap-4">
                <button data-choice="fish" class="choice-button bg-green-500 text-white p-3 rounded-xl font-bold text-lg shadow-md hover:bg-green-600 focus:outline-none focus:ring-4 focus:ring-green-300">
                     
                </button>
                <button data-choice="banana" class="choice-button bg-red-500 text-white p-3 rounded-xl font-bold text-lg shadow-md hover:bg-red-600 focus:outline-none focus:ring-4 focus:ring-red-300">
                     
                </button>
                <button data-choice="honey" class="choice-button bg-amber-500 text-white p-3 rounded-xl font-bold text-lg shadow-md hover:bg-amber-600 focus:outline-none focus:ring-4 focus:ring-amber-300">
                    砖 
                </button>
            </div>
        </div>

        <!-- 砖 2: 转  (住转专 转) -->
        <div id="fishShopContainer" class="hidden">
             <h2 class="text-2xl font-bold text-blue-700 mb-4">转  </h2>
             <p class="text-gray-700 mb-4">   转专?</p>
            <div id="shopChoiceButtons" class="grid grid-cols-3 gap-4">
                <button data-size="small" class="choice-button bg-blue-400 text-white p-3 rounded-xl font-bold text-lg shadow-md hover:bg-blue-500 focus:outline-none focus:ring-4 focus:ring-blue-300">
                     拽<br><span class="text-sm">注转: 2</span>
                </button>
                <button data-size="medium" class="choice-button bg-blue-600 text-white p-3 rounded-xl font-bold text-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300">
                     <br><span class="text-sm">注转: 7</span>
                </button>
                <button data-size="large" class="choice-button bg-blue-800 text-white p-3 rounded-xl font-bold text-lg shadow-md hover:bg-blue-900 focus:outline-none focus:ring-4 focus:ring-blue-300">
                     <br><span class="text-sm">注转: 10</span>
                </button>
            </div>
        </div>
        
        <!-- 驻转专 驻住 -->
        <button id="resetButton" class="mt-6 w-full bg-gray-300 text-gray-700 p-2 rounded-xl font-bold hover:bg-gray-400/80 transition focus:outline-none focus:ring-4 focus:ring-gray-300">
            驻住 拽
        </button>
        
        <!-- 注转 住住 (注/砖) -->
        <div id="statusMessage" class="mt-4 text-sm text-center text-gray-500">注 转...</div>
    </div>

    <!-- 注转 Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, runTransaction, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 专转 砖转  -Firebase
        let app, db, auth, userId = null;
        let currentScore = 50;
        let isProcessing = false; //  注转 拽拽转 驻转

        // 驻拽爪转 专转 转 
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // 专转 专转  注专 Firestore (爪专 )
        setLogLevel('Debug');

        //  -DOM
        const scoreDisplay = document.getElementById('scoreDisplay');
        const messageDisplay = document.getElementById('messageDisplay');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const bearEmoji = document.getElementById('bearEmoji');
        const statusMessage = document.getElementById('statusMessage');
        const resetButton = document.getElementById('resetButton');
        const mainChoiceContainer = document.getElementById('mainChoiceContainer');
        const fishShopContainer = document.getElementById('fishShopContainer');
        const shopChoiceButtons = document.getElementById('shopChoiceButtons');

        // 专转 砖拽
        const INITIAL_SCORE = 50;
        const SCORE_REF_PATH = (uid) => `artifacts/${appId}/users/${uid}/bear_game_scores/current`;

        // 拽 转爪转 砖 1
        const outcomes = {
            fish: { scoreChange: 5, message: "!  注!  砖 . ", emoji: "", nextStage: 'shop' },
            banana: { scoreChange: -5, message: ", ... 砖   ! ", emoji: "あ", nextStage: 'main' },
            honey: { scoreChange: -5, message: "  转拽... 砖  砖 专! ", emoji: "Ψ", nextStage: 'main' }
        };

        // 拽 转爪转 砖 2 (转 )
        const fishShopOutcomes = {
            small: { cost: 2, message: " 拽 住驻拽!  专拽 砖. ", emoji: "" },
            medium: { cost: 7, message: "  ...  拽专 专 注专! ", emoji: "" },
            large: { cost: 10, message: " 注拽!  驻 注  驻爪注! ", emoji: "" }
        };

        /**
         * 驻拽爪 转 (砖转 拽)
         * @param {number} ms -  转 驻转 砖
         */
        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        /**
         * 注专  砖 砖拽
         * @param {string} stage - 'main'  'shop'
         */
        function setStage(stage) {
            if (stage === 'shop') {
                mainChoiceContainer.classList.add('hidden');
                fishShopContainer.classList.remove('hidden');
                messageDisplay.textContent = "专  转 ! 专  (拽转 专 拽 ).";
                bearEmoji.textContent = ""; // ' 转  住祝
                // *FIX: enabling buttons after successful stage transition*
                toggleButtons(true); 
            } else { // 'main'
                fishShopContainer.classList.add('hidden');
                mainChoiceContainer.classList.remove('hidden');
                messageDisplay.textContent = " 专注  专 砖...";
                bearEmoji.textContent = "";
                // *FIX: enabling buttons after successful stage transition*
                toggleButtons(true);
            }
        }

        /**
         * 注 拽 -Firestore 爪注转 专拽爪
         * @param {number} change - 砖 拽 (+/-)
         * @param {string} msg - 注 砖
         * @param {string} emoji - ' 砖
         * @param {string} nextStage - 砖  ('main'  'shop'  'none')
         */
        async function updateScoreInFirestore(change, msg, emoji, nextStage) {
            if (!db || !userId || isProcessing) {
                console.error("Firebase is not initialized or processing another request.");
                return false;
            }
            
            isProcessing = true;
            toggleButtons(false);

            const scoreRef = doc(db, SCORE_REF_PATH(userId));
            let success = false;

            try {
                await runTransaction(db, async (transaction) => {
                    const docSnapshot = await transaction.get(scoreRef);
                    let newScore;

                    if (!docSnapshot.exists() || docSnapshot.data().score === undefined) {
                        newScore = INITIAL_SCORE + change;
                    } else {
                        newScore = docSnapshot.data().score + change;
                    }

                    // 拽  砖 住驻拽 拽转 拽
                    if (change < 0 && newScore < 0) {
                         throw new Error(" 住驻拽 拽转 爪注 驻注 !");
                    }
                    
                    newScore = Math.max(0, newScore); 

                    transaction.set(scoreRef, { score: newScore, updated: new Date().toISOString() });
                    
                    // 注  砖 转爪 驻 砖-onSnapshot 
                    currentScore = newScore;
                    scoreDisplay.textContent = `拽: ${currentScore}`;
                    messageDisplay.textContent = msg;
                    bearEmoji.textContent = emoji;
                    success = true;
                });
            } catch (e) {
                console.error("Transaction failed: ", e);
                messageDisplay.textContent = `砖: ${e.message.includes('points') ? e.message : '砖 注 拽'}`;
            } finally {
                if (success) {
                    await delay(2000); // 爪转 转爪 砖 2 砖转
                }
                isProcessing = false;
                
                // 注专 砖 驻 注砖  驻注转 驻转专
                if (success && nextStage === 'shop') {
                    setStage('shop');
                } else {
                    setStage('main');
                }
            }
            return success;
        }

        /**
         * 驻拽爪 驻转 专转  专砖转
         * @param {Event} event - 专注 爪
         */
        function handleChoice(event) {
            const choice = event.currentTarget.dataset.choice;
            const outcome = outcomes[choice];

            if (outcome) {
                //  专 , -nextStage  'shop'
                const nextStage = choice === 'fish' ? 'shop' : 'main'; 
                updateScoreInFirestore(outcome.scoreChange, outcome.message, outcome.emoji, nextStage);
            }
        }
        
        /**
         * 驻拽爪 驻转 拽转  转
         * @param {Event} event - 专注 爪
         */
        function handlePurchase(event) {
            const size = event.currentTarget.dataset.size;
            const outcome = fishShopOutcomes[size];
            
            if (outcome) {
                const change = -outcome.cost; // 注转 拽  驻转
                
                // 拽 拽  注 专拽爪  拽  
                if (currentScore + change < 0) {
                     messageDisplay.textContent = "  住驻拽 拽转 拽转  !";
                     bearEmoji.textContent = "";
                     // *FIX: need to re-enable buttons and stay in shop*
                     toggleButtons(true);
                     delay(2000).then(() => {
                        messageDisplay.textContent = "专  转 ! 专  (拽转 专 拽 ).";
                        bearEmoji.textContent = "";
                     });
                     return;
                }
                
                updateScoreInFirestore(change, outcome.message, outcome.emoji, 'main');
            }
        }

        /**
         * 驻拽爪 驻住 拽 拽 转转
         */
        async function resetScore() {
             if (!db || !userId) {
                console.error("Firebase is not initialized or user ID is missing.");
                return;
            }
            
            if (!await showConfirmation(' 转  砖专爪 驻住 转 拽 -50?')) return;
            
            const scoreRef = doc(db, SCORE_REF_PATH(userId));
            try {
                toggleButtons(false);
                messageDisplay.textContent = "驻住 拽...";
                await setDoc(scoreRef, { score: INITIAL_SCORE, updated: new Date().toISOString() });
                messageDisplay.textContent = "拽 驻住 -50. 转 砖! ";
                bearEmoji.textContent = "";
            } catch (e) {
                console.error("Error resetting score:", e);
                messageDisplay.textContent = `砖 驻住: ${e.message}`;
            } finally {
                setStage('main'); // 专 砖 专砖  驻注 驻转专
            }
        }

        /**
         * 专/驻注转 驻转专 专
         * @param {boolean} enable -  驻注 (true)  专 (false)
         */
        function toggleButtons(enable) {
            document.querySelectorAll('.choice-button').forEach(button => {
                button.disabled = !enable;
                button.classList.toggle('opacity-50', !enable);
                button.classList.toggle('cursor-not-allowed', !enable);
            });
            resetButton.disabled = !enable;
            resetButton.classList.toggle('opacity-50', !enable);
        }
        
        /**
         * 爪专转 爪转 转转 砖专 转转 砖转 拽 alert()/confirm()
         * (砖砖 砖专 专拽 注专 驻住 拽)
         */
        function showConfirmation(message) {
            return new Promise(resolve => {
                const modalOverlay = document.createElement('div');
                modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modalOverlay.dir = 'rtl';

                const modal = document.createElement('div');
                modal.className = 'bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full text-center';

                const p = document.createElement('p');
                p.className = 'text-lg font-semibold mb-6 text-gray-800';
                p.textContent = message;

                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'flex justify-around gap-4';

                const confirmBtn = document.createElement('button');
                confirmBtn.className = 'bg-red-500 text-white p-2 rounded-lg font-bold w-full hover:bg-red-600 transition';
                confirmBtn.textContent = '砖专 驻住';

                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'bg-gray-300 text-gray-800 p-2 rounded-lg font-bold w-full hover:bg-gray-400 transition';
                cancelBtn.textContent = '';

                confirmBtn.onclick = () => {
                    document.body.removeChild(modalOverlay);
                    resolve(true);
                };
                
                cancelBtn.onclick = () => {
                    document.body.removeChild(modalOverlay);
                    resolve(false);
                };

                buttonContainer.appendChild(cancelBtn);
                buttonContainer.appendChild(confirmBtn);
                modal.appendChild(p);
                modal.appendChild(buttonContainer);
                modalOverlay.appendChild(modal);
                document.body.appendChild(modalOverlay);
            });
        }
        
        /**
         * 转 Firebase  拽
         */
        async function initializeGame() {
            try {
                statusMessage.textContent = "转专 -Firebase...";
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        statusMessage.textContent = "专. 注 拽...";
                        
                        listenToScoreUpdates(userId);

                        // 爪专祝 驻 砖 1
                        document.querySelectorAll('#choiceButtons button').forEach(button => {
                            button.addEventListener('click', handleChoice);
                        });
                        // 爪专祝 驻 砖 2 (转)
                        document.querySelectorAll('#shopChoiceButtons button').forEach(button => {
                            button.addEventListener('click', handlePurchase);
                        });
                        
                        resetButton.addEventListener('click', resetScore);

                        setStage('main'); // 转 砖 专砖 驻注 驻转专
                    } else {
                        userIdDisplay.textContent = " 专";
                        statusMessage.textContent = "砖:  转 转专 注专转.";
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                statusMessage.textContent = `砖转 转: ${error.message}`;
            }
        }

        /**
         *  砖 拽 砖转砖
         * @param {string} uid -  砖转砖
         */
        function listenToScoreUpdates(uid) {
            const scoreRef = doc(db, SCORE_REF_PATH(uid));
            onSnapshot(scoreRef, (docSnapshot) => {
                if (docSnapshot.exists() && docSnapshot.data().score !== undefined) {
                    currentScore = docSnapshot.data().score;
                    scoreDisplay.textContent = `拽: ${currentScore}`;
                    statusMessage.textContent = "拽 注 爪.";
                } else {
                    currentScore = INITIAL_SCORE;
                    scoreDisplay.textContent = `拽: ${currentScore}`;
                    setDoc(scoreRef, { score: INITIAL_SCORE, updated: new Date().toISOString() }).catch(e => console.error("Error setting initial score:", e));
                    statusMessage.textContent = "拽 转转 (50) 拽注.";
                }
            }, (error) => {
                console.error("Error listening to score:", error);
                statusMessage.textContent = `砖  拽: ${error.message}`;
            });
        }

        // 转转 砖拽
        toggleButtons(false); 
        initializeGame();

    </script>
</body>
</html>
