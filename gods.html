<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×”×‘×œ×’×Ÿ ×”××•×œ×™××¤×™ - ×§×•×•×¡×˜ ×”××œ×™×</title>
    <!-- ×˜×¢×™× ×ª Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ×”×’×“×¨×•×ª ×›×œ×œ×™×•×ª ×•×’×•×¤×Ÿ */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #064e3b 100%); /* ×¨×§×¢ ××•×œ×™××¤×•×¡ */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }
        .game-container {
            max-width: 600px;
            width: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            text-align: center;
            direction: rtl;
        }
        .quest-title {
            color: #b91c1c; 
            font-size: 1.875rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        .quest-description {
            color: #1f2937;
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }
        /* ×¡×’× ×•×Ÿ ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×” */
        .action-btn {
            background-color: #059669;
            color: white;
            border-radius: 9999px;
            padding: 0.75rem 2rem;
            font-size: 1.125rem;
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .action-btn:hover {
            background-color: #047857;
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
        }
        /* ×¡×’× ×•×Ÿ ×§× ×‘×¡ */
        #gameCanvas {
            border: 4px solid #1f2937;
            background-color: #e5e7eb;
            touch-action: none; /* ×œ×× ×™×¢×ª ×’×œ×™×œ×” ×‘××¡×š ××’×¢ */
        }
        /* ×¡×’× ×•×Ÿ ×›×¤×ª×•×¨×™ ×©×œ×™×˜×” ×‘××’×¢ (×œ××•×‘×™×™×œ) */
        .touch-controls button {
            background-color: #3b82f6;
            color: white;
            padding: 0.75rem;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
            transition: background-color 0.1s;
        }
        .touch-controls button:active {
            background-color: #1d4ed8;
        }
    </style>
</head>
<body>

    <div id="game-app" class="game-container">
        <!-- ×ª×•×›×Ÿ ×”××©×—×§ ×™×™×˜×¢×Ÿ ×œ×›××Ÿ -->
    </div>

    <script>
        // --- ×× ×’× ×•×Ÿ ×’×œ×•×‘×œ×™ ×œ×˜×™×¤×•×œ ×‘×©×’×™××•×ª ×§×¨×™×˜×™×•×ª ---
        window.addEventListener('error', function(e) {
            const appElement = document.getElementById('game-app');
            if (appElement) {
                // ×”×¦×’×ª ×”×•×“×¢×ª ×©×’×™××” ×•×™×–×•××œ×™×ª ×¢×œ ×”××¡×š
                appElement.innerHTML = `
                    <div style="color: #991b1b; padding: 20px; text-align: center; background-color: #fee2e2; border: 2px solid #ef4444; border-radius: 8px;">
                        <h1 style="font-size: 24px; font-weight: bold;">×©×’×™××ª ×˜×¢×™× ×” ×§×¨×™×˜×™×ª! ğŸš¨</h1>
                        <p>×”××©×—×§ × ×›×©×œ ×‘×˜×¢×™× ×”. ×× × ×“×•×•×— ×¢×œ ×”×©×’×™××” ×”×‘××”:</p>
                        <p style="font-family: monospace; background: #fecaca; padding: 10px; border-radius: 4px; margin-top: 10px; overflow-wrap: break-word; color: #7f1d1d;">
                            ${e.message}
                        </p>
                        <p style="margin-top: 10px;">×‘×“×•×§ ××ª ×§×•× ×¡×•×œ×ª ×”××¤×ª×—×™× (F12) ×œ×¤×¨×˜×™× × ×•×¡×¤×™×.</p>
                    </div>
                `;
            }
            // ××•× ×¢ ××ª ×”×˜×™×¤×•×œ ×”××•×‘× ×” ×©×œ ×”×“×¤×“×¤×Ÿ ×‘×©×’×™××”
            e.preventDefault(); 
        });

        // ×”×’×“×¨×•×ª ×‘×¡×™×¡×™×•×ª
        const app = document.getElementById('game-app');
        let gameState = {
            currentQuest: 0,
            score: 0,
            inProgress: false,
        };

        // --- ××©×ª× ×™ ×§× ×‘×¡ ×’×œ×•×‘×œ×™×™× ---
        let canvas = null, ctx = null; // ××ª×—×•×œ ×›-null ×œ×× ×™×¢×ª ×©×’×™××•×ª ××•×§×“××•×ª
        let canvasState = {}; // ××¦×‘ ×”××©×—×§ ×”× ×•×›×—×™
        let keys = {}; // ××¢×§×‘ ××—×¨ ××§×©×™× ×œ×—×•×¦×™×
        let gameLoopId = null; // ××–×”×” ×œ×•×œ××ª ×”××©×—×§

        // --- ×”×’×“×¨×•×ª ×§×•×•×¡×˜×™× ---
        const quests = [
            {
                id: 1,
                name: "×–××•×¡: ××¨×•×¥ ×”×‘×¨×§×™×",
                god: "×–××•×¡",
                icon: "âš¡ğŸƒ",
                description: "×–××•×¡, ×ª×•×š ×›×“×™ × ×™×¡×™×•×Ÿ ×œ×©×¤×¨ ××ª ×™×›×•×œ×•×ª×™×• ×‘×¨×©×ª×•×ª ×—×‘×¨×ª×™×•×ª, ×”×ª×¢×¦×‘×Ÿ ××˜×¨×•×œ ×•×©×œ×— ×¡×˜×•×¨× ×–×¢× ×“×™×’×™×˜×œ×™. ×”×‘×¨×§×™× ×™×¦××• ××©×œ×™×˜×”! ×¢×œ×™×š ×œ× ×•×•×˜ ×‘××”×™×¨×•×ª ×‘×™×Ÿ ×”×‘×¨×§×™× ×”×¤×¨××™×™× ×›×“×™ ×œ× ×§×– ××ª ×”×× ×¨×’×™×” ×”×¢×•×“×¤×ª ×•×œ×™×™×¦×‘ ××ª ×©××™ ×”××•×œ×™××¤×•×¡ ×œ×¤× ×™ ×©×”×›×•×œ ×™×™×©×¨×£. ×§×•×©×™ ×’×‘×•×”! ×¢×œ×™×š ×œ×”×ª×—××§ ×-15 ×‘×¨×§×™×! ××•×ª×¨×•×ª ×¨×§ 2 ×¤×’×™×¢×•×ª. ×§×¦×‘ ×”×‘×¨×§×™× ×’×“×œ ×‘××”×™×¨×•×ª.",
                type: "canvas_game",
                gameName: "zeus_dodge",
                target: 15 
            },
            {
                id: 2,
                name: "×”××“×¡: ××™×¡×•×£ × ×©××•×ª ×¢×œ ×¡×™×¨×ª ×¡×˜×™×§×¡",
                god: "×”××“×¡",
                icon: "ğŸ‘»ğŸ›¶",
                description: "×”××“×¡ ×¢×¨×š ×˜×•×¨× ×™×¨ ×¤×•×§×¨ ×œ×™×œ×™ ×•×”×¤×¡×™×“ ×‘×”×ª×¢×¨×‘×•×ª ××ª ×¡×“×¨ ××™×•×Ÿ ×”× ×©××•×ª. ×›×ª×•×¦××” ××›×š, ×’×™×‘×•×¨×™× ××’×“×™×™× (×©×¦×¨×™×›×™× ×œ×œ×›×ª ×œ×©×“×•×ª ××œ×™×¡×™×•×) × ×›× ×¡×™× ×‘×˜×¢×•×ª ×œ××¡×œ×•×œ ×©×œ ×”× ×©××•×ª ×”×¨×¢×•×ª (×”×’×•×œ×’×œ×•×ª ×”××“×•××•×ª). ×¢×œ×™×š ×œ×©×œ×•×˜ ×‘×¡×™×¨×” ×•×œ×”×—×–×™×¨ ××ª × ×©××•×ª ×”×’×™×‘×•×¨×™× (×¢×™×’×•×œ×™× ×™×¨×•×§×™×) ×œ××¡×œ×•×œ ×”× ×›×•×Ÿ, ×ª×•×š ×”×™×× ×¢×•×ª ××”×’×•×œ×’×œ×•×ª ×”×–×•×¢××•×ª! ×§×•×©×™ ×’×‘×•×”! ××¡×•×£ 8 × ×©××•×ª ×˜×•×‘×•×ª. ×”×¡×™×›×•×™ ×œ×”×™×ª×§×œ ×‘×’×•×œ×’×œ×•×ª ×¨×¢×•×ª ×”×•× 50/50. ×”××•×‘×™×™×§×˜×™× × ×¢×™× ××”×¨ ×™×•×ª×¨.",
                type: "canvas_game",
                gameName: "hades_collect",
                target: 8 
            },
            {
                id: 3,
                name: "××¨×˜××™×¡: ××ª×’×¨ ×™×¨×™ ×”×—×¦×™×",
                god: "××¨×˜××™×¡",
                icon: "ğŸ¹ğŸ¯",
                description: "××¨×˜××™×¡ ×¢×¨×›×” ×ª×—×¨×•×ª ×§×œ×™×¢×” ×›×•×©×œ×ª ×¢× ××¤×•×œ×• ×•×”×©×ª××©×” ×‘×™×”×œ×•××™ ×›×•×— ×›××˜×¨×•×ª × ×¢×•×ª. ×›××•×‘×Ÿ ×©×”× ×¤×¡×¤×¡×• ×”×›×œ ×•×”×™×”×œ×•××™× ×”×ª×¤×–×¨×• ×‘×©×“×” ××˜××•×¨×™× ××¡×•×›×Ÿ. ×¢×œ×™×š ×œ× ×•×¢ ×‘××”×™×¨×•×ª ×›×“×™ ×œ××¡×•×£ ××ª ×›×œ 12 ×”×™×”×œ×•××™× ×œ×¤× ×™ ×©×”× ×××‘×“×™× ××ª ×”×× ×¨×’×™×” ×©×œ×”×, ××• ×©××¤×•×œ×• ×™×›×¨×™×– ×¢×œ × ×™×¦×—×•×Ÿ ××˜×•×¤×©! ×§×•×©×™ ×’×‘×•×”! ××¡×•×£ 12 ×™×”×œ×•××™× × ×•×¦×¦×™× ×‘×ª×•×š 15 ×©× ×™×•×ª ×‘×œ×‘×“. ×”×“××•×ª ××¢×˜ ×§×˜× ×” ×™×•×ª×¨.",
                type: "canvas_game",
                gameName: "artemis_fetch",
                target: 12 
            },
             {
                id: 4,
                name: "×”×¨××¡: ×‘×¨×™×—×” ××¨×©×ª ×”×œ×™×™×–×¨",
                god: "×”×¨××¡",
                icon: "ğŸš€âš¡",
                description: "×”×¨××¡ ×’× ×‘ ××›×•× ×” ×œ×‘× ×™×™×ª ×©×‘×™×œ×™× ××™×™×“×™×™× ××”×¤×™×¡×˜×•×¡ ×•×”×¤×¢×™×œ ××•×ª×” ×‘×˜×¢×•×ª ×¢×œ ××¦×‘ '××‘×˜×—×” ×¢×•×™× ×ª'. ×”××›×•× ×” ××–×”×” ××•×ª×š ×›×¤×•×œ×© ×•××¤×¢×™×œ×” ×’×“×¨×•×ª ×œ×™×™×–×¨ ×× ×¨×’×˜×™×•×ª ×™×•×¨×“×•×ª! **×”×¨××¡ ×”×¤×¢×™×œ ×‘×š ×§××¢ ××”×™×¨×•×ª ×§×‘×•×¢, ×›×š ×©××ª×” ××”×™×¨ ×‘××™×•×—×“ ×œ××•×¨×š ×›×œ ×”××©×™××”! ×›×œ ×’×“×¨ ×œ×™×™×–×¨ ××›×™×œ×” ×©× ×™ ×¤×¢×¨×™× ×©×“×¨×›× × ×™×ª×Ÿ ×œ×¢×‘×•×¨.** ×¢×œ×™×š ×œ× ×•×•×˜ ×‘××”×™×¨×•×ª ×“×¨×š ×”×¤×¢×¨×™× ×”×¦×¤×•×¤×™× ×•×œ×”×ª×—××§ ×-15 ×’×“×¨×•×ª ×œ×™×™×–×¨ ×›×“×™ ×œ×”×©×‘×™×ª ××ª ×”××›×•× ×”. ××•×ª×¨×•×ª ×¨×§ 3 ×¤×’×™×¢×•×ª! ×§×¦×‘ ×”×’×“×¨×•×ª ×”×œ×™×™×–×¨ ×’×“×œ ×‘××”×™×¨×•×ª.",
                type: "canvas_game",
                gameName: "hermes_avoidance",
                target: 15 
            },
            {
                id: 5,
                name: "××¤×¨×•×“×™×˜×”: × ×™×§×•×™ ×”×‘×œ×’×Ÿ ×”×¨×•×× ×˜×™",
                god: "××¤×¨×•×“×™×˜×”",
                icon: "ğŸ’–ğŸŒ¹",
                description: "××¤×¨×•×“×™×˜×” × ×™×¡×ª×” ×œ×”×›×™×Ÿ ×©×™×§×•×™ ××”×‘×” ×¨×‘ ×¢×•×¦××”, ××‘×œ × ×¨×“××” ×•×”×—×•××¨×™× ×”×ª×¤×–×¨×• ×‘×¨×•×—. ×¢×œ×™×š ×œ× ×•×•×˜ ×‘××”×™×¨×•×ª ×•×œ××¡×•×£ 15 ××¨×›×™×‘×™×: 8 ×œ×‘×‘×•×ª ×•-7 ×¤×¨×—×™×. ××ª×” ×™×›×•×œ ×œ××¡×•×£ ×¨×§ ×¡×•×’ ××—×“ ×‘×›×œ ×¤×¢×, ×•×”×—×œ×¤×” ×‘×™×Ÿ ×¡×•×’×™ ×”××™×¡×•×£ (××§×© ×¨×•×•×—) ×œ×•×§×—×ª ×©× ×™×™×” ×™×§×¨×”! ×¡×™×™× ×‘-20 ×©× ×™×•×ª. ×§×•×©×™: ×’×‘×•×” ×××•×“.",
                type: "canvas_game",
                gameName: "aphrodite_clean",
                target: 15 
            },
            {
                id: 6,
                name: "×¤×•×¡×™×“×•×Ÿ: × ×—×©×•×œ×™ ×”××¦×•×ª ×”×–×•×¢××™×",
                god: "×¤×•×¡×™×“×•×Ÿ",
                icon: "ğŸŒŠğŸ”±",
                description: "×¤×•×¡×™×“×•×Ÿ ×¨×‘ ×¢× ×“×™×™×’ ×¢×œ ×˜×¢× ×›×¨×™×š ×˜×•× ×”, ×•×©×œ×— ×¦×•× ×××™ ×©×œ ××¦×•×ª ×©×¡×•×ª× ××ª ×›×œ × ×ª×™×‘×™ ×”×™×. ×¢×œ×™×š ×œ× ×•×•×˜ ×× ×›×™×ª (×œ××¢×œ×”/×œ××˜×”) ×‘××¢×‘×¨ ×™××™ ×¦×¨ ×›×“×™ ×œ×”×™×× ×¢ ×-20 ×’×•×©×™× ×©×œ ××¦×•×ª ×•×¡×œ×¢×™× ×©×‘××™× ×‘××”×™×¨×•×ª ×œ×¨×•×—×‘! ×–×”×™×¨×•×ª: ××ª×” ×–×– ×¨×§ ×œ××¢×œ×” ×•×œ××˜×”!",
                type: "canvas_game",
                gameName: "poseidon_dodge",
                target: 20 
            },
             {
                id: 7,
                name: "×“×™×•× ×™×¡×•×¡: ××¨×ª×•×Ÿ ×”×‘×¨×× ×™× ×”×§×•×¡××™",
                god: "×“×™×•× ×™×¡×•×¡",
                icon: "ğŸ·âš”ï¸",
                description: "×“×™×•× ×™×¡×•×¡ × ×˜×© ××ª ×”×™×™×Ÿ ×”××¡×•×¨×ª×™ ×•×”××¦×™× ×§×•×§×˜×™×™×œ '××•×—×™×˜×•-×™×•×•× ×™'. ×¢×œ×™×š ×œ×‘×©×œ 3 ×§×•×§×˜×™×™×œ×™× ×‘-25 ×©× ×™×•×ª! ××¡×•×£ ××ª ×©×œ×•×©×ª ×”××¨×›×™×‘×™× (ğŸ‡, â˜ï¸, âš¡) ×•×’×© ×œ××™×›×œ ×”×¢×¨×‘×•×‘ (×”××œ×‘×Ÿ ×”××¨×›×–×™). **×—×•×‘×” ×œ×¢××•×“ ×‘××™×›×œ ×œ××©×š 2 ×©× ×™×•×ª** ×›×“×™ ×œ×¡×™×™× ××ª ×”×¢×¨×‘×•×‘. **×–×”×™×¨×•×ª: ×”××œ ××¨×¡ ×›×•×¢×¡ ×¢×œ ×”×©×˜×•×ª ×•×ª×•×§×£ ××•×ª×š ×¢× ×—×¨×‘×•×ª!** ×¤×’×™×¢×” ××—×¨×‘ ×××¤×¡×ª ××ª ×”××œ××™ ×©×œ×š ×•××‘×˜×œ×ª ××ª ×”×¢×¨×‘×•×‘.",
                type: "canvas_game",
                gameName: "dionysus_cocktail",
                target: 3 
            }
        ];

        // --- ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×›×œ×œ×™×•×ª ---

        function renderScreen(htmlContent) {
            // ×‘×™×˜×•×œ ×œ×•×œ××ª ××©×—×§ ×§×•×“××ª ×œ×¤× ×™ ×¨×™× ×“×•×¨ ××¡×š ×—×“×©
            if (gameLoopId) {
                cancelAnimationFrame(gameLoopId);
                gameLoopId = null;
            }
            // ×”×¡×¨×ª ×××–×™× ×™× ×§×•×“××™× ×œ××§×©×™×
            document.removeEventListener('keydown', handleKeyDown);
            document.removeEventListener('keyup', handleKeyUp);
            
            app.innerHTML = htmlContent;
        }

        function createActionButton(text, onClick) {
            return `
                <button onclick="${onClick}"
                    class="action-btn mt-6 w-full md:w-auto shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-green-300">
                    ${text}
                </button>
            `;
        }

        // --- ×œ×•×’×™×§×ª ××©×—×§ ××¨×›×–×™×ª ---

        function renderIntro() {
            gameState.inProgress = false;
            const content = `
                <div class="space-y-6">
                    <h1 class="text-4xl font-bold text-gray-800">×‘×¨×•×›×™× ×”×‘××™× ×œ<span class="text-red-600">×”×‘×œ×’×Ÿ ×”××•×œ×™××¤×™</span></h1>
                    <p class="text-lg text-gray-600">
                        ××œ×™ ×”××•×œ×™××¤×•×¡ ×™×¦×¨×• ×©×™×‘×•×©×™×. ×¢×œ×™×š ×œ×©×œ×•×˜ ×‘×’×™×‘×•×¨ ×‘×××¦×¢×•×ª **××™× ×™-××©×—×§×™× ×“×™× ××™×™×** ×›×“×™ ×œ×ª×§×Ÿ ××ª ×”× ×–×§!
                    </p>
                    <div class="text-xl font-semibold text-blue-700">
                        ××˜×¨×ª×š: ×”×©×œ× ××ª ×›×œ ${quests.length} ×”×§×•×•×¡×˜×™× ×”×××ª×’×¨×™×!
                    </div>
                    ${createActionButton("×”×ª×—×œ ××¡×¢", "startQuest()")}
                </div>
            `;
            renderScreen(content);
        }

        function startQuest() {
            gameState.currentQuest = 1;
            gameState.score = 0;
            gameState.inProgress = true;
            renderQuest();
        }

        function renderCompletionScreen() {
            const content = `
                <div class="space-y-6">
                    <h1 class="text-5xl font-extrabold text-green-600">ğŸ‰ ×›×œ ×”×›×‘×•×“! ×”×§×•×•×¡×˜ ×”×•×©×œ×! ğŸ‰</h1>
                    <p class="text-2xl text-gray-700">
                        ×”×¦×œ×—×ª ×œ×ª×§×Ÿ ××ª ×›×œ ${quests.length} ×”×©×™×‘×•×©×™× ×”×§×•×¡××™×™×!
                    </p>
                    <div class="text-2xl text-red-600 font-bold">
                        × ×™×§×•×“ ×¡×•×¤×™: ${gameState.score}
                    </div>
                    ${createActionButton("×©×—×§ ×©×•×‘", "renderIntro()")}
                </div>
            `;
            renderScreen(content);
        }

        function handleQuestResult(isCorrect, message, points = 100) {
            // ×¢×¦×™×¨×ª ×œ×•×œ××ª ×”××©×—×§ ×”×¡×¤×¦×™×¤×™×ª
            if (gameLoopId) {
                cancelAnimationFrame(gameLoopId);
                gameLoopId = null;
            }
            document.removeEventListener('keydown', handleKeyDown);
            document.removeEventListener('keyup', handleKeyUp);
            
            let resultHtml;
            if (isCorrect) {
                gameState.score += points;
                resultHtml = `
                    <div class="p-4 bg-green-100 border-r-4 border-green-500 text-green-800 mt-6 rounded-lg">
                        <p class="font-bold">âœ¨ ×”×¦×œ×—×”!</p>
                        <p>${message}</p>
                    </div>
                    ${createActionButton("×”××©×š ×œ×§×•×•×¡×˜ ×”×‘×", "nextQuest()")}
                `;
            } else {
                resultHtml = `
                    <div class="p-4 bg-red-100 border-r-4 border-red-500 text-red-800 mt-6 rounded-lg">
                        <p class="font-bold">âŒ ×›×™×©×œ×•×Ÿ...</p>
                        <p>${message}</p>
                    </div>
                    ${createActionButton("× ×¡×” ×©×•×‘", "resetCurrentQuest()")}
                `;
            }
            // ×¢×“×›×•×Ÿ ××–×•×¨ ×”×ª×•×¦××”
            const questArea = app.querySelector('#quest-area');
            if (questArea) {
                questArea.innerHTML = resultHtml;
            } else {
                 app.querySelector('.game-container').innerHTML += resultHtml;
            }
        }

        function nextQuest() {
            gameState.currentQuest++;
            renderQuest();
        }

        function resetCurrentQuest() {
            renderQuest(); // ×¤×©×•×˜ ×¨×™× ×“×•×¨ ××—×“×© ×©×œ ×”×§×•×•×¡×˜ ×™××ª×—×œ ××ª ×”×›×œ
        }

        function renderQuest() {
            if (gameState.currentQuest > quests.length) {
                renderCompletionScreen();
                return;
            }

            const quest = quests[gameState.currentQuest - 1];
            let questHtml = '';

            // ×›×•×ª×¨×ª ×›×œ×œ×™×ª
            const header = `
                <div class="text-right mb-4 text-sm font-medium text-gray-500">
                    ×§×•×•×¡×˜ ${quest.id} ××ª×•×š ${quests.length}
                </div>
                <h2 class="quest-title flex items-center justify-center gap-3">
                    <span class="text-3xl">${quest.icon}</span> ${quest.name}
                </h2>
                <p class="quest-description text-gray-700">${quest.description}</p>
                <div class="h-0.5 bg-gray-200 w-full mb-6"></div>
            `;

            if (quest.type === 'canvas_game') {
                questHtml = renderCanvasGame(quest);
                renderScreen(header + questHtml);
                setupGame(quest.gameName); // ×¨×§ ××›×™×Ÿ ××ª ×”×§× ×‘×¡, ×œ× ××ª×—×™×œ ××ª ×”×œ×•×œ××”
            }
        }

        // --- ×œ×•×’×™×§×ª ××™× ×™-××©×—×§×™ ×§× ×‘×¡ ---

        function renderCanvasGame(quest) {
            return `
                <div class="flex flex-col items-center space-y-4">
                    <canvas id="gameCanvas" width="350" height="350" 
                        class="border-4 border-gray-900 bg-gray-100 rounded-lg shadow-inner w-full max-w-sm"></canvas>
                    <div id="game-info" class="text-lg font-bold text-red-600">×œ×—×¥ '×”×ª×—×œ ×§×•×•×¡×˜' ×›×“×™ ×œ×”×ª×—×™×œ!</div>
                    <div id="quest-area">
                        <button onclick="startGameLogic('${quest.gameName}')" id="start-game-btn"
                            class="action-btn w-64 h-14 text-xl bg-blue-700 hover:bg-blue-800 focus:ring-blue-300 transition duration-150 transform hover:scale-105">
                            ×”×ª×—×œ ×§×•×•×¡×˜
                        </button>
                        <p class="text-sm text-gray-500 mt-4">×”×©×ª××© ×‘××§×©×™ ×”×—×¦×™× (â† â†‘ â†’ â†“) ×›×“×™ ×œ×©×œ×•×˜ ×‘×“××•×ª. ×§×œ×™×§ ×¢×œ ×”××§×©×™× ×œ××˜×” ×¢×‘×•×¨ ××•×‘×™×™×œ. (××§×© ×¨×•×•×— ×œ×§×•×•×¡×˜ ×©×œ ××¤×¨×•×“×™×˜×”).</p>
                        <!-- ×›×¤×ª×•×¨×™ ×©×œ×™×˜×” ×œ××¡×›×™ ××’×¢ -->
                        <div class="touch-controls flex justify-center mt-4 space-x-4 md:hidden">
                            <button onmousedown="handleTouchMove(0)" ontouchstart="handleTouchMove(0)" ontouchend="handleTouchStop()">â†</button>
                            <div class="flex flex-col space-y-2">
                                <button onmousedown="handleTouchMove(1)" ontouchstart="handleTouchMove(1)" ontouchend="handleTouchStop()">â†‘</button>
                                <button onmousedown="handleTouchMove(3)" ontouchstart="handleTouchMove(3)" ontouchend="handleTouchStop()">â†“</button>
                            </div>
                            <button onmousedown="handleTouchMove(2)" ontouchstart="handleTouchMove(2)" ontouchend="handleTouchStop()">â†’</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ×¤×•× ×§×¦×™×•×ª ×©×œ×™×˜×” ×œ××¡×š ××’×¢
        function handleTouchMove(direction) {
            // 0: ×©×××œ, 1: ×œ××¢×œ×”, 2: ×™××™×Ÿ, 3: ×œ××˜×”
            keys = { ArrowLeft: false, ArrowUp: false, ArrowRight: false, ArrowDown: false };
            if (direction === 0) keys.ArrowLeft = true;
            if (direction === 1) keys.ArrowUp = true;
            if (direction === 2) keys.ArrowRight = true;
            if (direction === 3) keys.ArrowDown = true;
        }

        function handleTouchStop() {
            keys = {};
        }

        function setupGame(gameName) {
            canvas = document.getElementById('gameCanvas');
            // ×‘×“×™×§×” ×§×¨×™×˜×™×ª: ×”×× ×”×§× ×‘×¡ × ××¦×?
            if (!canvas) return; 
            
            ctx = canvas.getContext('2d');
            
            // ××™×¤×•×¡ ××¦×‘ ××§×©×™×
            keys = {};

            // ×”×¡×¨×ª ×•×”×•×¡×¤×ª ×××–×™× ×™×
            document.removeEventListener('keydown', handleKeyDown);
            document.removeEventListener('keyup', handleKeyUp);
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);
            
            // ××ª×—×•×œ ×”××©×—×§ ×”×¡×¤×¦×™×¤×™
            switch (gameName) {
                case 'zeus_dodge':
                    initZeusDodge();
                    break;
                case 'hades_collect':
                    initHadesCollect();
                    break;
                case 'artemis_fetch':
                    initArtemisFetch();
                    break;
                case 'hermes_avoidance': // ×§×•×•×¡×˜ 4 ×”×—×“×©
                    initHermesAvoidance();
                    break;
                case 'aphrodite_clean':
                    initAphroditeClean();
                    break;
                case 'poseidon_dodge':
                    initPoseidonDodge();
                    break;
                case 'dionysus_cocktail':
                    initDionysusCocktail();
                    break;
            }
            
            // ×¦×™×•×¨ ×¨××©×•× ×™ ×©×œ ×”××¡×š ×œ×¤× ×™ ×”×”×ª×—×œ×”, ×¨×§ ×× ×¤×•× ×§×¦×™×™×ª ×¦×™×•×¨ ×§×™×™××ª
            if (canvasState.draw) canvasState.draw();
        }

        function startGameLogic(gameName) {
            // ××›× ×™×¡ ××ª ×”×œ×•×’×™×§×” ×©×œ ×”×ª×—×œ×ª ×”××©×—×§ (×©×œ×™×˜×” ×‘×›×¤×ª×•×¨)
            const btn = document.getElementById('start-game-btn');
            const info = document.getElementById('game-info');
            
            if (btn) btn.style.display = 'none';
            if (info) info.textContent = '×”××©×—×§ ×‘×¢×™×¦×•××•!';

            // ×”×’×“×¨×ª isRunning ×œ-true ×•×”×ª×—×œ×ª ×”×œ×•×œ××”
            canvasState.isRunning = true;
            if (gameLoopId) cancelAnimationFrame(gameLoopId);
            gameLoopId = requestAnimationFrame(gameLoop);
        }

        function handleKeyDown(e) {
            // ×× ×™×¢×ª ×’×œ×™×œ×ª ×”×¢××•×“ ×‘×¢×ª ×©×™××•×© ×‘×—×¦×™×
            if (['Space', 'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                e.preventDefault();
            }
            keys[e.key] = true;
        }

        function handleKeyUp(e) {
            keys[e.key] = false;
        }

        // --- ×œ×•×œ××ª ×”××©×—×§ ×”×¨××©×™×ª ---
        function gameLoop() {
            if (canvasState.isRunning) {
                // ×¢×“×›×•×Ÿ ×•×œ×•×’×™×§×ª ××©×—×§
                canvasState.update(performance.now()); // ××¢×‘×™×¨ timestamp
                // ×¦×™×•×¨
                canvasState.draw();
                // ×”××©×š ×”×œ×•×œ××”
                gameLoopId = requestAnimationFrame(gameLoop);
            } else {
                // ×”××©×—×§ ×”×¡×ª×™×™× (× ×¦×—×•×Ÿ ××• ×”×¤×¡×“)
                cancelAnimationFrame(gameLoopId);
                gameLoopId = null;
            }
        }

        // --- ×¢×–×¨: ×‘×“×™×§×ª ×”×ª× ×’×©×•×ª ×¨×™×‘×•×¢-×¨×™×‘×•×¢ ---
        function checkCollision(r1, r2) {
            // ×‘×“×™×§×ª ×”×ª× ×’×©×•×ª ××œ×‘× ×™× ×¡×˜× ×“×¨×˜×™×ª
            return r1.x < r2.x + r2.w &&
                   r1.x + r1.w > r2.x &&
                   r1.y < r2.y + r2.h &&
                   r1.y + r1.h > r2.y;
        }

        // --- ×¦×™×•×¨ ×“××•×ª (××©×•×ª×£ ×œ×–××•×¡, ××¨×˜××™×¡, ××¤×¨×•×“×™×˜×”, ×¤×•×¡×™×“×•×Ÿ, ×”×¨××¡, ×“×™×•× ×™×¡×•×¡) ---
        function drawPlayerFigure(player, isBoosted = false) {
            if (!ctx) return; // ×”×’× ×”
            const centerX = player.x + player.w / 2;
            
            // ×§×‘×™×¢×ª ×¦×‘×¢ ×”×“××•×ª ×‘×”×ª×× ×œ××¦×‘ ×”×—×™×–×•×§
            let bodyColor = isBoosted ? '#FFFFFF' : player.color;
            let headColor = isBoosted ? '#FFEA00' : '#FFD700';
            
            // 1. ×’×•×£ (××œ×‘×Ÿ ×©××™×™×¦×’ ×˜×•× ×™×§×”/×©×¨×™×•×Ÿ)
            ctx.fillStyle = bodyColor; 
            ctx.fillRect(player.x + 5, player.y + 10, player.w - 10, player.h - 15);

            // 2. ×¨××© (×§×¡×“×” ××•×–×”×‘×ª)
            ctx.beginPath();
            ctx.arc(centerX, player.y + 7, 7, 0, Math.PI * 2);
            ctx.fillStyle = headColor;
            
            // ××¤×§×˜ ×–×•×”×¨ ×›×©×”×•× ××—×•×–×§ (×œ×¦×•×¨×š Hermes)
            ctx.shadowColor = isBoosted ? '#FFFFFF' : '#FFD700';
            ctx.shadowBlur = isBoosted ? 15 : 8;
            
            ctx.fill();
            ctx.closePath();
            ctx.shadowBlur = 0; // ××™×¤×•×¡ ×¦×œ

            // 3. ×¨×’×œ×™×™× (×§×•×•×™× ×¤×©×•×˜×™×)
            ctx.strokeStyle = '#333333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(centerX - 5, player.y + player.h - 5);
            ctx.lineTo(centerX - 5, player.y + player.h);
            ctx.moveTo(centerX + 5, player.y + player.h - 5);
            ctx.lineTo(centerX + 5, player.y + player.h);
            ctx.stroke();
        }

        // --- ×§×•×•×¡×˜ 1: ×–××•×¡ - ××¨×•×¥ ×”×‘×¨×§×™× ---
        function initZeusDodge() {
            const quest = quests[0];
            canvasState = {
                isRunning: false,
                player: { x: canvas.width / 2 - 15, y: canvas.height - 40, w: 30, h: 30, color: '#007bff', speed: 4 }, 
                lightning: [],
                strikesDodged: 0,
                hits: 0,
                maxHits: 2, 
                lastSpawn: 0,
                spawnRate: 500, 
                update: updateZeusDodge,
                draw: drawZeusDodge,
            };
        }

        function updateZeusDodge(timestamp) {
            const quest = quests[gameState.currentQuest - 1];
            const player = canvasState.player;

            // ×ª× ×•×¢×ª ×©×—×§×Ÿ
            if (keys['ArrowLeft'] && player.x > 0) player.x -= player.speed;
            if (keys['ArrowRight'] && player.x < canvas.width - player.w) player.x += player.speed;
            if (keys['ArrowUp'] && player.y > 0) player.y -= player.speed;
            if (keys['ArrowDown'] && player.y < canvas.height - player.h) player.y += player.speed;

            // ×™×¦×™×¨×ª ×‘×¨×§×™×
            if (timestamp - canvasState.lastSpawn > canvasState.spawnRate) {
                canvasState.lightning.push({
                    x: Math.random() * (canvas.width - 20) + 10, 
                    y: -10,
                    w: 8, 
                    h: 35,
                    speed: 4 + Math.random() * 2.5, 
                    color: '#FFEA00' 
                });
                canvasState.lastSpawn = timestamp;
                canvasState.spawnRate = Math.max(150, canvasState.spawnRate - 15); 
            }

            // ×¢×“×›×•×Ÿ ××™×§×•× ×‘×¨×§×™× ×•×‘×“×™×§×ª ×”×ª× ×’×©×•×ª
            for (let i = canvasState.lightning.length - 1; i >= 0; i--) {
                const bolt = canvasState.lightning[i];
                bolt.y += bolt.speed;

                if (checkCollision(player, bolt)) {
                    // ×¤×’×™×¢×”
                    canvasState.hits++;
                    canvasState.lightning.splice(i, 1);
                    if (canvasState.hits >= canvasState.maxHits) {
                        canvasState.isRunning = false;
                        handleQuestResult(false, `×—×˜×¤×ª ${canvasState.hits} ×¤×’×™×¢×•×ª! ×–××•×¡ ×××œ××œ ××©×”×• ×¢×œ '××©×—×§ ×”×•×’×Ÿ'. × ×¡×” ×©×•×‘.`);
                        return;
                    }
                } else if (bolt.y > canvas.height) {
                    // ×‘×¨×§ ×™×¦× ××”××¡×š
                    canvasState.strikesDodged++;
                    canvasState.lightning.splice(i, 1);
                    if (canvasState.strikesDodged >= quest.target) {
                        canvasState.isRunning = false;
                        handleQuestResult(true, `×”×ª×—××§×ª ×-15 ×‘×¨×§×™×! ×–××•×¡ ×—×–×¨ ×œ×©×œ×•×˜ ×‘××–×’ ×”××•×•×™×¨. × ×™×§×•×“: 200`, 200);
                    }
                }
            }
        }

        function drawZeusDodge() {
            if (!ctx) return;
            const quest = quests[gameState.currentQuest - 1];
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // ×¦×™×•×¨ ×‘×¨×§×™×
            canvasState.lightning.forEach(bolt => {
                ctx.fillStyle = bolt.color;
                ctx.fillRect(bolt.x, bolt.y, bolt.w, bolt.h);
            });

            // ×¦×™×•×¨ ×©×—×§×Ÿ (×“××•×ª)
            drawPlayerFigure(canvasState.player);

            // ×¢×“×›×•×Ÿ ××™×“×¢
            const info = document.getElementById('game-info');
            if (canvasState.isRunning && info) {
                info.innerHTML = `×”×ª×—××§×•×ª: ${canvasState.strikesDodged} / ${quest.target} | ×¤×’×™×¢×•×ª: <span style="color: red">${canvasState.hits}</span> / ${canvasState.maxHits}`;
            }
        }

        // --- ×§×•×•×¡×˜ 2: ×”××“×¡ - ××™×¡×•×£ × ×©××•×ª ---
        function initHadesCollect() {
            const quest = quests[1];
            canvasState = {
                isRunning: false,
                player: { x: canvas.width / 2 - 17.5, y: canvas.height - 40, w: 35, h: 18, color: '#3b82f6', speed: 4.5 }, 
                collectibles: [], 
                obstacles: [], 
                soulsCollected: 0,
                badSoulsHit: 0,
                maxBadSouls: 3,
                lastSpawn: 0,
                spawnRate: 650, 
                update: updateHadesCollect,
                draw: drawHadesCollect,
            };
        }

        function updateHadesCollect(timestamp) {
            const quest = quests[gameState.currentQuest - 1];
            const player = canvasState.player;

            // ×ª× ×•×¢×ª ×©×—×§×Ÿ
            if (keys['ArrowLeft'] && player.x > 0) player.x -= player.speed;
            if (keys['ArrowRight'] && player.x < canvas.width - player.w) player.x += player.speed;

            // ×™×¦×™×¨×ª ××•×‘×™×™×§×˜×™×
            if (timestamp - canvasState.lastSpawn > canvasState.spawnRate) {
                const x = Math.random() * (canvas.width - 20);
                const isCollectible = Math.random() > 0.5; 
                const item = { x, y: -20, r: 10, speed: 2.5 + Math.random() * 2 }; 

                if (isCollectible) {
                    canvasState.collectibles.push({ ...item, w: item.r*2, h: item.r*2, color: '#10b981' }); 
                } else {
                    canvasState.obstacles.push({ ...item, w: item.r*2, h: item.r*2, color: '#ef4444' }); 
                }

                canvasState.lastSpawn = timestamp;
            }

            // ×¢×“×›×•×Ÿ ×•××™×¡×•×£
            for (let i = canvasState.collectibles.length - 1; i >= 0; i--) {
                const item = canvasState.collectibles[i];
                item.y += item.speed;

                // ×‘×“×™×§×ª ××™×¡×•×£ 
                if (checkCollision(player, item)) {
                    canvasState.soulsCollected++;
                    canvasState.collectibles.splice(i, 1);
                    if (canvasState.soulsCollected >= quest.target) {
                        canvasState.isRunning = false;
                        handleQuestResult(true, `××¡×¤×ª 8 × ×©××•×ª ×˜×•×‘×•×ª! ×”××“×¡ ××©×‘×— ××ª ×¡×“×¨× ×•×ª×š. × ×™×§×•×“: 300`, 300);
                        return;
                    }
                } else if (item.y > canvas.height) {
                    canvasState.collectibles.splice(i, 1);
                }
            }

            // ×¢×“×›×•×Ÿ ×•×”×™×× ×¢×•×ª
            for (let i = canvasState.obstacles.length - 1; i >= 0; i--) {
                const item = canvasState.obstacles[i];
                item.y += item.speed;

                // ×‘×“×™×§×ª ×¤×’×™×¢×”
                 if (checkCollision(player, item)) {
                    canvasState.badSoulsHit++;
                    canvasState.obstacles.splice(i, 1);
                    if (canvasState.badSoulsHit >= canvasState.maxBadSouls) {
                        canvasState.isRunning = false;
                        handleQuestResult(false, `×¤×’×¢×ª ×‘-3 ×’×•×œ×’×œ×•×ª! ×¡×™×¨×ª ×¡×˜×™×§×¡ × ×©×‘×¨×”. × ×¡×” ×©×•×‘.`);
                        return;
                    }
                } else if (item.y > canvas.height) {
                    canvasState.obstacles.splice(i, 1);
                }
            }
        }

        function drawHadesCollect() {
            if (!ctx) return;
            const quest = quests[gameState.currentQuest - 1];
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // ×¦×™×•×¨ × ×©××•×ª ×˜×•×‘×•×ª (×¢×™×’×•×œ×™× ×™×¨×•×§×™×)
            canvasState.collectibles.forEach(item => {
                ctx.beginPath();
                ctx.arc(item.x, item.y, item.r, 0, Math.PI * 2);
                ctx.fillStyle = item.color;
                ctx.fill();
                ctx.closePath();
            });

            // ×¦×™×•×¨ ×’×•×œ×’×œ×•×ª ×¨×¢×•×ª (×¨×™×‘×•×¢×™× ××“×•××™×)
            canvasState.obstacles.forEach(item => {
                ctx.fillStyle = item.color;
                // ×¦×™×•×¨ ×›×¨×™×‘×•×¢ ×‘××§×•× ×¢×™×’×•×œ ×›×“×™ ×œ×™×™×¦×’ ×’×•×œ×’×•×œ×ª
                ctx.fillRect(item.x - item.r, item.y - item.r, item.r * 2, item.r * 2);
            });

            // ×¦×™×•×¨ ×©×—×§×Ÿ (×¡×™×¨×”) - ×¦×•×¨×” ××¢×•×¦×‘×ª
            const player = canvasState.player;
            ctx.fillStyle = '#78350f'; // ×—×•× ×›×”×” (×¡×™×¨×ª ×¢×¥)
            
            // ×’×•×£ ×”×¡×™×¨×” (×˜×¨×¤×– ×”×¤×•×š)
            ctx.beginPath();
            ctx.moveTo(player.x, player.y + player.h); // ×§×¦×” ×©×××œ×™ ×ª×—×ª×•×Ÿ
            ctx.lineTo(player.x + player.w, player.y + player.h); // ×§×¦×” ×™×× ×™ ×ª×—×ª×•×Ÿ
            ctx.lineTo(player.x + player.w - 5, player.y); // ×§×¦×” ×™×× ×™ ×¢×œ×™×•×Ÿ (×—×¨×˜×•×)
            ctx.lineTo(player.x + 5, player.y); // ×§×¦×” ×©×××œ×™ ×¢×œ×™×•×Ÿ (×—×¨×˜×•×)
            ctx.closePath();
            ctx.fill();

            // ×¤×¡ ×“×§×•×¨×˜×™×‘×™ ×›×—×•×œ (×”× ×”×¨)
            ctx.fillStyle = '#3b82f6';
            ctx.fillRect(player.x + 2, player.y + player.h - 5, player.w - 4, 3);
            
            // ×¢×“×›×•×Ÿ ××™×“×¢
            const info = document.getElementById('game-info');
            if (canvasState.isRunning && info) {
                info.innerHTML = `× ×©××•×ª: ${canvasState.soulsCollected} / ${quest.target} | ×’×•×œ×’×œ×•×ª: <span style="color: red">${canvasState.badSoulsHit}</span> / ${canvasState.maxBadSouls}`;
            }
        }

        // --- ×§×•×•×¡×˜ 3: ××¨×˜××™×¡ - ××ª×’×¨ ×™×¨×™ ×”×—×¦×™× (××™×¡×•×£ ×‘×–××Ÿ) ---
        function initArtemisFetch() {
            const quest = quests[2];
            canvasState = {
                isRunning: false, 
                player: { x: canvas.width / 2 - 12, y: canvas.height / 2 - 12, w: 24, h: 24, color: '#f59e0b', speed: 4.5 }, 
                gems: [],
                gemsCollected: 0,
                totalTime: 15, 
                timeRemaining: 15,
                lastTick: Date.now(),
                update: updateArtemisFetch,
                draw: drawArtemisFetch,
            };

            // ×™×¦×™×¨×ª 12 ×™×”×œ×•××™×
            for(let i = 0; i < quest.target; i++) {
                 canvasState.gems.push({
                    x: Math.random() * (canvas.width - 30) + 15, 
                    y: Math.random() * (canvas.height - 30) + 15, 
                    w: 15,
                    h: 15,
                    color: '#ffffff', 
                    r: 7.5
                });
            }
        }

        function updateArtemisFetch() {
            const quest = quests[gameState.currentQuest - 1];
            const player = canvasState.player;

            // ×¢×“×›×•×Ÿ ×˜×™×™××¨
            const now = Date.now();
            const elapsed = (now - canvasState.lastTick) / 1000;
            canvasState.lastTick = now;
            canvasState.timeRemaining = Math.max(0, canvasState.timeRemaining - elapsed);
            
            // ×ª× ×•×¢×ª ×©×—×§×Ÿ
            if (keys['ArrowLeft']) player.x -= player.speed;
            if (keys['ArrowRight']) player.x += player.speed;
            if (keys['ArrowUp']) player.y -= player.speed;
            if (keys['ArrowDown']) player.y += player.speed;

            // ×‘×“×™×§×ª ×’×‘×•×œ×•×ª (×”×¨×•×—×•×ª ×”××‘×œ×‘×œ×•×ª - ××—×–×™×¨ ××ª ×”×©×—×§×Ÿ)
            if (player.x < 0) player.x = 0;
            if (player.x > canvas.width - player.w) player.x = canvas.width - player.w;
            if (player.y < 0) player.y = 0;
            if (player.y > canvas.height - player.h) player.y = canvas.height - player.h;


            // ×‘×“×™×§×ª ××™×¡×•×£ ×™×”×œ×•××™×
            for (let i = canvasState.gems.length - 1; i >= 0; i--) {
                const gem = canvasState.gems[i];
                // ×‘×“×™×§×ª ×”×ª× ×’×©×•×ª (×”×™×”×œ×•××™× × ×‘×“×§×™× ×›×¨×™×‘×•×¢×™× ×œ×¦×•×¨×š collision)
                if (checkCollision(player, {x: gem.x - gem.r, y: gem.y - gem.r, w: gem.w, h: gem.h})) {
                    canvasState.gemsCollected++;
                    canvasState.gems.splice(i, 1);
                    if (canvasState.gemsCollected >= quest.target) {
                        canvasState.isRunning = false;
                        handleQuestResult(true, `××¡×¤×ª ××ª ×›×œ 12 ×”×™×”×œ×•××™× ×‘×–××Ÿ! ××¨×˜××™×¡ ××¨×•×¦×” ××”×“×™×•×§ ×©×œ×š. × ×™×§×•×“: 500`, 500);
                        return;
                    }
                }
            }

            // ×‘×“×™×§×ª ×–××Ÿ
            if (canvasState.timeRemaining <= 0) {
                canvasState.isRunning = false;
                handleQuestResult(false, `×”×–××Ÿ × ×’××¨! ×œ× ×”×¡×¤×§×ª ×œ××¡×•×£ ××ª ×›×œ ×”×™×”×œ×•××™×. × ×¡×” ×©×•×‘.`);
            }
        }

        function drawArtemisFetch() {
            if (!ctx) return;
            const quest = quests[gameState.currentQuest - 1];
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // ×¦×™×•×¨ ×™×”×œ×•××™× (××¢×•×™× ×™×)
            canvasState.gems.forEach(gem => {
                ctx.fillStyle = gem.color;
                ctx.shadowColor = '#000000';
                ctx.shadowBlur = 5;
                const r = gem.r;
                const x = gem.x;
                const y = gem.y;


                // ×¦×™×•×¨ ××¢×•×™×Ÿ
                ctx.beginPath();
                ctx.moveTo(x, y - r); // Top point
                ctx.lineTo(x + r, y); // Right point
                ctx.lineTo(x, y + r); // Bottom point
                ctx.lineTo(x - r, y); // Left point
                ctx.closePath();
                ctx.fill();
                
                ctx.shadowBlur = 0; // ××™×¤×•×¡ ×¦×œ
            });

            // ×¦×™×•×¨ ×©×—×§×Ÿ (×“××•×ª)
            drawPlayerFigure(canvasState.player);

            // ×¢×“×›×•×Ÿ ××™×“×¢
            const info = document.getElementById('game-info');
            if (canvasState.isRunning && info) {
                const timeColor = canvasState.timeRemaining < 5 ? 'red' : 'green';
                info.innerHTML = `×™×”×œ×•××™×: ${canvasState.gemsCollected} / ${quest.target} | ×–××Ÿ: <span style="color: ${timeColor}">${canvasState.timeRemaining.toFixed(1)}</span> ×©× ×™×•×ª`;
            }
        }

        // --- ×§×•×•×¡×˜ 4: ×”×¨××¡ - ×‘×¨×™×—×” ××¨×©×ª ×”×œ×™×™×–×¨ (Laser Grid Avoidance) ---
        function initHermesAvoidance() {
            const permanentFastSpeed = 9; // ×”××”×™×¨×•×ª ×”××”×™×¨×” ×”×§×‘×•×¢×”
            canvasState = {
                isRunning: false,
                // ×”×“××•×ª ××ª×—×™×œ×” ×‘××”×™×¨×•×ª ×”×’×‘×•×”×” (9)
                player: { x: canvas.width / 2 - 15, y: canvas.height - 40, w: 30, h: 30, color: '#f59e0b', speed: permanentFastSpeed }, 
                walls: [], // ×”×§×™×¨×•×ª ×”××›×™×œ×™× ×¤×¢×¨×™× (Laser Gates)
                wallsDodged: 0,
                hits: 0,
                maxHits: 3, 
                lastSpawn: 0,
                spawnRate: 1000, 
                update: updateHermesAvoidance,
                draw: drawHermesAvoidance,
            };
        }

        function updateHermesAvoidance(timestamp) {
            const quest = quests[gameState.currentQuest - 1];
            const player = canvasState.player;

            // ×ª× ×•×¢×ª ×©×—×§×Ÿ (×”××”×™×¨×•×ª ×”×™× ×§×‘×•×¢×” 9)
            if (keys['ArrowLeft'] && player.x > 0) player.x -= player.speed;
            if (keys['ArrowRight'] && player.x < canvas.width - player.w) player.x += player.speed;
            if (keys['ArrowUp'] && player.y > 0) player.y -= player.speed;
            if (keys['ArrowDown'] && player.y < canvas.height - player.h) player.y += player.speed;

            // ×™×¦×™×¨×ª ×§×™×¨×•×ª (×¢× ×©× ×™ ×¤×¢×¨×™×)
            if (timestamp - canvasState.lastSpawn > canvasState.spawnRate) {
                const gapWidth = 60 + Math.random() * 20; // **×©×™× ×•×™: ×¨×•×—×‘ ×”×¤×¢×¨ (60-80)**
                const minGapDistance = 50; // ××¨×—×§ ××™× ×™××œ×™ ×‘×™×Ÿ ×”×¤×¢×¨×™×
                const wallHeight = 15;
                
                // ×—×™×©×•×‘ ××™×§×•× ×©× ×™ ×”×¤×¢×¨×™× (gap1Start < gap2Start)
                const totalSpaceNeeded = 2 * gapWidth + minGapDistance;
                const availableStartSpace = canvas.width - totalSpaceNeeded;

                // ××™×§×•× ×”×ª×—×œ×” ×©×œ ×”×¤×¢×¨ ×”×¨××©×•×Ÿ
                let gap1Start = Math.random() * (availableStartSpace);

                // ××™×§×•× ×”×ª×—×œ×” ×©×œ ×”×¤×¢×¨ ×”×©× ×™
                let gap2Start = gap1Start + gapWidth + minGapDistance + Math.random() * (canvas.width - (gap1Start + gapWidth + minGapDistance) - gapWidth);
                
                // ×•×“× ×©-gap2Start ×œ× ×—×•×¨×’ ××”×§×¦×”
                gap2Start = Math.min(gap2Start, canvas.width - gapWidth - 5);


                canvasState.walls.push({
                    y: -wallHeight,
                    gap1Start: gap1Start,
                    gap1End: gap1Start + gapWidth,
                    gap2Start: gap2Start,
                    gap2End: gap2Start + gapWidth,
                    h: wallHeight,
                    speed: 4.5 + Math.random() * 2.5,
                    color: '#ef4444', // ××“×•× ×œ×™×™×–×¨
                    passed: false, // ×”×× ×”×©×—×§×Ÿ ×¢×‘×¨ ××ª×—×ª×™×• (×—×©×•×‘ ×œ×¡×¤×™×¨×”)
                });
                canvasState.lastSpawn = timestamp;
                canvasState.spawnRate = Math.max(700, canvasState.spawnRate - 30); // ×§×¦×‘ ×¢×•×œ×”
            }

            // ×¢×“×›×•×Ÿ ××™×§×•× ×§×™×¨×•×ª ×•×‘×“×™×§×ª ×”×ª× ×’×©×•×ª
            for (let i = canvasState.walls.length - 1; i >= 0; i--) {
                const wall = canvasState.walls[i];
                wall.y += wall.speed;

                // ×‘×“×™×§×ª ×”×ª× ×’×©×•×ª (×©×—×§×Ÿ × ×ª×§×¢ ×‘×§×™×¨)
                // ×‘×•×“×§×™× ×× ×™×© ×—×¤×™×¤×” ×× ×›×™×ª ×‘×™×Ÿ ×”×©×—×§×Ÿ ×œ×§×™×¨
                if (player.y + player.h > wall.y && player.y < wall.y + wall.h) {
                    
                    let collision = false;
                    
                    // 1. Segment 1 (Left): 0 to gap1Start
                    if (player.x < wall.gap1Start && player.x + player.w > 0) {
                        collision = true;
                    }
                    // 2. Segment 2 (Middle): gap1End to gap2Start
                    if (player.x < wall.gap2Start && player.x + player.w > wall.gap1End) {
                        collision = true;
                    }
                    // 3. Segment 3 (Right): gap2End to canvas.width
                    if (player.x + player.w > wall.gap2End && player.x < canvas.width) {
                        collision = true;
                    }
                    
                    if (collision) {
                        // ×™×© ×”×ª× ×’×©×•×ª: ×—×•×˜×¤×™× ×¤×’×™×¢×”
                        canvasState.hits++;
                        canvasState.walls.splice(i, 1); 
                        
                        if (canvasState.hits >= canvasState.maxHits) {
                            canvasState.isRunning = false;
                            handleQuestResult(false, `× ×ª×§×¢×ª ×™×•×ª×¨ ××“×™! ×”××›×•× ×” ×©×œ ×”×¨××¡ ×”×©×ª×’×¢×”. × ×¡×” ×©×•×‘.`);
                            return;
                        }
                        continue;
                    }
                }

                // ×‘×“×™×§×ª ×™×¦×™××” ××”××¡×š (×•×”×¦×œ×—×”)
                if (wall.y > canvas.height) {
                    canvasState.wallsDodged++;
                    canvasState.walls.splice(i, 1);

                    if (canvasState.wallsDodged >= quest.target) {
                        canvasState.isRunning = false;
                        handleQuestResult(true, `×”×ª×—××§×ª ×-15 ×’×“×¨×•×ª ×œ×™×™×–×¨! ×”×¨××¡ ×§×™×‘×œ ××ª ×”××›×•× ×” ×©×œ×• ×‘×—×–×¨×”. × ×™×§×•×“: 400`, 400);
                        return;
                    }
                }
            }
        }

        function drawHermesAvoidance() {
            if (!ctx) return;
            const quest = quests[gameState.currentQuest - 1];
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // ×¦×™×•×¨ ×§×™×¨×•×ª ×œ×™×™×–×¨ (Laser Gates)
            canvasState.walls.forEach(wall => {
                ctx.fillStyle = wall.color;
                ctx.shadowColor = wall.color;
                ctx.shadowBlur = 10;
                
                // ×§×™×¨ ×©×××œ×™ (Segment 1: 0 to gap1Start)
                ctx.fillRect(0, wall.y, wall.gap1Start, wall.h);
                
                // ×§×™×¨ ×××¦×¢×™ (Segment 2: gap1End to gap2Start)
                ctx.fillRect(wall.gap1End, wall.y, wall.gap2Start - wall.gap1End, wall.h);

                // ×§×™×¨ ×™×× ×™ (Segment 3: gap2End to canvas.width)
                ctx.fillRect(wall.gap2End, wall.y, canvas.width - wall.gap2End, wall.h);
                
                ctx.shadowBlur = 0;
            });

            // ×¦×™×•×¨ ×©×—×§×Ÿ (×“××•×ª)
            drawPlayerFigure(canvasState.player);

            // ×¢×“×›×•×Ÿ ××™×“×¢
            const info = document.getElementById('game-info');
            if (canvasState.isRunning && info) {
                info.innerHTML = `×”×ª×—××§×•×ª: ${canvasState.wallsDodged} / ${quest.target} | ×¤×’×™×¢×•×ª: <span style="color: red">${canvasState.hits}</span> / ${canvasState.maxHits}`;
            }
        }


        // --- ×§×•×•×¡×˜ 5: ××¤×¨×•×“×™×˜×” - × ×™×§×•×™ ×”×‘×œ×’×Ÿ ×”×¨×•×× ×˜×™ ---

        const ITEM_TYPE = { HEART: 'heart', FLOWER: 'flower' };
        
        function initAphroditeClean() {
            const quest = quests[4];
            canvasState = {
                isRunning: false, 
                player: { x: canvas.width / 2 - 15, y: canvas.height / 2 - 15, w: 30, h: 30, color: '#ec4899', speed: 4 }, 
                items: [],
                collectedCount: { heart: 0, flower: 0 },
                totalCollected: 0,
                collectingType: ITEM_TYPE.HEART, // ××ª×—×™×œ ×¢× ×œ×‘×‘×•×ª
                lastTypeSwitch: 0,
                typeSwitchCooldown: 1000, // ×§×•×©×™: 1 ×©× ×™×™×” ×§×™×¨×•×¨
                totalTime: 20, 
                timeRemaining: 20,
                lastTick: Date.now(),
                update: updateAphroditeClean,
                draw: drawAphroditeClean,
            };

            // ×™×¦×™×¨×ª 8 ×œ×‘×‘×•×ª ×•-7 ×¤×¨×—×™× (×¡×”"×› 15)
            const targets = { heart: 8, flower: 7 };
            for(let type in targets) {
                for(let i = 0; i < targets[type]; i++) {
                    canvasState.items.push({
                        x: Math.random() * (canvas.width - 30) + 15, 
                        y: Math.random() * (canvas.height - 30) + 15, 
                        w: 15,
                        h: 15,
                        type: type,
                        r: 7.5
                    });
                }
            }
        }

        function updateAphroditeClean() {
            const quest = quests[gameState.currentQuest - 1];
            const player = canvasState.player;
            const now = Date.now();

            // ×¢×“×›×•×Ÿ ×˜×™×™××¨
            const elapsed = (now - canvasState.lastTick) / 1000;
            canvasState.lastTick = now;
            canvasState.timeRemaining = Math.max(0, canvasState.timeRemaining - elapsed);
            
            // ×ª× ×•×¢×ª ×©×—×§×Ÿ
            if (keys['ArrowLeft']) player.x -= player.speed;
            if (keys['ArrowRight']) player.x += player.speed;
            if (keys['ArrowUp']) player.y -= player.speed;
            if (keys['ArrowDown']) player.y += player.speed;

            // ×‘×“×™×§×ª ×’×‘×•×œ×•×ª
            if (player.x < 0) player.x = 0;
            if (player.x > canvas.width - player.w) player.x = canvas.width - player.w;
            if (player.y < 0) player.y = 0;
            if (player.y > canvas.height - player.h) player.y = canvas.height - player.h;

            // ×”×—×œ×¤×ª ×¡×•×’ ××™×¡×•×£ (×¨×•×•×— - Space)
            const isOnCooldown = now - canvasState.lastTypeSwitch < canvasState.typeSwitchCooldown;
            if (keys[' '] && !isOnCooldown) {
                canvasState.collectingType = canvasState.collectingType === ITEM_TYPE.HEART ? ITEM_TYPE.FLOWER : ITEM_TYPE.HEART;
                canvasState.lastTypeSwitch = now;
                keys[' '] = false; // ×œ×× ×•×¢ ×”×—×œ×¤×” ××™×™×“×™×ª × ×•×¡×¤×ª
            }

            // ×‘×“×™×§×ª ××™×¡×•×£
            for (let i = canvasState.items.length - 1; i >= 0; i--) {
                const item = canvasState.items[i];
                if (checkCollision(player, {x: item.x - item.r, y: item.y - item.r, w: item.w, h: item.h})) {
                    if (item.type === canvasState.collectingType) {
                        // ××™×¡×•×£ ××•×¦×œ×—
                        canvasState.collectedCount[item.type]++;
                        canvasState.totalCollected++;
                        canvasState.items.splice(i, 1);
                        if (canvasState.totalCollected >= quest.target) {
                            canvasState.isRunning = false;
                            handleQuestResult(true, `××¡×¤×ª ××ª ×›×œ ${quest.target} ×”××¨×›×™×‘×™× ×‘×–××Ÿ! ××¤×¨×•×“×™×˜×” ×™×›×•×œ×” ×œ×”×©×œ×™× ××ª ×©×™×§×•×™ ×”××”×‘×”. × ×™×§×•×“: 600`, 600);
                            return;
                        }
                    } else {
                        // ×¤×’×™×¢×” ×‘×¤×¨×™×˜ ×”×œ× × ×›×•×Ÿ
                        // ××•×œ×™ ×§× ×¡ ×§×˜×Ÿ? ×›×¨×’×¢ ××™×Ÿ ×§× ×¡ ××¢×‘×¨ ×œ××™×‘×•×“ ×–××Ÿ
                    }
                }
            }

            // ×‘×“×™×§×ª ×–××Ÿ
            if (canvasState.timeRemaining <= 0) {
                canvasState.isRunning = false;
                handleQuestResult(false, `×”×–××Ÿ × ×’××¨! ×œ× ××¡×¤×ª ××ª ×›×œ ${quest.target} ×”××¨×›×™×‘×™×. × ×¡×” ×©×•×‘.`);
            }
        }

        function drawAphroditeClean() {
            if (!ctx) return;
            const quest = quests[gameState.currentQuest - 1];
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const now = Date.now();

            // ×¦×™×•×¨ ×¤×¨×™×˜×™×
            canvasState.items.forEach(item => {
                ctx.shadowBlur = 5;
                if (item.type === ITEM_TYPE.HEART) {
                    // ×¦×™×•×¨ ×œ×‘ (Heart - ×¤×•× ×§×¦×™×™×ª ×¦×™×•×¨ ×¤×©×•×˜×”)
                    ctx.fillStyle = '#f87171';
                    ctx.shadowColor = '#f87171';
                    const h_x = item.x;
                    const h_y = item.y;
                    const r = item.r;
                    
                    ctx.beginPath();
                    // ×©×™××•×© ×‘×¦×•×¨×” ×’×™××•××˜×¨×™×ª ×¤×©×•×˜×” ×™×•×ª×¨ ×œ×‘×˜×™×—×•×ª
                    ctx.moveTo(h_x, h_y + r); 
                    ctx.lineTo(h_x + r, h_y - r);
                    ctx.lineTo(h_x + r / 2, h_y - r * 2);
                    ctx.lineTo(h_x, h_y - r * 1.5);
                    ctx.lineTo(h_x - r / 2, h_y - r * 2);
                    ctx.lineTo(h_x - r, h_y - r);
                    ctx.closePath();
                    ctx.fill();

                } else {
                    // ×¦×™×•×¨ ×¤×¨×— (Flower - ×¢×™×’×•×œ + ×¢×œ×™ ×›×•×ª×¨×ª ×¤×©×•×˜×™×)
                    ctx.fillStyle = '#818cf8';
                    ctx.shadowColor = '#818cf8';
                    ctx.beginPath();
                    ctx.arc(item.x, item.y, item.r, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.closePath();
                }
                ctx.shadowBlur = 0;
            });

            // ×¦×™×•×¨ ×©×—×§×Ÿ (×“××•×ª)
            drawPlayerFigure(canvasState.player);

            // ×”×“×’×©×ª ××¦×‘ ××™×¡×•×£ × ×•×›×—×™
            const statusColor = canvasState.collectingType === ITEM_TYPE.HEART ? '#f87171' : '#818cf8';
            ctx.fillStyle = statusColor;
            ctx.globalAlpha = 0.2;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.globalAlpha = 1.0;

            const isOnCooldown = now - canvasState.lastTypeSwitch < canvasState.typeSwitchCooldown;
            const cooldownText = isOnCooldown ? ` (×××ª×™×Ÿ ${((canvasState.typeSwitchCooldown - (now - canvasState.lastTypeSwitch) + 100) / 1000).toFixed(1)} ×©× ')` : '';

            // ×¢×“×›×•×Ÿ ××™×“×¢
            const info = document.getElementById('game-info');
            if (canvasState.isRunning && info) {
                const timeColor = canvasState.timeRemaining < 5 ? 'red' : 'green';
                info.innerHTML = `××¡×•×£: <span style="color: ${statusColor}; font-weight: bold">${canvasState.collectingType === ITEM_TYPE.HEART ? '×œ×‘×‘×•×ª' : '×¤×¨×—×™×'}</span>${cooldownText} | ×¡×”"×›: ${canvasState.totalCollected} / ${quest.target} | ×–××Ÿ: <span style="color: ${timeColor}">${canvasState.timeRemaining.toFixed(1)}</span>`;
            }
        }

        // --- ×§×•×•×¡×˜ 6: ×¤×•×¡×™×“×•×Ÿ - × ×—×©×•×œ×™ ×”××¦×•×ª ×”×–×•×¢××™× ---
        function initPoseidonDodge() {
            const quest = quests[5];
            canvasState = {
                isRunning: false, 
                player: { x: 30, y: canvas.height / 2 - 15, w: 30, h: 30, color: '#10b981', speed: 4.5 }, // ×”×“××•×ª × ××¦××ª ×‘×¦×“ ×©×××œ
                obstacles: [], // ×’×•×©×™ ××¦×•×ª ×•×¡×œ×¢×™×
                dodgedCount: 0,
                hits: 0,
                maxHits: 2, 
                lastSpawn: 0,
                spawnRate: 400, // ×§×•×©×™: ×§×¦×‘ ×’×‘×•×”
                update: updatePoseidonDodge,
                draw: drawPoseidonDodge,
            };
        }

        function updatePoseidonDodge(timestamp) {
            const quest = quests[gameState.currentQuest - 1];
            const player = canvasState.player;

            // ×ª× ×•×¢×ª ×©×—×§×Ÿ - ×¨×§ ×œ××¢×œ×” ×•×œ××˜×”
            if (keys['ArrowUp'] && player.y > 0) player.y -= player.speed;
            if (keys['ArrowDown'] && player.y < canvas.height - player.h) player.y += player.speed;

            // ×™×¦×™×¨×ª ××•×‘×™×™×§×˜×™×
            if (timestamp - canvasState.lastSpawn > canvasState.spawnRate) {
                const y = Math.random() * (canvas.height - 20) + 10;
                const h = 15 + Math.random() * 25; // ×’×•×‘×” ××©×ª× ×”
                const w = 15 + Math.random() * 20; // ×¨×•×—×‘ ××©×ª× ×”
                
                canvasState.obstacles.push({
                    x: canvas.width, 
                    y: y - h / 2,
                    w: w, 
                    h: h,
                    speed: 4 + Math.random() * 3, // ×§×•×©×™: ××”×™×¨×•×ª ×’×‘×•×”×”
                    color: Math.random() < 0.3 ? '#4b5563' : '#059669' // ××¦×•×ª ××• ×¡×œ×¢ ××¤×•×¨
                });
                canvasState.lastSpawn = timestamp;
                canvasState.spawnRate = Math.max(100, canvasState.spawnRate - 5); // ×§×•×©×™: ×§×¦×‘ ×”×•×¤×¢×” ×’×“×œ
            }

            // ×¢×“×›×•×Ÿ ××™×§×•× ××›×©×•×œ×™× ×•×‘×“×™×§×ª ×”×ª× ×’×©×•×ª
            for (let i = canvasState.obstacles.length - 1; i >= 0; i--) {
                const obstacle = canvasState.obstacles[i];
                obstacle.x -= obstacle.speed;

                if (checkCollision(player, obstacle)) {
                    // ×¤×’×™×¢×”
                    canvasState.hits++;
                    canvasState.obstacles.splice(i, 1);
                    if (canvasState.hits >= canvasState.maxHits) {
                        canvasState.isRunning = false;
                        handleQuestResult(false, `×¤×•×¡×™×“×•×Ÿ ×—×¡× ××ª × ×ª×™×‘ ×”××™×! ×—×˜×¤×ª ${canvasState.hits} ×¤×’×™×¢×•×ª. × ×¡×” ×©×•×‘.`);
                        return;
                    }
                } else if (obstacle.x + obstacle.w < 0) {
                    // ××›×©×•×œ ×™×¦× ××”××¡×š
                    canvasState.dodgedCount++;
                    canvasState.obstacles.splice(i, 1);
                    if (canvasState.dodgedCount >= quest.target) {
                        canvasState.isRunning = false;
                        handleQuestResult(true, `×”×ª×—××§×ª ×-20 ×’×•×©×™×! ×¤×•×¡×™×“×•×Ÿ ×”×¨×’×™×¢ ××ª ×”×™×. × ×™×§×•×“: 700`, 700);
                    }
                }
            }
        }

        function drawPoseidonDodge() {
            if (!ctx) return;
            const quest = quests[gameState.currentQuest - 1];
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // ×¦×™×•×¨ ××›×©×•×œ×™×
            canvasState.obstacles.forEach(obstacle => {
                ctx.fillStyle = obstacle.color;
                ctx.fillRect(obstacle.x, obstacle.y, obstacle.w, obstacle.h);
            });

            // ×¦×™×•×¨ ×©×—×§×Ÿ (×“××•×ª)
            drawPlayerFigure(canvasState.player);

            // ×¢×“×›×•×Ÿ ××™×“×¢
            const info = document.getElementById('game-info');
            if (canvasState.isRunning && info) {
                info.innerHTML = `×”×ª×—××§×•×ª: ${canvasState.dodgedCount} / ${quest.target} | ×¤×’×™×¢×•×ª: <span style="color: red">${canvasState.hits}</span> / ${canvasState.maxHits}`;
            }
        }

        // --- ×§×•×•×¡×˜ 7: ×“×™×•× ×™×¡×•×¡ - ××¨×ª×•×Ÿ ×”×‘×¨×× ×™× ×”×§×•×¡××™ (Overcooked Style) ---

        const INGREDIENTS = { GRAPE: 'GRAPE', CLOUD: 'CLOUD', LIGHTNING: 'LIGHTNING' };
        
        function initDionysusCocktail() {
            const quest = quests[6];
            canvasState = {
                isRunning: false, 
                player: { x: canvas.width / 2 - 15, y: canvas.height - 40, w: 30, h: 30, color: '#9d174d', speed: 4.5 }, 
                items: [], // ××¨×›×™×‘×™× ×¤×–×•×¨×™×
                required: { GRAPE: 1, CLOUD: 1, LIGHTNING: 1 },
                inventory: { GRAPE: 0, CLOUD: 0, LIGHTNING: 0 },
                cocktailsMade: 0,
                totalTime: 25, 
                timeRemaining: 25,
                lastTick: Date.now(),
                lastSpawn: 0,
                spawnRate: 1500,

                // --- ×œ×•×’×™×§×ª ×‘×™×©×•×œ ×—×“×©×” ---
                isMixing: false,
                mixingStartTime: 0,
                mixTimeRequired: 2000, // 2 ×©× ×™×•×ª
                
                // --- ×œ×•×’×™×§×ª ××¨×¡ ×—×“×©×” ---
                aresAttacks: [], // ×—×¨×‘×•×ª ×©×œ ××¨×¡
                lastAresSpawn: 0,
                aresSpawnRate: 1800, // ×—×¨×‘ ×›×œ 1.8 ×©× ×™×•×ª
                aresSpeed: 4,

                update: updateDionysusCocktail,
                draw: drawDionysusCocktail,
            };
             // ×¦×™×•×¨ ×¨××©×•× ×™ ×©×œ 4 ××¨×›×™×‘×™× ××›×œ ×¡×•×’
            for (let i = 0; i < 4; i++) {
                spawnIngredient();
            }
        }
        
        function spawnIngredient() {
            const types = Object.keys(INGREDIENTS);
            const type = types[Math.floor(Math.random() * types.length)];
            
            canvasState.items.push({
                x: Math.random() * (canvas.width - 30) + 15, 
                y: Math.random() * (canvas.height - 30) + 15, 
                w: 20, h: 20, 
                type: type,
                r: 10
            });
        }

        function spawnAresAttack(timestamp) {
            // ×—×¨×‘ ×–×–×” ××•×¤×§×™×ª (××™××™×Ÿ ×œ×©×××œ ××• ××©×××œ ×œ×™××™×Ÿ)
            const isLeftToRight = Math.random() < 0.5;
            const y = Math.random() * (canvas.height - 30) + 15;
            const speed = canvasState.aresSpeed + Math.random() * 1.5;

            canvasState.aresAttacks.push({
                x: isLeftToRight ? -20 : canvas.width,
                y: y,
                w: 30, h: 8, // ×¨×•×—×‘ ×•×’×•×‘×” ×©×œ ×”×—×¨×‘
                speed: isLeftToRight ? speed : -speed,
                color: '#b91c1c', // ××“×•× ×©×œ ××¨×¡
                isLeftToRight: isLeftToRight,
            });
            canvasState.lastAresSpawn = timestamp;
            canvasState.aresSpawnRate = Math.max(1000, canvasState.aresSpawnRate - 50); // ××’×‘×™×¨ ×§×¦×‘
        }


        function updateDionysusCocktail(timestamp) {
            const quest = quests[gameState.currentQuest - 1];
            const player = canvasState.player;
            const now = Date.now();

            // ×¢×“×›×•×Ÿ ×˜×™×™××¨
            const elapsed = (now - canvasState.lastTick) / 1000;
            canvasState.lastTick = now;
            canvasState.timeRemaining = Math.max(0, canvasState.timeRemaining - elapsed);
            
            // ×ª× ×•×¢×ª ×©×—×§×Ÿ
            if (keys['ArrowLeft']) player.x -= player.speed;
            if (keys['ArrowRight']) player.x += player.speed;
            if (keys['ArrowUp']) player.y -= player.speed;
            if (keys['ArrowDown']) player.y += player.speed;

            // ×‘×“×™×§×ª ×’×‘×•×œ×•×ª
            if (player.x < 0) player.x = 0;
            if (player.x > canvas.width - player.w) player.x = canvas.width - player.w;
            if (player.y < 0) player.y = 0;
            if (player.y > canvas.height - player.h) player.y = canvas.height - player.h;

            // ×™×¦×™×¨×ª ××¨×›×™×‘×™× ×—×“×©×™× (Spawn)
            if (timestamp - canvasState.lastSpawn > canvasState.spawnRate && canvasState.items.length < 12) {
                spawnIngredient();
                canvasState.lastSpawn = timestamp;
            }

            // ×™×¦×™×¨×ª ×”×ª×§×¤×ª ××¨×¡
            if (timestamp - canvasState.lastAresSpawn > canvasState.aresSpawnRate) {
                spawnAresAttack(timestamp);
            }

            // --- ×œ×•×’×™×§×ª ×”×ª×§×¤×•×ª ××¨×¡ ---
            for (let i = canvasState.aresAttacks.length - 1; i >= 0; i--) {
                const sword = canvasState.aresAttacks[i];
                sword.x += sword.speed;

                if (checkCollision(player, sword)) {
                    // ×¤×’×™×¢×” ×××¨×¡: ××™×¤×•×¡ ××œ××™ ×•×‘×™×˜×•×œ ×‘×™×©×•×œ
                    canvasState.inventory = { GRAPE: 0, CLOUD: 0, LIGHTNING: 0 };
                    canvasState.isMixing = false;
                    canvasState.mixingStartTime = 0;
                    canvasState.aresAttacks.splice(i, 1);
                    break; // ×œ×¦××ª ××”×œ×•×œ××” ×œ××—×¨ ×¤×’×™×¢×”
                } else if (sword.x > canvas.width || sword.x + sword.w < 0) {
                    canvasState.aresAttacks.splice(i, 1);
                }
            }


            // ×‘×“×™×§×ª ××™×¡×•×£
            for (let i = canvasState.items.length - 1; i >= 0; i--) {
                const item = canvasState.items[i];
                if (checkCollision(player, item)) {
                    canvasState.inventory[item.type]++;
                    canvasState.items.splice(i, 1);
                    break; 
                }
            }
            
            // ×‘×“×™×§×ª ××™×§×¡×¨
            const mixer = { x: canvas.width/2 - 50, y: 10, w: 100, h: 50 }; 
            const isCollidingWithMixer = checkCollision(player, mixer);
            
            const hasAllIngredients = 
                canvasState.inventory.GRAPE >= canvasState.required.GRAPE &&
                canvasState.inventory.CLOUD >= canvasState.required.CLOUD &&
                canvasState.inventory.LIGHTNING >= canvasState.required.LIGHTNING;
            
            // ×œ×•×’×™×§×ª ×‘×™×©×•×œ
            if (isCollidingWithMixer && hasAllIngredients) {
                if (!canvasState.isMixing) {
                    // ×”×ª×—×œ×ª ×‘×™×©×•×œ
                    canvasState.isMixing = true;
                    canvasState.mixingStartTime = now;
                } else {
                    // ×‘×“×™×§×ª ×¡×™×•× ×‘×™×©×•×œ
                    if (now - canvasState.mixingStartTime >= canvasState.mixTimeRequired) {
                        // ×‘×™×©×•×œ ××•×¦×œ×—!
                        canvasState.cocktailsMade++;
                        canvasState.inventory = { GRAPE: 0, CLOUD: 0, LIGHTNING: 0 }; // ××™×¤×•×¡ ××œ××™
                        canvasState.isMixing = false;
                        canvasState.mixingStartTime = 0;

                        if (canvasState.cocktailsMade >= quest.target) {
                            canvasState.isRunning = false;
                            handleQuestResult(true, `×”×›× ×ª 3 ×§×•×§×˜×™×™×œ×™×! ×“×™×•× ×™×¡×•×¡ ×—×•×–×¨ ×œ×™×™×Ÿ ×”×¨×’×™×œ. × ×™×§×•×“: 800`, 800);
                            return;
                        }
                    }
                }
            } else {
                // ×× ×™×¦××ª ××”××™×§×¡×¨ ××• ××™×‘×“×ª ××¨×›×™×‘×™×, ×”×¢×¨×‘×•×‘ ××ª×‘×˜×œ
                if (canvasState.isMixing) {
                    canvasState.isMixing = false;
                    canvasState.mixingStartTime = 0;
                }
            }
            
            // ×‘×“×™×§×ª ×–××Ÿ
            if (canvasState.timeRemaining <= 0) {
                canvasState.isRunning = false;
                handleQuestResult(false, `×”×–××Ÿ × ×’××¨! ×œ× ×”×¡×¤×§×ª ×œ×”×›×™×Ÿ ××ª ×›×œ 3 ×”×§×•×§×˜×™×™×œ×™×. × ×¡×” ×©×•×‘.`);
            }
        }

        function drawDionysusCocktail() {
            if (!ctx) return;
            const quest = quests[gameState.currentQuest - 1];
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const now = Date.now();
            
            // 1. ×¦×™×•×¨ ××™×›×œ ×”×¢×¨×‘×•×‘ (Mixer)
            const mixer = { x: canvas.width/2 - 50, y: 10, w: 100, h: 50 };
            ctx.fillStyle = '#6d28d9'; // ×¡×’×•×œ ×¢××•×§ ×œ×™×™×Ÿ
            ctx.fillRect(mixer.x, mixer.y, mixer.w, mixer.h);
            ctx.strokeStyle = '#1e293b';
            ctx.lineWidth = 3;
            ctx.strokeRect(mixer.x, mixer.y, mixer.w, mixer.h);
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 12px Inter';
            ctx.textAlign = 'center';
            ctx.fillText("×¢×¨×‘×•×‘ (Mix)", canvas.width / 2, 40);
            
            // 1.1. ×¦×™×•×¨ ×¡×¨×’×œ ×”×ª×§×“××•×ª ×‘×™×©×•×œ
            if (canvasState.isMixing) {
                const progress = (now - canvasState.mixingStartTime) / canvasState.mixTimeRequired;
                const barWidth = mixer.w * progress;
                ctx.fillStyle = '#FFD700'; // ×¦×”×•×‘ ×–×”×‘ ×œ×”×ª×§×“××•×ª
                ctx.fillRect(mixer.x, mixer.y + mixer.h - 5, barWidth, 5);
            }


            // 2. ×¦×™×•×¨ ××¨×›×™×‘×™×
            canvasState.items.forEach(item => {
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                // ×¦×™×•×¨ ×‘×××¦×¢×•×ª ××™××•×’'×™
                if (item.type === INGREDIENTS.GRAPE) {
                    ctx.fillText('ğŸ‡', item.x, item.y + 15);
                } else if (item.type === INGREDIENTS.CLOUD) {
                    ctx.fillText('â˜ï¸', item.x, item.y + 15);
                } else if (item.type === INGREDIENTS.LIGHTNING) {
                    ctx.fillText('âš¡', item.x, item.y + 15);
                }
            });
            
            // 3. ×¦×™×•×¨ ×”×ª×§×¤×•×ª ××¨×¡ (×—×¨×‘×•×ª)
            canvasState.aresAttacks.forEach(sword => {
                ctx.fillStyle = sword.color;
                ctx.shadowColor = sword.color;
                ctx.shadowBlur = 10;
                
                // ×¦×™×•×¨ ×œ×”×‘
                ctx.fillRect(sword.x, sword.y, sword.w, sword.h);
                // ×¦×™×•×¨ ×™×“×™×ª (×§×˜× ×”)
                ctx.fillStyle = '#78350f';
                ctx.fillRect(sword.x + sword.w, sword.y + 2, 5, 4);

                ctx.shadowBlur = 0;
            });


            // 4. ×¦×™×•×¨ ×©×—×§×Ÿ (×“××•×ª)
            drawPlayerFigure(canvasState.player);

            // 5. ×¢×“×›×•×Ÿ ××™×“×¢ ×•××œ××™ (Inventory)
            const info = document.getElementById('game-info');
            if (canvasState.isRunning && info) {
                const timeColor = canvasState.timeRemaining < 5 ? 'red' : 'green';
                let mixingStatus = '';
                if (canvasState.isMixing) {
                    const timeLeft = canvasState.mixTimeRequired - (now - canvasState.mixingStartTime);
                    mixingStatus = ` | ××¢×¨×‘×‘... <span class="text-yellow-600">${(timeLeft / 1000).toFixed(1)}</span> ×©× '`;
                }
                
                info.innerHTML = `
                    <div style="direction:rtl; display: flex; justify-content: space-between; width: 100%;">
                        <span>×§×•×§×˜×™×™×œ×™×: <span class="text-green-600">${canvasState.cocktailsMade}</span> / ${quest.target}${mixingStatus}</span>
                        <span>×–××Ÿ: <span style="color: ${timeColor}">${canvasState.timeRemaining.toFixed(1)}</span> ×©× '</span>
                    </div>
                    <div class="mt-2 text-sm text-gray-700 font-normal">
                        ××œ××™: ğŸ‡:${canvasState.inventory.GRAPE} / â˜ï¸:${canvasState.inventory.CLOUD} / âš¡:${canvasState.inventory.LIGHTNING}
                    </div>
                `;
            }
        }

        // ×˜×¢×™× ×ª ×”××©×—×§ ×¢× ×¤×ª×™×—×ª ×”×“×£ + ×˜×™×¤×•×œ ×‘×©×’×™××•×ª
        window.onload = function() {
            try {
                // ×‘×“×™×§×” ×× ×”-div ×”×¨××©×™ ×§×™×™×
                if (document.getElementById('game-app')) {
                    renderIntro();
                } else {
                    console.error("Game container #game-app not found.");
                }
            } catch (error) {
                // ×–×” ×™×™×ª×¤×¡ ×¨×§ ×× ×”×©×’×™××” ×”×™× ×‘-renderIntro, ×©×’×™××•×ª Parse ×™×™×ª×¤×¡×• ×¢"×™ ×”-Global Error Handler
                console.error("Game failed to initialize during onload:", error);
            }
        };
    </script>
</body>
</html>
