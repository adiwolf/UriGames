<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מפקד הממלכה (אנימציית קרב צידית)</title>
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // הגדרת משתני Firebase גלובליים
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.signInAnonymously = signInAnonymously;
        window.signInWithCustomToken = signInWithCustomToken;
        window.onAuthStateChanged = onAuthStateChanged;
        window.getFirestore = getFirestore;
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@400;700&display=swap');
        
        :root {
            --tile-size: 80px; /* Base for tile sizing */
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            /* שינוי: רקע כללי של הגוף לדשא כהה ועמוק */
            background-color: #385138; 
            background-image: linear-gradient(135deg, #4f6e4f 25%, #385138 75%);
            color: #e9e9f4;
            font-family: 'Heebo', sans-serif;
            flex-direction: column;
            padding: 20px;
            text-align: right;
        }

        #game-container {
            /* FIXED: משנה את הכיוון הראשי כדי שהפאנל הסטטי יהיה משמאל לפאנל הדינמי */
            display: flex;
            flex-direction: row-reverse; 
            gap: 20px;
            width: 90vw;
            max-width: 900px;
            background-color: rgba(93, 64, 55, 0.9); /* Medium Brown - outer frame, slightly transparent */
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            flex-wrap: wrap;
            transition: opacity 0.5s; /* Smooth fade for cutscene */
        }

        /* NEW: Container for Board, Unit Stats, and Actions (Dynamic Content) */
        #board-and-actions-panel {
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column; /* Stack board, stats, and actions vertically */
            gap: 15px;
            margin: 0 auto;
        }

        #board-container {
            /* מוגדר כ-aspect-ratio 1/1, כך שהוא נשאר יציב יחסית לגודלו */
            width: 100%;
            aspect-ratio: 1 / 1; 
            border: none;
            box-shadow: none;
            border-radius: 8px;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            background-color: transparent;
            overflow: hidden;
            position: relative; 
        }

        .tile {
            border: none; /* הסרת גבול האריח */
            background-color: #558B2F; /* Richer, darker base grass */
            /* UPDATED: Grass texture simulating earth and foliage */
            background-image: linear-gradient(135deg, #689f38 25%, #4caf50 50%, #558b2f 75%); 
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5); /* Inner shadow for depth */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: background-color 0.15s, transform 0.1s;
            position: relative; 
        }
        
        .tile:hover:not(.highlight) {
            background-color: #689f38; /* Brighter green hover */
        }

        /* Unit Icon - Base Styling (No change) */
        .unit-icon {
            font-size: 2.5rem;
            width: 80%;
            height: 80%;
            text-shadow: none;
            position: absolute; 
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); 
            transition: transform 0.15s ease-out, font-size 0.3s ease-out; 
            z-index: 10;
        }

        .unit-icon svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 0 2px rgba(0, 0, 0, 0.5));
        }
        
        /* NEW: Small HP Bar for units on the board */
        .hp-bar {
            position: absolute;
            bottom: 5px; /* מיקום בתחתית האריח */
            width: 80%; /* רוחב הפס */
            height: 6px;
            background-color: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            z-index: 10; /* מעל האריח, מתחת לאייקון (האייקון כבר ב-z-index 10) */
            overflow: hidden;
        }
        .hp-fill {
            height: 100%;
            transition: width 0.3s;
            border-radius: 2px;
        }

        /* UPDATED: Player HP is dark green */
        .hp-player { 
            background-color: #388E3C; /* Darker Green for better contrast/theme */
        }
        /* UPDATED: Change enemy HP color to a strong red */
        .hp-enemy {
            background-color: #D32F2F; /* Strong red for enemy contrast */
        }

        /* Battle Overlay (No change) */
        #battle-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #558B2F; 
            background-image: linear-gradient(135deg, #689f38 25%, #4caf50 50%, #558b2f 75%); 
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: row;
            z-index: 1000;
            gap: 10%;
        }

        .overlay-unit-slot {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            position: relative;
            transform: scale(1); 
            transition: transform 0.1s ease-out;
        }
        
        .overlay-unit-icon {
            width: 250px; 
            height: 250px;
            transition: transform 0.1s ease-out;
        }

        .overlay-defender .overlay-unit-icon {
            transform: scaleX(-1); 
        }
        
        .overlay-unit-icon svg {
            width: 100%;
            height: 100%;
            stroke-width: 1px;
            filter: drop-shadow(0 0 8px rgba(0, 0, 0, 0.9));
        }

        /* Animations (No change) */
        @keyframes shake {
            0% { transform: translate(10px, 0); }
            25% { transform: translate(-10px, 0); }
            50% { transform: translate(10px, 0); }
            75% { transform: translate(-10px, 0); }
            100% { transform: translate(0, 0); }
        }
        
        .overlay-hp-bar {
            width: 300px;
            height: 25px;
            border: 2px solid #fff;
            margin-top: 15px;
            border-radius: 5px;
            overflow: hidden;
        }
        .overlay-hp-fill {
            height: 100%;
            transition: width 0.3s;
        }
        /* UPDATED: Player HP is dark green */
        .overlay-hp-player { background-color: #388E3C; } 
        /* UPDATED: Enemy HP is bright red */
        .overlay-hp-enemy { background-color: #D32F2F; }
        
        /* Unit Colors (No change) */
        .player-unit { color: #4CAF50; } 
        .enemy-unit { color: #f44336; } 
        
        /* Highlight States (No change) */
        .highlight-move {
            background-color: rgba(70, 160, 70, 0.8); 
            border: 2px solid #32cd32; 
            animation: pulse-move 1s infinite alternate;
        }
        .highlight-attack {
            background-color: rgba(255, 69, 0, 0.8); 
            border: 2px solid #ff4500; 
            animation: pulse-attack 1s infinite alternate;
        }
        .selected {
            border: 3px solid #ffeb3b;
            transform: scale(0.95);
        }

        @keyframes pulse-move {
            from { box-shadow: 0 0 5px rgba(50, 200, 50, 0.8); }
            to { box-shadow: 0 0 15px rgba(50, 200, 50, 1); }
        }
        @keyframes pulse-attack {
            from { box-shadow: 0 0 5px rgba(255, 69, 0, 0.8); }
            to { box-shadow: 0 0 15px rgba(255, 69, 0, 1); }
        }

        /* Static Info Panel (Side Panel - renamed from #info-panel in HTML) */
        #static-info-panel {
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        /* Main Controls (Only Restart & Story) */
        #main-controls {
            display: flex;
            gap: 10px;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #795548;
            flex-wrap: wrap; 
            flex-direction: column; /* Force stack in the side panel for prominence */
        }
        
        .main-control-btn {
            flex-grow: 1;
            min-width: 120px;
            width: 100%; /* Default to full width in stack */
            margin-bottom: 5px;
        }
        
        /* NEW: Styling for END_TURN_BTN to be prominent at the top of the side panel */
        #end-turn-btn {
            order: -1; /* Place it at the top of the flex container */
            background-color: #f44336; 
            color: white;
        }
        #end-turn-btn:hover:not(:disabled) { background-color: #ff7043; }

        #restart-btn {
            background-color: #ff9800 !important;
            flex-grow: 1;
        }
        
        #toggle-story-btn {
            background-color: #5d4037;
            color: white;
            flex-grow: 1;
        }
        #toggle-story-btn:hover { background-color: #795548; }

        /* Game Status (No change) */
        #game-status {
            background-color: #3e2723;
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid #ffc107; 
        }

        /* Unit Stats and Actions (Now dynamic, moved under the board) */
        #unit-stats {
            background-color: #3e2723;
            padding: 15px;
            border-radius: 8px;
            min-height: 180px; 
            border-right: 5px solid #4CAF50; 
        }
        
        /* UPDATED: Action buttons container */
        #action-buttons {
            display: flex; 
            gap: 10px;
            margin-top: -10px;
            flex-wrap: wrap; 
        }

        #upgrade-shop {
            background-color: #5d4037; 
            padding: 15px; 
            border-radius: 8px; 
            border-right: 5px solid #ffc107;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Story Panel (Now dynamic content) */
        #story-panel {
            background-color: #3e2723;
            padding: 15px;
            border-radius: 8px;
            border-bottom: 5px solid #795548;
            display: none; 
            max-height: 400px;
            overflow-y: auto;
        }
        #story-panel h2, #story-panel h3 {
            color: #ffc107;
            margin-top: 5px;
        }
        #story-panel ul {
            padding-right: 20px;
        }

        .action-btn {
            background-color: #ffc107; 
            color: #3e2723;
            border: none;
            padding: 10px 15px;
            font-weight: 700;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            flex-grow: 1; 
        }
        .action-btn:hover:not(:disabled) { background-color: #ffeb3b; }
        .action-btn:disabled { background-color: #795548; cursor: not-allowed; } 
        
        
        /* Mobile Layout */
        @media (max-width: 900px) {
            #game-container {
                flex-direction: column; /* Stack panels vertically */
                align-items: center;
                gap: 15px;
            }
            /* הלוח והפעולות יופיעו קודם, אחריהם המידע הסטטי */
            #board-and-actions-panel {
                order: 1;
            }
            #static-info-panel {
                order: 2;
                max-width: 100%;
            }
            #board-container {
                margin: 0;
            }
            
            /* On mobile, stack all 3 main controls */
            #main-controls {
                flex-direction: column; 
            }
            .main-control-btn {
                width: 100%; 
            }
            #end-turn-btn {
                order: -1; 
                margin-bottom: 5px;
            }
            /* Action buttons under the map still flow inline/wrap */
            #action-buttons {
                margin-top: 5px;
            }
        }
    </style>
</head>
<body>
    <h1>מפקד הממלכה: קרב ימי הביניים</h1>
    <div id="game-container">
        
        <!-- NEW: פאנל ללוח, סטטוס יחידה וכפתורי פעולה (התוכן הדינמי) -->
        <div id="board-and-actions-panel">
            
            <!-- לוח המשחק -->
            <div id="board-container">
                <!-- אריחים ייווצרו כאן -->
            </div>

            <!-- סטטוס יחידה נבחרת -->
            <div id="unit-stats">
                <h2>יחידה נבחרת</h2>
                <p id="selected-unit-info">בחר יחידה מהלוח...</p>
            </div>
            
            <!-- כפתורי פעולה (ללא סיום תור) -->
            <div id="action-buttons">
                <!-- יחידות פעולה -->
                <button id="move-btn" class="action-btn" disabled>תזוזה</button>
                <button id="attack-btn" class="action-btn" disabled>התקפה</button>
            </div>
        </div>


        <!-- NEW: פאנל מידע סטטי (סטטוס, חנות, סיפור) -->
        <div id="static-info-panel">
            
            <!-- Main Controls (כולל כעת סיום תור) -->
            <div id="main-controls">
                <!-- END_TURN_BTN is placed here and styled with order:-1 to be first -->
                <button id="end-turn-btn" class="action-btn main-control-btn" disabled>סיום תור &gt;&gt;</button>
                <button id="restart-btn" class="action-btn main-control-btn" disabled>התחל קרב חדש</button>
                <!-- Story Toggle Button -->
                <button id="toggle-story-btn" class="action-btn main-control-btn">סיפור ומדריך</button>
            </div>
            
            <!-- Story Panel - התוכן נוצר כעת על ידי JavaScript -->
            <div id="story-panel">
                <!-- Story content will be dynamically inserted here -->
            </div>


            <div id="game-status">
                <h2>סטטוס המשחק</h2>
                <p id="status-message">טוען נתונים. נא להמתין...</p>
                <p id="gold-display">זהב: 0</p>
                <p id="turn-display">תור: -</p>
            </div>

            
            <!-- Upgrade Shop (Hidden until victory) -->
            <div id="upgrade-shop" style="display: none;">
                <h2>חנות שדרוגי ציוד וגיוס</h2>
                <div id="upgrade-controls" style="display: flex; gap: 10px; flex-direction: column;">
                    
                    <!-- NEW: גיוס יחידות -->
                    <h3 style="color:#FFF;">גיוס יחידות חדשות (רכישה חד פעמית)</h3>
                    <button id="recruit-spearman" class="action-btn upgrade-btn" style="background-color: #64B5F6;">גיוס לוחם מגן (+$2000 | HP גבוה, הגנה 12, תנועה 1)</button>
                    <!-- NEW: Elven Ranger - Available after Battle 2 -->
                    <button id="recruit-elfRanger" class="action-btn upgrade-btn" style="background-color: #8BC34A;">גיוס סייר אלפים (+$2100 | טווח 2, תנועה 4, נחשף בקרב 3+)</button>
                    <button id="recruit-mage" class="action-btn upgrade-btn" style="background-color: #9C27B0;">גיוס מכשף (+$2200 | טווח 2, **התקפה 40**, מהירות גבוהה)</button>

                    <h3 style="color:#FFF; margin-top: 10px;">שדרוגי אביר</h3>
                    <!-- אביר - שדרוג נשק ושריון -->
                    <button id="buy-knight-iron-sword" class="action-btn upgrade-btn">אביר: חרב ברזל (+$1500 | +10 התקפה)</button>
                    <!-- NEW: חרב פלדה -->
                    <button id="buy-knight-steel-sword" class="action-btn upgrade-btn">אביר: חרב פלדה (+$2500 | רמה 3+ | +20 התקפה, +1 טווח)</button>
                    <button id="buy-knight-steel-armor" class="action-btn upgrade-btn">אביר: שריון פלדה (+$2000 | רמה 3+ | +50 חיים, +5 הגנה)</button>
                    
                    <h3 style="color:#FFF; margin-top: 10px;">שדרוגי קשת</h3>
                    <!-- קשת - שדרוג נשק וחפץ מיוחד -->
                    <button id="buy-archer-iron-bow" class="action-btn upgrade-btn">קשת: קשת ברזל (+$1800 | +15 התקפה)</button>
                    <button id="buy-archer-steel-bow" class="action-btn upgrade-btn">קשת: קשת פלדה (+$2500 | רמה 3+ | +20 התקפה, +1 טווח)</button>
                    <button id="buy-archer-move" class="action-btn upgrade-btn">קשת: מגפי עור (+$1500 | +1 טווח תנועה)</button>

                </div>
            </div>

        </div>
    </div>

    <!-- NEW: Battle Overlay Container -->
    <div id="battle-overlay">
        <div id="overlay-attacker" class="overlay-unit-slot">
            <!-- Attacker info goes here -->
        </div>
        <div id="overlay-defender" class="overlay-unit-slot">
            <!-- Defender info goes here -->
        </div>
    </div>

    <script>
        // משתנים גלובליים ואלמנטי DOM
        const GAME_CONTAINER = document.getElementById('game-container');
        const BOARD_CONTAINER = document.getElementById('board-container');
        const STATUS_MESSAGE = document.getElementById('status-message');
        const GOLD_DISPLAY = document.getElementById('gold-display');
        const TURN_DISPLAY = document.getElementById('turn-display');
        const SELECTED_UNIT_INFO = document.getElementById('selected-unit-info');
        const MOVE_BTN = document.getElementById('move-btn'); 
        const ATTACK_BTN = document.getElementById('attack-btn'); 
        const END_TURN_BTN = document.getElementById('end-turn-btn');
        const RESTART_BTN = document.getElementById('restart-btn');
        const UPGRADE_SHOP = document.getElementById('upgrade-shop'); 
        
        // NEW: Story Panel DOM
        const STORY_PANEL = document.getElementById('story-panel');
        const TOGGLE_STORY_BTN = document.getElementById('toggle-story-btn');
        
        // New Overlay Elements
        const BATTLE_OVERLAY = document.getElementById('battle-overlay');
        const OVERLAY_ATTACKER = document.getElementById('overlay-attacker');
        const OVERLAY_DEFENDER = document.getElementById('overlay-defender');


        // משתני משחק
        const BOARD_SIZE = 5;
        let board = [];
        let units = [];
        let selectedUnit = null;
        let gameState = 'loading'; // loading, ready, playerTurn, enemyTurn, gameOver, animating, upgradePhase
        let currentTurn = 0;
        let isReady = false; // דגל טעינת Firebase
        let gold = 0;
        let goldHighScore = 0;
        // NEW: עוקב אחרי באיזה קרב השחקן נמצא (1, 2, 3...)
        let currentBattleIndex = 1; 
        
        // NEW: שמירת שדרוגי ציוד קבועים (Items) - כולל יחידות מגויסות חדשות
        let itemUpgrades = {
            knight: { hp: 0, atk: 0, def: 0, move: 0, range: 0 },
            archer: { hp: 0, atk: 0, def: 0, move: 0, range: 0 },
            spearman: { hp: 0, atk: 0, def: 0, move: 0, range: 0 },
            mage: { hp: 0, atk: 0, def: 0, move: 0, range: 0 },
            elfRanger: { hp: 0, atk: 0, def: 0, move: 0, range: 0 } // NEW
        };
        // NEW: שמירת נתוני רמה/XP - כולל סטטוס גיוס
        let unitProgress = {
            knight: { level: 1, xp: 0, nextLevelXp: 1000 },
            archer: { level: 1, xp: 0, nextLevelXp: 1000 },
            spearman: { level: 1, xp: 0, nextLevelXp: 1000, recruited: false },
            mage: { level: 1, xp: 0, nextLevelXp: 1000, recruited: false },
            elfRanger: { level: 1, xp: 0, nextLevelXp: 1000, recruited: false } // NEW
        };


        // מצבי פעולה - כבר לא משתמשים בו בצורה מפורשת עבור ה-UI
        let currentAction = null; 
        
        // ------------------------------------
        // קטעי סיפור ולור - נחשפים לאט לאט
        // ------------------------------------
        const loreSegments = {
            // Stage 1: Before Battle 1 (The Initial Plight)
            1: {
                title: "ההתחלה: קרב הדרור הראשון",
                lore: `<p>ממלכת הדרור, שפעם הייתה נחלת שלווה המוגנת על ידי חומות עתיקות, עומדת כעת בפני מבחן. בעקבות גילוי עורק נדיר של <strong>זהב קסום</strong> בהרי צפון, התעוררו ישויות רעבות ותאבות בצע.</p>
                       <p>אתה, המפקד הצעיר של חיל המצב, נותרת עם שניים בלבד מהלוחמים הנאמנים ביותר: <strong>האביר</strong> ו<strong>הקשת</strong>. זה הקרב הראשון שלכם על הגנת הבסיס. זהו רק משמר קדמי של שודדים, אך היכולות שלהם עלולות להפתיע.</p>`,
                guide: `<h3>מדריך: חוקי בסיס</h3>
                        <ul>
                            <li>כל יחידה שחקן יכולה לבצע <strong>תזוזה אחת</strong> ו<strong>התקפה אחת</strong> בתור.</li>
                            <li><strong>טווח תנועה:</strong> מספר האריחים המקסימלי למהלך (במצטבר).</li>
                            <li><strong>טווח התקפה:</strong> מרחק המטרה מהיחידה.</li>
                            <li><strong>מצב שדרוג:</strong> לאחר ניצחון בקרב, ה-HP מתמלא במלואו, ואתה עובר לחנות (Upgrade Shop) לרכישת ציוד, גיוס או שדרוג רמות.</li>
                        </ul>`
            },
            // Stage 2: After Battle 1 (New Threat Revealed - Ranged Units)
            2: {
                title: "האויב לומד: איום הקשתים",
                lore: `<p>הדיפתם את גל האורקים הראשון! אך מרחוק, זיהינו קשתים שודדים שמתקרבים דרך העמקים הצדדיים. האויב לומד את הטקטיקה שלך ומנסה לשבור את קו החזית שלך עם יחידות לטווח רחוק.</p>
                       <p><strong>טיפ גיוס:</strong> יש שמועות על <strong>לוחם מגן (Spearman)</strong> שאולי תוכל לגייס. הוא מגן חזק שיכול לשמש כחומה נגד יחידות מליאה, אך דורש עבודה טקטית בגלל טווח התנועה המוגבל שלו.</p>`,
                guide: `<h3>חוקי בסיס</h3>
                        <ul>
                            <li><strong>התקפה:</strong> הנזק מחושב כך: (התקפת תוקף) - (הגנת מגן) = נזק מינימלי של 1.</li>
                            <li><strong>עליית רמה (XP):</strong> השמדת אויב מעניקה XP. עלייה ברמה מגדילה אוטומטית את ה-HP, ההתקפה וההגנה הבסיסיים.</li>
                            <li><strong>התקדמות ברמות:</strong> רמות גבוהות יותר (מדרגה 3) פותחות גישה לציוד **פלדה** חזק בחנות!</li>
                        </ul>`
            },
            // Stage 3: After Battle 2 (The Growing Horde - Magic Threat)
            3: {
                title: "חומות הברזל: כוח חדש?",
                lore: `<p>ניצחון קשה נגד תגבורת האויב. המפקדים המנוסים יותר של האורקים מגיעים לשטח, והם נעים בצורה מתוכננת יותר. ההגנות שלך חזקות, אבל כוח אש חזק יותר ידרש בקרוב. </p>
                       <p><strong>טיפ גיוס:</strong> בדרכים נתקלנו ב<strong>מכשף נודד (Mage)</strong> בעל כוח אש מדהים, אך הוא שביר כמו קליפת ביצה. הוא יקר לגיוס, אבל הנזק שלו עשוי להפוך את הקרב הבא לפשוט יותר.</p>
                       <p><strong>גיוס חדש:</strong> שמענו על יחידת <strong>סייר אלפים</strong> המתמחה בתנועה מהירה ויכולה לסייע בהגנה על האגפים. גיוס יחידות נוספות נפתח עכשיו! </p>`,
                guide: `<h3>חוקי בסיס: טקטיקה מתקדמת</h3>
                        <ul>
                            <li><strong>התקפת מטווח:</strong> קשתות ומכשפים יכולים לתקוף יחידות ממרחק. <strong>אביר</strong> יכול לשמש כהגנה על יחידות שבריריות יותר.</li>
                            <li><strong>מיקום:</strong> השתמשו בלוח בצורה חכמה. יחידות קשת נמצאות בטוחות יותר בשורה האחורית (4) בזמן שהאבירים מחפים עליהן בשורה הקדמית.</li>
                        </ul>`
            },
            // Stage 4: After Battle 3 (The Long War)
            4: {
                title: "המערכה המתארכת: כוחות העומק",
                lore: `<p>ניצחתם את גל התקיפה הגדול ביותר עד כה, אבל נראה שהאויב אינו נגמר. אם ברשותך כוחות נוספים (לוחם מגן או מכשף), למד לשלב את יכולות ההגנה וההתקפה המיוחדות שלהם. כל קרב עולה בדרגת הקושי, והרמה הממוצעת של האויבים תמשיך לעלות. המשך לאגור זהב, המפקד!</p>`,
                guide: `<h3>חוקי בסיס: תזכורת</h3>
                        <ul>
                            <li><strong>שמירה:</strong> כל ההתקדמות (זהב, רמות, גיוסים) נשמרת אוטומטית ב-Firestore.</li>
                            <li><strong>מטרה:</strong> השמד את כל יחידות האויב כדי להתקדם לחנות השדרוג ולקרב הבא.</li>
                        </ul>`
            }
        };

        function generateStoryContent() {
            // הצגת כל הסיפורים שנחשפו עד כה
            // אם currentBattleIndex הוא 3, זה אומר שניצחנו את קרב 2 והצגנו את סיפור 2, אז נציג את כל הסיפורים מ-1 עד 3.
            const battlesWon = Math.max(0, currentBattleIndex - 1);
            const segmentsToShow = battlesWon + 1;
            
            let fullHtml = '<h2>סיפור רקע ומדריך: מפקד הממלכה</h2>';
            
            for (let i = 1; i <= segmentsToShow; i++) {
                const segment = loreSegments[i] || loreSegments[4]; // השתמש בסיפור 4 כברירת מחדל להמשך
                
                fullHtml += `<div style="margin-bottom: 20px; border-bottom: 1px solid #795548; padding-bottom: 10px;">
                                <h3>${i}. ${segment.title}</h3>
                                ${segment.lore}
                                ${i === segmentsToShow ? segment.guide : ''} <!-- הצג מדריך רק עבור הסיפור האחרון שנפתח -->
                            </div>`;
            }
            
            STORY_PANEL.innerHTML = fullHtml;
        }


        // ------------------------------------
        // פונקציות עזר (Utility)
        // ------------------------------------
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // NEW: פונקציה לחישוב בונוס סטטוס לפי רמה
        function calculateLevelBonus(unitType, level) {
            // סטטיסטיקות בסיס (Level 1)
            let baseHp, baseAtk, baseDef, baseMove, baseRange;
            
            switch (unitType) {
                case 'knight':
                    baseHp = 120; baseAtk = 30; baseDef = 10; baseMove = 2; baseRange = 1; break;
                case 'archer':
                    baseHp = 80; baseAtk = 20; baseDef = 5; baseMove = 3; baseRange = 3; break;
                case 'spearman': // UPDATED: SHIELD WARRIOR STATS
                    baseHp = 140; baseAtk = 20; baseDef = 12; baseMove = 1; baseRange = 1; break; // High HP/DEF, Low Move/ATK
                case 'mage': 
                    baseHp = 60; baseAtk = 40; baseDef = 0; baseMove = 4; baseRange = 2; break; 
                case 'goblin': // NEW ENEMY
                    baseHp = 40; baseAtk = 15; baseDef = 0; baseMove = 4; baseRange = 1; break; // Low HP, low ATK, very fast move
                case 'elfRanger': // NEW UNIT: Elven Ranger (High Mobility, Medium Range)
                    baseHp = 70; baseAtk = 25; baseDef = 5; baseMove = 4; baseRange = 2; break; // Fast, decent range, decent attack
                // Enemy units can fall through here with default stats
                default:
                    baseHp = 80; baseAtk = 20; baseDef = 5; baseMove = 2; baseRange = 1; break;
            }
            
            // פקטור צמיחה (לכל רמה נוספת מעבר ל-1)
            const levelFactor = level - 1;
            
            const totalHp = baseHp + (levelFactor * 10); // צמיחת חיים מהירה יותר
            const totalAtk = baseAtk + (levelFactor * 3);  // צמיחת התקפה
            const totalDef = baseDef + (levelFactor * 1);

            return { totalHp, totalAtk, totalDef, baseMove, baseRange };
        }
        
        // ------------------------------------
        // הגדרת אייקוני SVG (במקום אימוג'י) - פיקסל ארט משופר
        // ------------------------------------
        function getUnitSVG(type) {
            
            const SILVER = '#B0B0B0';
            const WHITE = '#FFFFFF';
            const DARK_STEEL = '#606060';
            const WOOD = '#795548';
            const LIGHT_WOOD = '#A1887F';
            const SKIN = '#F0D4A8';
            const ORC_SKIN = '#558B2F';
            const ORC_TEETH = '#FFFFFF';
            const RED = '#F44336';
            const BLACK_GARB = '#1a1a1a'; 
            const MAROON_ACCENT = '#5C3333'; 
            const BRONZE_LIGHT = '#D4A017'; // Lighter Bronze for highlights
            const MAGE_ROBE = '#9C27B0'; // Purple for Mage robe
            const MAGE_ACCENT = '#FFEB3B'; // Gold/Yellow for Mage trim
            
            // Viewbox set to 10x10 for a low-resolution pixel feel
            
            switch (type) {
                case 'knight':
                    // **KNIGHT: Heavy Armor, Bronze Accents, Silver Shield**
                    return `
                        <svg viewBox="0 0 10 10" xmlns="http://www.w3.org/2000/svg">
                            <!-- Body/Armor (Silver base) -->
                            <rect x="3" y="4" width="4" height="6" fill="${SILVER}"/>
                            <!-- Chest Accent is now Bronze highlight -->
                            <rect x="3.5" y="4" width="3" height="1" fill="${BRONZE_LIGHT}"/> 
                            
                            <!-- Right Arm/Shoulder - REMOVED the extra silver block to clean up the outline -->
                            <rect x="7.5" y="5.5" width="0.5" height="0.5" fill="${SKIN}"/> <!-- Exposed Hand/Skin -->
                            
                            <!-- Helmet (Dark Steel) -->
                            <rect x="3" y="1.5" width="4" height="3" fill="${DARK_STEEL}"/>
                            
                            <!-- Exposed Face (SKIN) -->
                            <rect x="4" y="3.5" width="2" height="1" fill="${SKIN}"/> 
                            
                            <rect x="4.5" y="2.5" width="1" height="1" fill="${SILVER}"/> <!-- Visor/Light reflection -->
                            <!-- Sword (Silver) -->
                            <rect x="7" y="2" width="1" height="4" fill="${SILVER}"/>
                            <rect x="6.5" y="5" width="2" height="1" fill="${DARK_STEEL}"/> <!-- Guard -->
                            <!-- Shield (Silver) -->
                            <rect x="2" y="4" width="1" height="4" fill="${SILVER}"/>
                        </svg>`;
                case 'spearman':
                    // **UPDATED: SHIELD WARRIOR: Heavy Defense, Large Shield, Mace/Club**
                    return `
                        <svg viewBox="0 0 10 10" xmlns="http://www.w3.org/2000/svg">
                            <!-- Body/Armor (Silver base) -->
                            <rect x="3" y="4" width="4" height="6" fill="${SILVER}"/>
                            <!-- Helmet (Dark Steel) -->
                            <rect x="3" y="1.5" width="4" height="3" fill="${DARK_STEEL}"/>
                            <!-- Face peek (Skin) -->
                            <rect x="4" y="3.5" width="2" height="1" fill="${SKIN}"/> 
                            
                            <!-- LARGE Shield (Dominant feature, covering front) -->
                            <rect x="1" y="3.5" width="2.5" height="5" fill="#4CAF50"/> <!-- Green Shield -->
                            <rect x="1.5" y="5.5" width="1.5" height="1" fill="${BRONZE_LIGHT}"/> <!-- Central Boss -->

                            <!-- Melee Weapon (Mace/Club on side) -->
                            <rect x="7" y="5" width="1" height="4" fill="${WOOD}"/>
                            <circle cx="7.5" cy="4.5" r="0.5" fill="${DARK_STEEL}"/> <!-- Mace Head -->
                        </svg>`;
                case 'mage':
                    // **MAGE (Updated): Purple Robe, Gold Trim, Simple Staff**
                    return `
                        <svg viewBox="0 0 10 10" xmlns="http://www.w3.org/2000/svg">
                            <!-- Body/Robe (Purple) -->
                            <rect x="3.5" y="3.5" width="3" height="6.5" fill="${MAGE_ROBE}"/>
                            <!-- Hood/Head (Purple) -->
                            <rect x="3" y="1.5" width="4" height="2" fill="${MAGE_ROBE}"/>
                            <!-- Face peek (Skin) -->
                            <rect x="4.5" y="2.5" width="1" height="1" fill="${SKIN}"/>
                            
                            <!-- Gold Trim/Accent -->
                            <rect x="3.5" y="3.5" width="3" height="0.5" fill="${MAGE_ACCENT}"/>
                            
                            <!-- Staff (Held high) -->
                            <rect x="7" y="1" width="0.5" height="8" fill="${WOOD}"/>
                            <!-- Staff Tip/Orb (Yellow) -->
                            <circle cx="7.25" cy="1" r="0.75" fill="${MAGE_ACCENT}"/>
                            
                            <!-- Exposed Hand (Skin) -->
                            <rect x="6" y="4" width="1" height="1" fill="${SKIN}"/>
                        </svg>`;
                case 'elfRanger':
                    // **ELVEN RANGER: Green Garb, Swift Bow (High Mobility Unit)**
                    const ELF_GREEN = '#8BC34A'; // Light Green/Elven color
                    const ELF_BROWN = '#795548'; // Wood color
                    const ELF_SKIN = '#F0D4A8';
                    const ELF_BOW = '#607D8B'; // Slate Blue/Gray bow
                    return `
                        <svg viewBox="0 0 10 10" xmlns="http://www.w3.org/2000/svg">
                            <!-- Body/Garb (Elven Green) -->
                            <rect x="4" y="4" width="2" height="6" fill="${ELF_GREEN}"/>
                            <!-- Hood/Head (Elven Green/Brown) -->
                            <rect x="4" y="2.5" width="2" height="2" fill="${ELF_BROWN}"/>
                            <!-- Face peek (Skin) -->
                            <rect x="4.5" y="3" width="1" height="1" fill="${ELF_SKIN}"/>
                            
                            <!-- Swift Bow (Vertical Stance) -->
                            <rect x="2" y="1.5" width="0.5" height="7" fill="${ELF_BOW}"/>
                            <!-- Arrow (Pulled back, held by hand) -->
                            <line x1="2.5" y1="5.5" x2="6.5" y2="5.5" stroke="${WHITE}" stroke-width="0.3"/> 
                            
                            <!-- Hand (Skin) - holding the bow string/arrow -->
                            <rect x="5.5" y="5" width="1" height="1" fill="${ELF_SKIN}"/> 
                            
                            <!-- Shoulder pads/Accent -->
                            <rect x="3.5" y="4" width="3" height="0.5" fill="${ELF_BROWN}"/> 
                        </svg>`;
                case 'archer':
                    // **ARCHER (PLAYER): Longbow (Horizontal Ellipse), drawn string, light garb**
                    return `
                        <svg viewBox="0 0 10 10" xmlns="http://www.w3.org/2000/svg">
                            <!-- Body/Garb (Light Wood/Brown) -->
                            <rect x="4" y="4" width="2" height="6" fill="${LIGHT_WOOD}"/>
                            <!-- Hood/Head (Darker Brown) -->
                            <rect x="4" y="2.5" width="2" height="2" fill="${WOOD}"/>
                            <!-- Face peek (Skin) -->
                            <rect x="4.5" y="3" width="1" height="1" fill="${SKIN}"/>
                            
                            <!-- FIX 1: Wide, horizontal half-ellipse bow (brown/wood) - MODIFIED: Y control point changed to 3.5 (More Curved) -->
                            <path d="M 1 5 Q 3.5 3.5, 6 5" fill="none" stroke="${WOOD}" stroke-width="0.5"/>
                            
                            <!-- FIX 2: String (White) - Longer, horizontal line drawn back - Y set to 5.3 to create space from the bow -->
                            <line x1="1" y1="5.3" x2="5.5" y2="5.3" stroke="${WHITE}" stroke-width="0.5"/> 

                            <!-- Hand (Skin) - holding the bow string/arrow (Positioned at the end of the drawn string) - Y set to 4.8 to hold the string -->
                            <rect x="5.5" y="4.8" width="1" height="1" fill="${SKIN}"/> 
                        </svg>`;
                case 'banditArcher': // NEW ENEMY TYPE
                    // **BANDIT ARCHER (ENEMY): Dark Garb, Dark Bow**
                    // ***FIXED: viewBox width set to 10 instead of 0***
                    return `
                        <svg viewBox="0 0 10 10" xmlns="http://www.w3.org/2000/svg">
                            <!-- Body/Garb (Black Garb) -->
                            <rect x="4" y="4" width="2" height="6" fill="${BLACK_GARB}"/>
                            <!-- Hood/Head (Dark Garb) -->
                            <rect x="4" y="2.5" width="2" height="2" fill="${BLACK_GARB}"/>
                            <!-- Face peek (Skin) -->
                            <rect x="4.5" y="3" width="1" height="1" fill="${SKIN}"/>
                            
                            <!-- FIX 1: Wide, horizontal half-ellipse bow (Dark Steel) -->
                            <path d="M 1 5 Q 3.5 3.5, 6 5" fill="none" stroke="${DARK_STEEL}" stroke-width="0.5"/>
                            
                            <!-- FIX 2: String (White) - Longer, horizontal line drawn back - Y set to 5.3 to create space from the bow -->
                            <line x1="1" y1="5.3" x2="5.5" y2="5.3" stroke="${WHITE}" stroke-width="0.5"/> 

                            <!-- Hand (Skin) - holding the bow string/arrow (Positioned at the end of the drawn string) - Y set to 4.8 to hold the string -->
                            <rect x="5.5" y="4.8" width="1" height="1" fill="${SKIN}"/> 
                        </svg>`;
                case 'orc':
                    // Orc: Bulky, green skin, pronounced teeth, simple weapon
                    return `
                        <svg viewBox="0 0 10 10" xmlns="http://www.w3.org/2000/svg">
                            <!-- Body (Orc Green, Bulky) -->
                            <rect x="2.5" y="5" width="5.5" height="5" fill="${ORC_SKIN}"/>
                            <!-- Head (Orc Green, wide) -->
                            <rect x="2" y="1.5" width="6" height="4" fill="${ORC_SKIN}"/>
                            <!-- Eyes (Red) -->
                            <rect x="3.5" y="2.5" width="1" height="1" fill="${RED}"/>
                            <rect x="5.5" y="2.5" width="1" height="1" fill="${RED}"/>
                            <!-- Tusks (White, pronounced) -->
                            <rect x="2" y="4.5" width="1" height="1" fill="${ORC_TEETH}"/>
                            <rect x="7" y="4.5" width="1" height="1" fill="${ORC_TEETH}"/>
                            <!-- Weapon (Axe Head - Silver) -->
                            <rect x="7" y="5" width="2" height="1" fill="${SILVER}"/>
                            <rect x="8" y="6" width="1" height="1" fill="${SILVER}"/>
                            <!-- Handle (Dark Steel) -->
                            <rect x="7.5" y="6" width="0.5" height="3" fill="${DARK_STEEL}"/>
                        </svg>`;
                case 'goblin':
                    // **GOBLIN: Small, light green, fast, dart/short knife (NEW)**
                    const GOBLIN_SKIN = '#689F38'; // Light Green
                    const GOBLIN_EYE = '#FFEB3B'; // Yellow eye
                    const GOBLIN_WEAPON = '#A9A9A9'; // Dark silver knife/dart
                    return `
                        <svg viewBox="0 0 10 10" xmlns="http://www.w3.org/2000/svg">
                            <!-- Body/Head (Light Green) -->
                            <rect x="3.5" y="4" width="3" height="5" fill="${GOBLIN_SKIN}"/>
                            <rect x="3" y="2.5" width="4" height="2" fill="${GOBLIN_SKIN}"/>
                            <!-- Eyes (Yellow) -->
                            <rect x="4.5" y="3" width="1" height="1" fill="${GOBLIN_EYE}"/>
                            <!-- Weapon (Small Dagger/Dart) -->
                            <rect x="6.5" y="5" width="1" height="2.5" fill="${GOBLIN_WEAPON}"/>
                            <rect x="7.5" y="4.5" width="0.5" height="1" fill="${GOBLIN_WEAPON}"/> <!-- Blade tip -->
                        </svg>`;
                case 'bandit':
                    // **BANDIT: Exposing skin, dark cloak, maroon accent**
                    return `
                        <svg viewBox="0 0 10 10" xmlns="http://www.w3.org/2000/svg">
                            <!-- Body/Cloak (New Darker Garb) -->
                            <rect x="4" y="4" width="2" height="6" fill="${BLACK_GARB}"/>
                            <!-- Maroon Accent/Belt -->
                            <rect x="3.5" y="6" width="3" height="0.5" fill="${MAROON_ACCENT}"/>
                            <!-- Hood/Head (Dark Garb) -->
                            <rect x="3" y="2.5" width="4" height="2" fill="${BLACK_GARB}"/>
                            <!-- Face peek (Skin) -->
                            <rect x="4.5" y="3" width="1" height="1" fill="${SKIN}"/>
                            
                            <!-- Exposed Hand/Arm (Skin) -->
                            <rect x="5.5" y="4" width="1" height="1" fill="${SKIN}"/> 
                            
                            <!-- Dagger (Silver) -->
                            <rect x="6" y="3" width="1" height="3" fill="${SILVER}"/>
                            <rect x="5.5" y="5" width="2" height="0.5" fill="${DARK_STEEL}"/> <!-- Hilt -->
                        </svg>`;
                default:
                    return `?`;
            }
        }
        // ------------------------------------
        // מחלקת יחידה
        // ------------------------------------
        class Unit {
            // Units now receive base stats and apply item upgrades and level bonuses on creation
            constructor(type, team, row, col, name, xp, level, initialHpRatio = 1.0) {
                this.type = type; // 'knight', 'archer', 'orc', 'bandit', 'banditArcher', 'goblin', 'elfRanger'
                this.team = team; // 'player', 'enemy'
                this.row = row;
                this.col = col;
                this.name = name;
                
                // NEW: XP and Level tracking (only for player units)
                // If it's an enemy unit (type is not 'knight' or 'archer'), these default to 0/1, which is fine.
                this.level = level;
                this.xp = xp;
                this.xpToNextLevel = level * 1000;
                
                // 1. Calculate stats based on Level
                const levelStats = calculateLevelBonus(type, level);
                
                // 2. Apply permanent Item Upgrades (stored in itemUpgrades global)
                // Ensure we only try to apply item upgrades to units that actually have them (knight/archer/spearman/mage/elfRanger)
                let itemUpgradesForType = { hp: 0, atk: 0, def: 0, move: 0, range: 0 };
                if (itemUpgrades[type]) {
                    itemUpgradesForType = itemUpgrades[type];
                }
                
                // Final Stats
                this.maxHp = levelStats.totalHp + itemUpgradesForType.hp; 
                this.atk = levelStats.totalAtk + itemUpgradesForType.atk;
                this.def = levelStats.totalDef + itemUpgradesForType.def;
                
                // Movement/Range stats get a bonus if items were bought
                this.moveRange = levelStats.baseMove + itemUpgradesForType.move;
                this.attackRange = levelStats.baseRange + itemUpgradesForType.range;
                
                // NEW: Keep current HP ratio unless it's a new game (or full heal is intended)
                this.hp = Math.floor(this.maxHp * initialHpRatio);
                
                this.icon = type;
                this.hasMoved = false;
                this.hasAttacked = false;
            }

            get isAlive() {
                return this.hp > 0;
            }
            
            // NEW: פונקציה לטיפול בעליית רמה
            checkLevelUp() {
                if (this.team !== 'player') return false;
                
                let leveledUp = false;
                while (this.xp >= this.xpToNextLevel) {
                    const currentHpRatio = this.hp / this.maxHp;
                    
                    this.level++;
                    this.xp -= this.xpToNextLevel; // נשאר עודף XP
                    this.xpToNextLevel = this.level * 1000; // הגדלת הדרישה לרמה הבאה
                    
                    // חישוב מחדש של הסטטיסטיקות (Level + Item)
                    const levelStats = calculateLevelBonus(this.type, this.level);
                    const itemUpgradesForType = itemUpgrades[this.type];
                    
                    this.maxHp = levelStats.totalHp + itemUpgradesForType.hp;
                    this.atk = levelStats.totalAtk + itemUpgradesForType.atk;
                    this.def = levelStats.totalDef + itemUpgradesForType.def;
                    
                    // NEW LOGIC: HP מתעדכן באופן פרופורציונלי (לא ריפוי מלא)
                    this.hp = Math.min(this.maxHp, Math.floor(this.maxHp * currentHpRatio));
                    
                    STATUS_MESSAGE.innerHTML = `<span style="color:#32cd32; font-weight:700;">היחידה ${this.name} עלתה לרמה ${this.level}!</span>`;
                    leveledUp = true;
                }
                return leveledUp;
            }

            // תצוגת HP כאלמנט HTML (מופעלת תמיד)
            renderHpBar(tile) {
                let hpBar = tile.querySelector('.hp-bar');
                if (!hpBar) {
                    hpBar = document.createElement('div');
                    hpBar.className = 'hp-bar';
                    tile.appendChild(hpBar);
                }

                let hpFill = hpBar.querySelector('.hp-fill');
                if (!hpFill) {
                    hpFill = document.createElement('div');
                    // FIXED: מחלקה של פס החיים
                    hpFill.className = `hp-fill ${this.team === 'player' ? 'hp-player' : 'hp-enemy'}`; 
                    hpBar.appendChild(hpFill);
                }
                
                const hpPercent = (this.hp / this.maxHp) * 100;
                hpFill.style.width = `${hpPercent}%`;
            }

            // עדכון חזותי
            draw(tile) {
                // הסרת תוכן קיים (אם יש) וציור מחדש
                tile.innerHTML = ''; 
                const iconSpan = document.createElement('span');
                iconSpan.className = `unit-icon ${this.team}-unit ${this.type}`;
                // שימוש ב-SVG במקום אימוג'י
                iconSpan.innerHTML = getUnitSVG(this.type);
                tile.appendChild(iconSpan);
                // FIXED: קריאה ל-renderHpBar כאן כדי שהפס יהיה גלוי תמיד
                this.renderHpBar(tile);
            }
            
            // לקיחת נזק
            takeDamage(damage) {
                const effectiveDamage = Math.max(1, damage - this.def);
                // FIXED: מוודאים שהאריח קיים ב-board
                const tile = (this.row >= 0 && this.row < BOARD_SIZE && this.col >= 0 && this.col < BOARD_SIZE) ? board[this.row][this.col] : null;

                this.hp = Math.max(0, this.hp - effectiveDamage);
                
                // NEW: עדכון פס החיים המיידי על הלוח
                if (tile) {
                    this.renderHpBar(tile);
                }

                if (this.hp === 0) {
                    // NEW: יחידה מתה נעלמת מהלוח באופן מיידי
                    if(tile) tile.innerHTML = '';
                    
                    return true; // היחידה מתה
                }
                return false;
            }
        }

        // ------------------------------------
        // פונקציות עזר ללוח
        // ------------------------------------

        function getUnitAt(row, col) {
            // אם יחידה מתה, היא לא נחשבת כיחידה "בשטח"
            return units.find(u => u.row === row && u.col === col && u.isAlive);
        }

        function renderBoard() {
            BOARD_CONTAINER.innerHTML = '';
            board = [];
            for (let r = 0; r < BOARD_SIZE; r++) {
                board[r] = [];
                for (let c = 0; c < BOARD_SIZE; c++) {
                    const tile = document.createElement('div');
                    tile.className = 'tile';
                    tile.dataset.row = r;
                    tile.dataset.col = c;
                    // קריאה לפונקציית לחיצה
                    tile.onclick = () => handleTileClick(r, c); 
                    
                    const unit = getUnitAt(r, c);
                    if (unit) {
                        unit.draw(tile);
                    }
                    
                    board[r][c] = tile;
                    BOARD_CONTAINER.appendChild(tile);
                }
            }
        }

        function clearHighlights() {
            board.flat().forEach(tile => {
                tile.classList.remove('highlight-move', 'highlight-attack', 'selected');
            });
            currentAction = null;
            updateActionButtons();
        }
        
        // NEW: פונקציה כללית לעדכון תצוגה
        function updateUI() {
            GOLD_DISPLAY.textContent = `זהב: ${gold} (שיא: ${goldHighScore})`;
            
            // עדכון כפתורי קנייה
            const costIronSword = 1500;
            const costSteelSword = 2500;
            const costSteelArmor = 2000;
            const costIronBow = 1800;
            const costSteelBow = 2500;
            const costMove = 1500;
            const costSpearman = 2000;
            const costMage = 2200; // UPDATED COST FOR MAGE
            const costElfRanger = 2100; // NEW COST

            const knightLevel = unitProgress.knight.level;
            const archerLevel = unitProgress.archer.level;

            // Item Upgrade Buttons
            const buyKnightIronSwordBtn = document.getElementById('buy-knight-iron-sword');
            const buyKnightSteelSwordBtn = document.getElementById('buy-knight-steel-sword');
            const buyKnightSteelArmorBtn = document.getElementById('buy-knight-steel-armor');
            const buyArcherIronBowBtn = document.getElementById('buy-archer-iron-bow');
            const buyArcherSteelBowBtn = document.getElementById('buy-archer-steel-bow');
            const buyArcherMoveBtn = document.getElementById('buy-archer-move');
            
            // Unit Recruit Buttons
            const recruitSpearmanBtn = document.getElementById('recruit-spearman');
            const recruitMageBtn = document.getElementById('recruit-mage'); 
            const recruitElfRangerBtn = document.getElementById('recruit-elfRanger'); // NEW BUTTON

            // עדכון כפתורי הקנייה: בדיקת זהב ורמה
            if (buyKnightIronSwordBtn) buyKnightIronSwordBtn.disabled = gold < costIronSword || itemUpgrades.knight.atk >= 10;
            if (buyKnightSteelSwordBtn) buyKnightSteelSwordBtn.disabled = gold < costSteelSword || knightLevel < 3 || itemUpgrades.knight.atk >= 20;
            if (buyKnightSteelArmorBtn) buyKnightSteelArmorBtn.disabled = gold < costSteelArmor || knightLevel < 3 || itemUpgrades.knight.def >= 5;
            if (buyArcherIronBowBtn) buyArcherIronBowBtn.disabled = gold < costIronBow || itemUpgrades.archer.atk >= 15;
            if (buyArcherSteelBowBtn) buyArcherSteelBowBtn.disabled = gold < costSteelBow || archerLevel < 3 || itemUpgrades.archer.atk >= 20;
            
            // עדכון כפתור מגפי עור: שינוי טקסט אם כבר בבעלות
            if (buyArcherMoveBtn) {
                const isBootsActive = itemUpgrades.archer.move > 0;
                // ניתן לבטל גם אם אין זהב
                buyArcherMoveBtn.disabled = gold < costMove && !isBootsActive; 
                buyArcherMoveBtn.textContent = isBootsActive 
                    ? `קשת: מגפי עור (פעיל - לחץ לביטול!)`
                    : `קשת: מגפי עור (+$${costMove} | +1 טווח תנועה)`;
            }

            // NEW: עדכון כפתורי גיוס
            if (recruitSpearmanBtn) {
                recruitSpearmanBtn.disabled = gold < costSpearman || unitProgress.spearman.recruited;
                if (unitProgress.spearman.recruited) {
                    recruitSpearmanBtn.textContent = "לוחם מגן גויס (ברשותך)";
                }
            }
            if (recruitMageBtn) { 
                recruitMageBtn.disabled = gold < costMage || unitProgress.mage.recruited; 
                if (unitProgress.mage.recruited) { 
                    recruitMageBtn.textContent = "מכשף גויס (ברשותך)";
                }
            }
            // NEW: Elven Ranger - Available from Battle 3 onwards
            if (recruitElfRangerBtn) {
                if (currentBattleIndex < 3) {
                    recruitElfRangerBtn.disabled = true;
                    recruitElfRangerBtn.style.display = 'block'; // Ensure it's visible but disabled
                    recruitElfRangerBtn.textContent = `גיוס סייר אלפים (נפתח לאחר קרב 2)`;
                } else {
                    recruitElfRangerBtn.disabled = gold < costElfRanger || unitProgress.elfRanger.recruited;
                    if (unitProgress.elfRanger.recruited) {
                        recruitElfRangerBtn.textContent = "סייר אלפים גויס (ברשותך)";
                    } else {
                         recruitElfRangerBtn.textContent = `גיוס סייר אלפים (+$${costElfRanger} | טווח 2, תנועה 4)`;
                    }
                }
            }


            // עדכון תצוגת חנות
            UPGRADE_SHOP.style.display = (gameState === 'upgradePhase') ? 'flex' : 'none';

             // עדכון כפתור סיום תור
            if (gameState === 'upgradePhase') {
                END_TURN_BTN.textContent = `התחל קרב הבא (${currentBattleIndex})`;
                END_TURN_BTN.disabled = false;
            } else if (gameState !== 'gameOver') {
                END_TURN_BTN.textContent = "סיום תור >>";
            }
            
            // עדכון כותרת הסטטוס (קרב נוכחי)
            document.querySelector('#game-status h2').textContent = `סטטוס המשחק (קרב ${currentBattleIndex})`;
        }

        // ------------------------------------
        // אנימציה ופעולת התקפה (Cutscene)
        // ------------------------------------
        
        function setupOverlayUnit(unit, slot, isAttacker = false) {
            const teamClass = unit.team === 'player' ? 'hp-player' : 'hp-enemy';
            const iconClass = unit.team === 'player' ? 'player-unit' : 'enemy-unit';
            
            // For defender, we flip the icon in CSS
            const slotClass = isAttacker ? 'overlay-attacker' : 'overlay-defender';
            
            // HP Percentage
            const hpPercent = (unit.hp / unit.maxHp) * 100;

            slot.className = `overlay-unit-slot ${slotClass}`;

            slot.innerHTML = `
                <h3 style="margin-bottom: 5px;">${unit.name}</h3>
                <div class="overlay-hp-bar">
                    <div id="${unit.team}-hp-fill" class="overlay-hp-fill ${teamClass}" style="width: ${hpPercent}%"></div>
                </div>
                <!-- שימוש ב-SVG ב-Overlay -->
                <span id="${unit.team}-icon" class="overlay-unit-icon ${iconClass} ${unit.type}">${getUnitSVG(unit.type)}</span>
                <p>HP: <span id="${unit.team}-hp-text">${Math.floor(unit.hp)}</span>/${unit.maxHp}</p>
            `;
            return {
                icon: slot.querySelector(`#${unit.team}-icon`),
                hpFill: slot.querySelector(`#${unit.team}-hp-fill`),
                hpText: slot.querySelector(`#${unit.team}-hp-text`),
            };
        }

        // פונקציית האנימציה בפועל
        async function animateAttack(attacker, defender) {
            const ZOOM_IN_TIME = 500;
            const ATTACK_LUNGE_TIME = 150;
            const SHAKE_TIME = 300;
            
            // 1. הסתרת ה-UI והצגת האוברליי
            GAME_CONTAINER.style.opacity = '0';
            BATTLE_OVERLAY.style.display = 'flex';
            
            await sleep(ZOOM_IN_TIME); // Pause for the fade transition

            // 2. הכנת יחידות האוברליי
            const attackerElements = setupOverlayUnit(attacker, OVERLAY_ATTACKER, true);
            const defenderElements = setupOverlayUnit(defender, OVERLAY_DEFENDER, false);
            
            await sleep(300); // Pause for unit display to settle

            // 3. תקיפה (זינוק קדימה)
            const lungeDistance = 30; // פיקסלים
            attackerElements.icon.style.transition = `transform ${ATTACK_LUNGE_TIME}ms ease-out`;
            
            // זינוק של התוקף לעבר המגן
            attackerElements.icon.style.transform = `translateX(${attacker.team === 'player' ? lungeDistance : -lungeDistance}px)`; 
            
            await sleep(ATTACK_LUNGE_TIME); 

            // 4. יישום נזק
            // *** שימו לב: הלוגיקה של לקיחת הנזק והפחתת HP נמצאת בתוך takeDamage() ***
            const isDead = defender.takeDamage(attacker.atk);
            
            // אנימציית רעד קלה על המגן
            defenderElements.icon.style.animation = `shake ${SHAKE_TIME}ms`;
            
            // עדכון חזותי של HP באוברליי
            const hpPercent = (defender.hp / defender.maxHp) * 100;
            defenderElements.hpFill.style.width = `${hpPercent}%`;
            defenderElements.hpText.textContent = Math.floor(defender.hp);
            
            await sleep(SHAKE_TIME); // מחכים שהרעד יסתיים

            // 5. חזרה למיקום
            attackerElements.icon.style.transform = 'translateX(0)'; 
            defenderElements.icon.style.animation = 'none'; 
            
            await sleep(ATTACK_LUNGE_TIME);
            
            // 6. סיום האוברליי
            OVERLAY_ATTACKER.innerHTML = '';
            OVERLAY_DEFENDER.innerHTML = '';
            BATTLE_OVERLAY.style.display = 'none';
            GAME_CONTAINER.style.opacity = '1';
            
            // NEW: אם התוקף הרג, תן לו XP
            if (isDead && attacker.team === 'player') {
                attacker.xp += 500; // XP קבוע על הריגה
                attacker.checkLevelUp(); 
                await saveGold(); // שמור התקדמות
            }

            return isDead;
        }

        // פונקציה עוטפת שמבצעת את כל רצף ההתקפה
        async function performAttackAction(attacker, defender) {
            // נעילת המשחק
            gameState = 'animating'; 
            
            // ** FIXED: הפונקציה takeDamage דואגת כעת לעדכן את הפס חיים על הלוח **
            const isDead = await animateAttack(attacker, defender);

            // 5. לוגיקה לאחר האנימציה
            if (isDead) {
                // עדכן סטטוס
                STATUS_MESSAGE.textContent = `${attacker.name} השמיד את ${defender.name}!`;
                checkWinCondition(); 
            } else {
                 STATUS_MESSAGE.textContent = `${attacker.name} תקף את ${defender.name}. נותרו לו ${Math.floor(defender.hp)} חיים.`;
            }
            
            // עדכון הלוח לאחר הקרב (כדי לוודא שהיחידה המתה נעלמת והפסים מתעדכנים סופית)
            renderBoard();

            // שחרור נעילת המשחק (אם המשחק לא הסתיים)
            if (gameState !== 'gameOver' && gameState !== 'upgradePhase') {
                 gameState = 'playerTurn';
            }
            
            return isDead;
        }

        // ------------------------------------
        // לוגיקת משחק עיקרית
        // ------------------------------------
        
        // NEW: הגדרת אויבים לפי שלב הקרב
        function spawnEnemiesForBattle(battleIndex) {
            let enemies = [];
            
            // קרב 1: קרב מבוא קל (3 אויבים)
            if (battleIndex === 1) {
                // FIXED: ודא שכל יחידה מקבלת XP=0, level=1
                enemies.push(new Unit('orc', 'enemy', 0, 2, 'מפקד אורק', 0, 1, 1.0));
                enemies.push(new Unit('bandit', 'enemy', 1, 1, 'שודד', 0, 1, 1.0));
                enemies.push(new Unit('bandit', 'enemy', 1, 3, 'שודד', 0, 1, 1.0));
            } 
            
            // קרב 2: תגבורת אורקים וקשתים חדשים (4 אויבים)
            else if (battleIndex === 2) {
                // FIXED: יחידות האויב מקבלות רמה/XP תקינים
                enemies.push(new Unit('orc', 'enemy', 0, 1, 'מפקד אורק מנוסה', 0, 2, 1.0)); // רמה 2
                enemies.push(new Unit('orc', 'enemy', 0, 3, 'אורק לוחם', 0, 1, 1.0)); 
                // NEW ENEMY TYPE: קשת שודד (טווח 3)
                enemies.push(new Unit('banditArcher', 'enemy', 1, 0, 'קשת שודד', 0, 1, 1.0)); 
                enemies.push(new Unit('banditArcher', 'enemy', 1, 4, 'קשת שודד', 0, 1, 1.0)); 
            }
            
            // UPDATED: קרב 3: התקפה קלה יותר עם גובלינים חלשים
            else if (battleIndex === 3) {
                 // **MODIFIED SCENARIO (EASIER, 6 units - lower level enemies and Goblins)**
                 enemies.push(new Unit('orc', 'enemy', 0, 2, 'מפקד קרב', 0, 2, 1.0)); 	    // L2 Orc (was L3)
                 enemies.push(new Unit('bandit', 'enemy', 0, 4, 'שודד מובחר', 0, 2, 1.0)); 	    // L2 Bandit (was L3)
                 enemies.push(new Unit('banditArcher', 'enemy', 1, 0, 'קשת שודד (אגף)', 0, 1, 1.0)); // L1 Archer (was L2)
                 enemies.push(new Unit('banditArcher', 'enemy', 1, 3, 'קשת שודד (אגף)', 0, 1, 1.0)); // L1 Archer (was L2)
                 enemies.push(new Unit('goblin', 'enemy', 2, 1, 'גובלין צופה', 0, 1, 1.0)); 	// NEW! L1 Goblin
                 enemies.push(new Unit('goblin', 'enemy', 2, 4, 'גובלין צופה', 0, 1, 1.0)); 	// NEW! L1 Goblin
            }
            
            // קרב 4+: קרב קשה יותר ומתגבר
            else {
                 const baseLevel = battleIndex - 2; // מתחיל מ-2 בקרב 4
                 enemies.push(new Unit('orc', 'enemy', 0, 2, `גנרל קרב ${battleIndex}`, 0, Math.min(6, baseLevel + 1), 1.0)); 
                 enemies.push(new Unit('bandit', 'enemy', 1, 1, 'שודד', 0, baseLevel, 1.0));
                 enemies.push(new Unit('bandit', 'enemy', 1, 3, 'שודד', 0, baseLevel, 1.0));
                 enemies.push(new Unit('banditArcher', 'enemy', 0, 4, 'קשת מאגף', 0, baseLevel, 1.0));
                 enemies.push(new Unit('orc', 'enemy', 1, 2, 'אורק משוריין', 0, baseLevel + 1, 1.0));
            }
            
            // ודא שלכל יחידות האויב מוגדר טווח התקפה הגיוני
            enemies.forEach(e => {
                // ADD 'goblin' to melee units
                if (e.type === 'orc' || e.type === 'bandit' || e.type === 'spearman' || e.type === 'goblin') { 
                    e.attackRange = 1; // יחידות מליאה
                } else if (e.type === 'banditArcher' || e.type === 'archer' || e.type === 'elfRanger') { // archer/elfRanger is range
                    e.attackRange = 3; 
                } else if (e.type === 'mage') { // mage has long range
                    e.attackRange = 2; // UPDATED RANGE
                }
            });
            
            return enemies;
        }
        
        function initGame() {
            // שימוש ב-currentBattleIndex
            const knightProgress = unitProgress.knight;
            const archerProgress = unitProgress.archer;
            
            // יצירת יחידות השחקן עם סטטיסטיקות מעודכנות ו-HP מלא
            const playerUnits = [
                // initialHpRatio = 1.0 מבטיח ריפוי מלא
                new Unit('knight', 'player', 4, 1, 'אביר', knightProgress.xp, knightProgress.level, 1.0),
                new Unit('archer', 'player', 4, 3, 'קשת', archerProgress.xp, archerProgress.level, 1.0),
            ];

            // NEW: הוספת יחידות מגויסות
            if (unitProgress.spearman.recruited) {
                const sp = unitProgress.spearman;
                playerUnits.push(new Unit('spearman', 'player', 4, 0, 'לוחם מגן', sp.xp, sp.level, 1.0));
            }
            // UPDATED: recruit mage if recruited
            if (unitProgress.mage.recruited) {
                const mg = unitProgress.mage;
                playerUnits.push(new Unit('mage', 'player', 3, 4, 'מכשף', mg.xp, mg.level, 1.0));
            }
            // NEW: recruit Elven Ranger if recruited
            if (unitProgress.elfRanger.recruited) {
                const er = unitProgress.elfRanger;
                // Place Elven Ranger in a suitable spot (e.g., 3, 3)
                playerUnits.push(new Unit('elfRanger', 'player', 3, 3, 'סייר אלפים', er.xp, er.level, 1.0));
            }
            
            // יצירת אויבים לפי מספר הקרב
            const enemyUnits = spawnEnemiesForBattle(currentBattleIndex);
            
            units = playerUnits.concat(enemyUnits);
            
            selectedUnit = null;
            currentTurn = 0;
            gameState = 'ready';
            clearHighlights();
            renderBoard(); // עכשיו מוצגות היחידות
            
            STATUS_MESSAGE.textContent = `מתחילים קרב ${currentBattleIndex}! בחר יחידה והתחל.`;
            RESTART_BTN.disabled = false;
            END_TURN_BTN.disabled = false;
            END_TURN_BTN.textContent = "התחל תור (1)";
            
            generateStoryContent(); // **NEW: עדכון הסיפור לפני הקרב**
            updateUI(); 
            startGameTurn();
        }
        
        function startGameTurn() {
            currentTurn++;
            clearHighlights();
            selectedUnit = null;
            
            // איפוס פעולות ליחידות השחקן
            units.filter(u => u.team === 'player' && u.isAlive).forEach(u => {
                u.hasMoved = false;
                u.hasAttacked = false;
                // בודק אם האריח קיים לפני הסרת המחלקה
                const tile = board[u.row] ? board[u.row][u.col] : null;
                if (tile) {
                    tile.classList.remove('selected');
                }
            });
            
            if (currentTurn === 1) { // התור הראשון הוא תמיד של השחקן
                startPlayerTurn();
            } else if (currentTurn % 2 !== 0) {
                 startPlayerTurn();
            } else {
                startEnemyTurn();
            }
            updateUI();
        }
        
        function startPlayerTurn() {
            gameState = 'playerTurn';
            TURN_DISPLAY.textContent = `תור: ${currentTurn} (שחקן)`;
            STATUS_MESSAGE.textContent = "בחר יחידה כדי להזיז או לתקוף.";
            END_TURN_BTN.textContent = "סיום תור >>";
            END_TURN_BTN.disabled = false;
            updateActionButtons();
        }
        
        function startEnemyTurn() {
            gameState = 'enemyTurn';
            TURN_DISPLAY.textContent = `תור: ${currentTurn} (אויב)`;
            STATUS_MESSAGE.textContent = "תור האויב... נא להמתין.";
            END_TURN_BTN.disabled = true;
            updateActionButtons();
            
            // התחלת תהליך תור האויב האסינכרוני
            setTimeout(processEnemyTurn, 1000); 
        }
        
        // NEW: פונקציה לבחירת המהלך האופטימלי ביותר עבור האויב
        function findBestEnemyMove(enemy, target) {
            let bestR = enemy.row;
            let bestC = enemy.col;
            let minDistance = Infinity;

            for (let r = 0; r < BOARD_SIZE; r++) {
                for (let c = 0; c < BOARD_SIZE; c++) {
                    // 1. בדוק אם המיקום החדש תפוס
                    const unitAtTarget = getUnitAt(r, c);
                    if (unitAtTarget && unitAtTarget !== enemy) continue;

                    // 2. בדוק אם המיקום החדש הוא בטווח תנועה
                    const moveDist = Math.abs(enemy.row - r) + Math.abs(enemy.col - c);
                    if (moveDist > 0 && moveDist <= enemy.moveRange) {

                        // 3. חשב את המרחק מנקודה זו אל היעד
                        const distToTarget = Math.abs(r - target.row) + Math.abs(c - target.col);

                        // 4. קריטריונים לבחירה:
                        // א. עדיפות למרחק שקרוב לטווח התקפה של האויב (distToTarget <= enemy.attackRange)
                        // ב. מזער את המרחק ליעד באופן כללי
                        
                        if (distToTarget < minDistance) {
                            minDistance = distToTarget;
                            bestR = r;
                            bestC = c;
                        }
                    }
                }
            }
            
            // אם לא נמצא מהלך טוב יותר, או אם המיקום הטוב ביותר הוא המיקום הנוכחי, נחזיר null
            if (bestR === enemy.row && bestC === enemy.col) {
                return null;
            }

            return { row: bestR, col: bestC };
        }


        // UPDATED: לוגיקת תור האויב המשלבת תזוזה והתקפה
        async function processEnemyTurn() {
            const playerUnits = units.filter(u => u.team === 'player' && u.isAlive);
            const enemyUnits = units.filter(u => u.team === 'enemy' && u.isAlive);
            
            for (const enemy of enemyUnits) {
                if (gameState === 'gameOver' || gameState === 'upgradePhase') break;
                
                // 1. נסה לתקוף מהמיקום הנוכחי
                let target = playerUnits.find(p => isAttackable(enemy.row, enemy.col, p.row, p.col, enemy.attackRange));

                if (target) {
                    await performAttackAction(enemy, target);
                    if (checkWinCondition()) return; 
                    continue; // האויב תקף, התור שלו נגמר
                }

                // 2. אם אין יעד, מצא את המהלך האופטימלי כדי להתקרב
                // א. מצא את היחידה הקרובה ביותר
                let closestTarget = playerUnits.reduce((closest, current) => {
                    const distCurrent = Math.abs(enemy.row - current.row) + Math.abs(enemy.col - current.col);
                    if (distCurrent < closest.distance) {
                        return { unit: current, distance: distCurrent };
                    }
                    return closest;
                }, { unit: null, distance: Infinity });

                if (closestTarget.unit) {
                    const moveCoords = findBestEnemyMove(enemy, closestTarget.unit);

                    if (moveCoords) {
                        // ב. בצע את התנועה
                        moveUnit(enemy, moveCoords.row, moveCoords.col);
                        renderBoard();
                        await sleep(500); // השהיה קלה לאחר תזוזת האויב

                        // 3. בדוק שוב לתקיפה לאחר התזוזה (Move-Attack)
                        let postMoveTarget = playerUnits.find(p => isAttackable(enemy.row, enemy.col, p.row, p.col, enemy.attackRange));

                        if (postMoveTarget) {
                            await performAttackAction(enemy, postMoveTarget);
                            if (checkWinCondition()) return;
                        }
                    }
                }
                // האויב סיים את תורו (או עבר/או עבר ותקף)
            }
            
            // לאחר שכל האויבים סיימו
            if (gameState !== 'gameOver' && gameState !== 'upgradePhase') {
                 startGameTurn();
            }
        }

        function checkWinCondition() {
            // רק יחידות חיות נספרות
            const playerAlive = units.some(u => u.team === 'player' && u.isAlive);
            const enemyAlive = units.some(u => u.team === 'enemy' && u.isAlive);

            if (!playerAlive) {
                handleLoss(); // טיפול בהפסד
                return true;
            }
            if (!enemyAlive) {
                postVictoryState(); // NEW: טיפול בניצחון ושדרוג
                return true;
            }
            return false;
        }

        // NEW: פונקציה לטיפול במעבר למצב שדרוג
        async function postVictoryState() {
            gameState = 'upgradePhase';
            clearHighlights();
            selectedUnit = null;
            
            const goldEarned = 1000 + (currentTurn * 100);
            gold += goldEarned;
            
            // NEW: שמירת נתוני הרמה/XP רק של היחידות החיות והקיימות
            units.filter(u => u.team === 'player').forEach(u => {
                unitProgress[u.type].level = u.level;
                unitProgress[u.type].xp = u.xp;
                unitProgress[u.type].nextLevelXp = u.xpToNextLevel;
            });
            
            currentBattleIndex++; // **קידום מספר הקרב לפני שמירת הנתונים ועדכון הסיפור**
            
            // הוספת עלילה ספציפית לכל ניצחון
            let battleStory = '';
            if (currentBattleIndex === 2) { // ניצחון בקרב 1
                battleStory = "הדיפתם את גל האורקים הראשון! אך מרחוק, זיהינו קשתים שודדים שמתקרבים דרך העמקים הצדדיים. התכונן לתגבורת מהירה יותר, המפקד. ";
            } else if (currentBattleIndex === 3) { // ניצחון בקרב 2
                 battleStory = "האזור נקי לעת עתה. ניצחון קשה נגד תגבורת האויב. עליך להתחזק במהירות, המאבק רק החל. ";
            } else if (currentBattleIndex === 4) { // ניצחון בקרב 3
                 battleStory = "התקיפה המתואמת של גל האויבים השלישי נכשלה בזכות הלוחמים החדשים והנשקים המשופרים שלכם. נראה שהמלחמה רק החלה להתחמם.";
            } else {
                 battleStory = "ניצחון נוסף! אויבי הממלכה ממשיכים להפסיד קרב אחר קרב.";
            }

            STATUS_MESSAGE.innerHTML = `<span style="color:#ffc107;">ניצחון בקרב ${currentBattleIndex - 1}!</span> ${battleStory} זכית ב-${goldEarned} זהב. שדרג את יחידותיך בחנות לפני הקרב הבא.`;
            
            await saveGold(); // שמירת הכל
            generateStoryContent(); // **NEW: עדכון הסיפור כדי להציג את הפרק החדש**
            updateUI();

            RESTART_BTN.disabled = false;
            END_TURN_BTN.disabled = false; // כפתור הופך ל"התחל קרב הבא"
            TURN_DISPLAY.textContent = `תור: - (שדרוג)`;
        }

        // RENAMED: פונקציה לטיפול בהפסד
        function handleLoss() {
            gameState = 'gameOver';
            clearHighlights();
            selectedUnit = null;
            updateActionButtons();
            
            STATUS_MESSAGE.innerHTML = `<span style="color:#f44336;">הפסד!</span> כל היחידות הושמדו.`;
            
            saveGold();
            updateUI(); // יעדכן את הזהב (אם במקרה נצבר)

            RESTART_BTN.disabled = false;
            END_TURN_BTN.disabled = true;
            TURN_DISPLAY.textContent = `תור: - (הסתיים)`;
        }

        // ------------------------------------
        // טיפול בקליקים ופעולות (כעת מבוסס אריחים)
        // ------------------------------------

        function handleTileClick(r, c) {
            if (gameState !== 'playerTurn') return;
            
            const clickedUnit = getUnitAt(r, c);
            const tile = board[r][c];
            
            // 1. ניסיון לבצע פעולה (תזוזה או התקפה)
            if (selectedUnit) {
                const isMoveAttempt = tile.classList.contains('highlight-move');
                const isAttackAttempt = tile.classList.contains('highlight-attack');

                if (isMoveAttempt && !selectedUnit.hasMoved) {
                    // ביצוע תזוזה
                    moveUnit(selectedUnit, r, c);
                    selectedUnit.hasMoved = true;
                    clearHighlights();
                    // הצג את אפשרויות התקיפה הנותרות לאחר התזוזה
                    showAvailableActions();
                    updateSelectedUnitInfo(selectedUnit);
                    renderBoard();
                    return;

                } else if (isAttackAttempt && !selectedUnit.hasAttacked) {
                    // ביצוע התקפה
                    if (clickedUnit && clickedUnit.team === 'enemy') {
                        
                        // ביצוע האנימציה והלוגיקה בתוך async wrapper כדי לאפשר await
                        (async () => {
                            const isDead = await performAttackAction(selectedUnit, clickedUnit);
                            
                            // Check if game ended or unit was unselected during animation
                            if (gameState === 'gameOver' || gameState === 'upgradePhase' || !selectedUnit) return; 
                            
                            // NEW: עדכון XP לאחר קרב
                            if (isDead) {
                                // XP ניתן בתוך פונקציית animateAttack
                                // רק צריך לעדכן את תצוגת היחידה הנבחרת
                                updateSelectedUnitInfo(selectedUnit);
                            }

                            selectedUnit.hasAttacked = true;
                            clearHighlights();
                            // נשאר על היחידה הנבחרת כדי לראות סטטוס
                            board[selectedUnit.row][selectedUnit.col].classList.add('selected');
                            updateSelectedUnitInfo(selectedUnit);
                            renderBoard();
                        })(); // Immediately execute
                        return;
                    }
                }
            }

            // 2. ניסיון לבחור יחידה חדשה או לבטל בחירה
            clearHighlights(); // נקה הכל לפני בחירה חדשה
            
            if (clickedUnit && clickedUnit.team === 'player') {
                if (selectedUnit === clickedUnit) {
                    // ביטול בחירה
                    selectedUnit = null;
                    SELECTED_UNIT_INFO.innerHTML = "בחר יחידה מהלוח...";
                } else {
                    // בחירת יחידה חדשה
                    selectedUnit = clickedUnit;
                    tile.classList.add('selected');
                    updateSelectedUnitInfo(selectedUnit);
                    showAvailableActions(); // הצג פעולות זמינות מיידית
                }
            } else {
                selectedUnit = null; // קליק על אריח ריק או אויב ללא פעולה
                SELECTED_UNIT_INFO.innerHTML = "בחר יחידה מהלוח...";
            }
            
            updateActionButtons();
        }
        
        // --- פונקציות עזר לפעולות ---

        function updateActionButtons() {
            // FIXED: בדיקה שאלמנטי הכפתורים קיימים לפני הגישה
            if (MOVE_BTN) {
                // הלחצנים כעת מציגים רק את הסטטוס הפעולה של היחידה הנבחרת
                MOVE_BTN.disabled = selectedUnit ? selectedUnit.hasMoved : true;
                ATTACK_BTN.disabled = selectedUnit ? selectedUnit.hasAttacked : true;

                // עדכון הכפתורים החזותיים כדי שיהיו אינדיקציה טובה יותר
                MOVE_BTN.style.backgroundColor = selectedUnit && !selectedUnit.hasMoved ? '#ffc107' : '#795548';
                ATTACK_BTN.style.backgroundColor = selectedUnit && !selectedUnit.hasAttacked ? '#ffc107' : '#795548';
            }

            // אם היחידה סיימה את שתי הפעולות, הלחצנים לא נגישים והיא נשארת נבחרת
        }

        function updateSelectedUnitInfo(unit) {
             // NEW: הוספת בונוס שדרוג ו-XP/רמה לתצוגה
             const itemUpgradesForType = itemUpgrades[unit.type] || { hp: 0, atk: 0, def: 0, move: 0, range: 0 };
             // בונוס כולל (רמה + חפץ)
             const totalHp = unit.maxHp;
             const totalAtk = unit.atk;
             const totalDef = unit.def;
             const totalMove = unit.moveRange;
             const totalRange = unit.attackRange;
             
             // בונוס חפץ מוצג בסוגריים
             const hpBonus = itemUpgradesForType.hp > 0 ? ` (+${itemUpgradesForType.hp})` : '';
             const atkBonus = itemUpgradesForType.atk > 0 ? ` (+${itemUpgradesForType.atk})` : '';
             const moveBonus = itemUpgradesForType.move > 0 ? ` (+${itemUpgradesForType.move})` : '';
             const rangeBonus = itemUpgradesForType.range > 0 ? ` (+${itemUpgradesForType.range})` : '';
             
             let progressInfo = '';
             if (unit.team === 'player') {
                 const percent = (unit.xp / unit.xpToNextLevel) * 100;
                 progressInfo = `
                      <p>רמה: ${unit.level}</p>
                      <p>XP: ${unit.xp}/${unit.xpToNextLevel} (${Math.floor(percent)}%)</p>
                    `;
             }
             
             SELECTED_UNIT_INFO.innerHTML = `
                 <p><strong>${unit.name}</strong> (${unit.team === 'player' ? 'שלך' : 'אויב'})</p>
                 ${progressInfo}
                 <p>חיים: ${Math.floor(unit.hp)}/${totalHp} ${hpBonus}</p>
                 <p>התקפה: ${totalAtk} ${atkBonus} | הגנה: ${totalDef}</p>
                 <p>טווח תנועה: ${totalMove} ${moveBonus} | טווח תקיפה: ${totalRange} ${rangeBonus}</p>
                 <p style="color:${unit.hasMoved ? '#f44336' : '#4CAF50'}">הוזז: ${unit.hasMoved ? 'כן' : 'לא'}</p>
                 <p style="color:${unit.hasAttacked ? '#f44336' : '#4CAF50'}">תקף: ${unit.hasAttacked ? 'כן' : 'לא'}</p>
             `;
        }
        
        // הפונקציה החדשה שמציגה טווח תנועה והתקפה אוטומטית
        function showAvailableActions() {
            if (!selectedUnit) return;
            clearHighlights(); // ודא שכל הדגשות קודמות נמחקו
            
            for (let r = 0; r < BOARD_SIZE; r++) {
                for (let c = 0; c < BOARD_SIZE; c++) {
                    const tile = board[r][c];
                    const targetUnit = getUnitAt(r, c);
                    
                    // הדגשת תזוזה
                    if (!selectedUnit.hasMoved && isValidMove(selectedUnit.row, selectedUnit.col, r, c, selectedUnit)) {
                        tile.classList.add('highlight-move');
                    }
                    
                    // הדגשת התקפה
                    if (!selectedUnit.hasAttacked && 
                        targetUnit && 
                        targetUnit.team !== selectedUnit.team && 
                        isAttackable(selectedUnit.row, selectedUnit.col, r, c, selectedUnit.attackRange)) {
                             tile.classList.add('highlight-attack');
                    }
                }
            }
            // שמור על היחידה הנבחרת מסומנת
            board[selectedUnit.row][selectedUnit.col].classList.add('selected');
        }


        function moveUnit(unit, newR, newC) {
            // הסרת יחידה מהאריח הישן
            board[unit.row][unit.col].innerHTML = '';
            
            // עדכון המיקום
            unit.row = newR;
            unit.col = newC;
            
            // ציור מחדש במיקום החדש
            unit.draw(board[newR][newC]);
            
            // הדגשה חזותית של תנועה
            board[newR][newC].style.transform = 'scale(1.1)';
            setTimeout(() => {
                board[newR][newC].style.transform = 'scale(1)';
            }, 150);
        }

        
        // --- פונקציות בדיקת טווח ---

        // פונקציה משודרגת - מקבלת את היחידה הנבחרת כדי לקבל את טווח התנועה
        function isValidMove(startR, startC, endR, endC, unit = selectedUnit) {
            if (getUnitAt(endR, endC)) {
                return false; // אריח תפוס
            }
            
            // בדיקה שרק היחידה עצמה יכולה לבדוק את טווח התנועה שלה
            if (!unit) return false;

            const dist = Math.abs(startR - endR) + Math.abs(startC - endC);
            return dist > 0 && dist <= unit.moveRange;
        }

        function isAttackable(startR, startC, endR, endC, range) {
            const dist = Math.abs(startR - endR) + Math.abs(startC - endC);
            return dist > 0 && dist <= range;
        }
        
        // ------------------------------------
        // לוגיקת חנות וציוד
        // ------------------------------------
        
        async function recruitUnit(unitType, cost, itemName) {
            if (gameState !== 'upgradePhase') {
                STATUS_MESSAGE.textContent = "ניתן לגייס יחידות רק אחרי ניצחון בקרב.";
                return;
            }
            // UPDATED: Check for 'mage' or 'spearman' status
            if (unitProgress[unitType].recruited) {
                STATUS_MESSAGE.textContent = `היחידה ${itemName} כבר גויסה ונמצאת ברשותך!`;
                return;
            }
            if (gold < cost) {
                STATUS_MESSAGE.textContent = `אין מספיק זהב לגיוס! נדרש $${cost}. יש לך $${gold}.`;
                return;
            }

            // NEW: תנאי רכישת סייר אלפים - זמין רק אחרי קרב 2
            if (unitType === 'elfRanger' && currentBattleIndex < 3) {
                STATUS_MESSAGE.textContent = "גיוס סייר אלפים נפתח רק אחרי קרב 2.";
                return;
            }

            gold -= cost;
            unitProgress[unitType].recruited = true;
            
            await saveGold();
            
            STATUS_MESSAGE.innerHTML = `<span style="color:#64B5F6;">גיוס מוצלח!</span> היחידה: ${itemName} הצטרפה לכוחותיך. היא תופיע בקרב הבא.`;
            updateUI();
        }

        async function buyItem(unitType, cost, updates, itemName, requiredLevel = 1) {
            if (gameState !== 'upgradePhase') {
                STATUS_MESSAGE.textContent = "ניתן לקנות חפצים רק אחרי ניצחון בקרב.";
                return;
            }
            
            // NEW: ודא שניתן לקנות ציוד רק ליחידות קיימות/מגויסות
            // UPDATED: Added 'elfRanger' to the check
            if (!unitProgress[unitType] || (unitType !== 'knight' && unitType !== 'archer' && !unitProgress[unitType].recruited)) {
                 if (unitType === 'spearman' && !unitProgress.spearman.recruited) {
                     STATUS_MESSAGE.textContent = `לא ניתן לקנות ציוד. גייס את לוחם המגן תחילה!`;
                 } else if (unitType === 'mage' && !unitProgress.mage.recruited) {
                      STATUS_MESSAGE.textContent = `לא ניתן לקנות ציוד. גייס את המכשף תחילה!`;
                 } else if (unitType === 'elfRanger' && !unitProgress.elfRanger.recruited) {
                      STATUS_MESSAGE.textContent = `לא ניתן לקנות ציוד. גייס את סייר האלפים תחילה!`;
                 } else {
                      // ליתר ביטחון, אם זה knight או archer שלא מוגדרים
                      if (!unitProgress[unitType]) {
                           STATUS_MESSAGE.textContent = `שגיאה: יחידת ${unitType} אינה קיימת.`;
                      }
                 }
                 return;
            }

            // 1. **Toggle Logic for Leather Boots (MOVE only item)**
            if (itemName === 'מגפי עור' && updates.move !== undefined && updates.atk === undefined && updates.hp === undefined) {
                
                // הבונוס המנוטרל הוא בדיוק גובה הבונוס שניתן
                const isBootsActive = itemUpgrades[unitType].move === updates.move;
                
                if (isBootsActive) {
                    // אם כבר בבעלותם -> בטל את ההשפעה (Toggle Off)
                    itemUpgrades[unitType].move = 0; // הסרת הבונוס
                    STATUS_MESSAGE.innerHTML = `<span style="color:#f44336;">בוטלה ההשפעה!</span> ${itemName} הוסרו מ${unitType === 'knight' ? 'האביר' : 'הקשת'}.`;
                    await saveGold();
                    updateUI();
                    return; // יציאה ללא גביית מחיר
                } 
                // אם אינו פעיל, המשך לבדיקת הזהב והרכישה
            }

            // בדיקת דרישות רכישה (זהב ורמה)
            if (gold < cost) {
                STATUS_MESSAGE.textContent = `אין מספיק זהב! נדרש $${cost}. יש לך $${gold}.`;
                return;
            }
            
            const currentLevel = unitProgress[unitType].level;
            if (currentLevel < requiredLevel) {
                 STATUS_MESSAGE.textContent = `דרושה רמה ${requiredLevel} כדי לקנות את ${itemName}! הרמה הנוכחית היא ${currentLevel}.`;
                 return;
            }

            // 2. **Stronger Weapon Only Check (ATK/RANGE)**
            if (updates.atk !== undefined || updates.range !== undefined) {
                const currentAtkBonus = itemUpgrades[unitType].atk;
                const newAtk = updates.atk || 0; 
                
                // ודא שהנשק החדש חזק יותר
                if (newAtk < currentAtkBonus) {
                    STATUS_MESSAGE.textContent = `לא שודרג! ${itemName} (+${newAtk} התקפה) אינו חזק מהנשק הפעיל (+${currentAtkBonus} התקפה).`;
                    return;
                }
                // ודא שלא קונים נשק זהה (למעט אם אין נשק, ואז currentAtkBonus=0)
                if (newAtk === currentAtkBonus && currentAtkBonus !== 0) {
                     STATUS_MESSAGE.textContent = `כבר ברשותך נשק בעל בונוס זהה (+${currentAtkBonus} התקפה).`;
                     return;
                }
            }


            // לוגיקת החלפת ציוד: מאפס את הבונוסים הישנים ומחיל את החדשים
            
            // איפוס בונוסי שריון (HP/DEF) - קניית שריון חדש מבטלת ישן
            if (updates.hp !== undefined || updates.def !== undefined) {
                 itemUpgrades[unitType].hp = 0;
                 itemUpgrades[unitType].def = 0;
            }
            // איפוס בונוסי נשק (ATK/RANGE) - קניית נשק חדש מבטלת ישן
            if (updates.atk !== undefined || updates.range !== undefined) {
                 itemUpgrades[unitType].atk = 0;
                 itemUpgrades[unitType].range = 0;
            }
            
            // גביית מחיר והחלת הבונוסים החדשים
            gold -= cost;
            Object.keys(updates).forEach(stat => {
                 itemUpgrades[unitType][stat] += updates[stat];
            });
            
            await saveGold();
            
            STATUS_MESSAGE.innerHTML = `<span style="color:#ffc107;">קנייה מוצלחת!</span> נרכש: ${itemName}.`;
            updateUI();
        }


        // ------------------------------------
        // לוגיקת Firebase ושמירת זהב
        // ------------------------------------
        
        async function setupFirebase() {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                let firebaseConfig;
                
                // FIXED: טיפול ב-config חסר או לא תקין
                try {
                    const configString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
                    firebaseConfig = JSON.parse(configString);
                } catch (e) {
                    firebaseConfig = {};
                }


                if (!firebaseConfig || !firebaseConfig.apiKey) {
                    // אם הקונפיגורציה חסרה, מציגים את השגיאה
                    STATUS_MESSAGE.textContent = 'שגיאת Firebase: חסר קונפיגורציה. משחק ללא שמירה.';
                    console.error("Firebase config is missing or invalid. Running without persistence.");
                    
                    // NEW: מאפשרים משחק ללא שמירה אם הקונפיגורציה חסרה
                    isReady = true;
                    RESTART_BTN.disabled = false;
                    generateStoryContent(); // **NEW: טעינת סיפור התחלתי**
                    STATUS_MESSAGE.textContent = "טעינת נתונים הסתיימה. לחץ 'התחל קרב חדש' כדי להתחיל."; 
                    return; 
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                userId = auth.currentUser?.uid || 'anonymous-user';

                await loadGold();
                
                // FIXED: הודעת סטטוס שמנחה את המשתמש
                STATUS_MESSAGE.textContent = "טעינת נתונים הסתיימה. לחץ 'התחל קרב חדש' כדי להתחיל."; 
                isReady = true;
                RESTART_BTN.disabled = false;
                generateStoryContent(); // **NEW: טעינת הסיפור בהתאם להתקדמות שנשמרה**
                
            } catch (error) {
                console.error("Firebase setup failed:", error);
                STATUS_MESSAGE.textContent = `שגיאת חיבור: ${error.message.substring(0, 30)}...`;
            }
        }

        async function loadGold() {
            // אם db הוא null, אנחנו במצב ללא שמירה
            if (!db || !userId) return;

            const docRef = doc(db, 'artifacts', typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', 'users', userId, 'progress', 'goldData');
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    gold = data.gold || 0;
                    goldHighScore = data.highScore || 0;
                    // FIXED: ודא שהקרב ההתחלתי הוא 1 אם אין נתונים
                    currentBattleIndex = data.currentBattleIndex || 1; 
                    
                    // NEW: טעינת שדרוגי ציוד ונתוני גיוס
                    const defaultItemUpgrades = { knight: { hp: 0, atk: 0, def: 0, move: 0, range: 0 }, archer: { hp: 0, atk: 0, def: 0, move: 0, range: 0 }, spearman: { hp: 0, atk: 0, def: 0, move: 0, range: 0 }, mage: { hp: 0, atk: 0, def: 0, move: 0, range: 0 }, elfRanger: { hp: 0, atk: 0, def: 0, move: 0, range: 0 } };
                    itemUpgrades = { ...defaultItemUpgrades, ...data.itemUpgrades };
                    
                    // UPDATED: Ensure default includes 'mage' and 'elfRanger'
                    const defaultUnitProgress = { knight: { level: 1, xp: 0, nextLevelXp: 1000 }, archer: { level: 1, xp: 0, nextLevelXp: 1000 }, spearman: { level: 1, xp: 0, nextLevelXp: 1000, recruited: false }, mage: { level: 1, xp: 0, nextLevelXp: 1000, recruited: false }, elfRanger: { level: 1, xp: 0, nextLevelXp: 1000, recruited: false } };
                    unitProgress = { ...defaultUnitProgress, ...data.unitProgress };

                    // FIX: אם היחידה הישנה 'scout' קיימת, מעביר אותה ל-'mage'
                    if (data.unitProgress && data.unitProgress.scout && data.unitProgress.scout.recruited) {
                         unitProgress.mage.recruited = true;
                         unitProgress.mage.level = data.unitProgress.scout.level;
                         unitProgress.mage.xp = data.unitProgress.scout.xp;
                         itemUpgrades.mage = data.itemUpgrades.scout || itemUpgrades.mage;
                         delete unitProgress.scout;
                         delete itemUpgrades.scout;
                    }
                } else {
                    // שמור נתוני ברירת מחדל אם אין
                    await saveGold(); 
                }
            } catch (e) {
                console.error("Error loading document:", e);
            }
        }

        async function saveGold() {
            // אם db הוא null, אנחנו במצב ללא שמירה
            if (!db || !userId) return;
            
            if (gold > goldHighScore) {
                goldHighScore = gold;
            }

            // NEW: נרמול הנתונים לפני שמירה (כדי למנוע שמירת 'scout' בטעות)
            const savedItemUpgrades = {
                knight: itemUpgrades.knight,
                archer: itemUpgrades.archer,
                spearman: itemUpgrades.spearman,
                mage: itemUpgrades.mage,
                elfRanger: itemUpgrades.elfRanger // NEW
            };
            const savedUnitProgress = {
                knight: unitProgress.knight,
                archer: unitProgress.archer,
                spearman: unitProgress.spearman,
                mage: unitProgress.mage,
                elfRanger: unitProgress.elfRanger // NEW
            };

            const docRef = doc(db, 'artifacts', typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', 'users', userId, 'progress', 'goldData');
            try {
                await setDoc(docRef, {
                    gold: Math.floor(gold),
                    highScore: Math.floor(goldHighScore),
                    currentBattleIndex: currentBattleIndex, // NEW: שמירת אינדקס הקרב
                    itemUpgrades: savedItemUpgrades, // NEW: שמירת שדרוגי ציוד
                    unitProgress: savedUnitProgress // NEW: שמירת XP/רמה
                }, { merge: true });
            } catch (e) {
                console.error("Error saving document:", e);
            }
        }

        // ------------------------------------
        // האזנה לאירועים
        // ------------------------------------
        
        // פונקציית האתחול הראשית
        window.onload = () => {
            renderBoard(); // ציור הלוח הריק
            setupFirebase();
            RESTART_BTN.onclick = () => {
                 if (isReady) {
                      // NEW: איפוס מלא כולל התקדמות
                      currentBattleIndex = 1; 
                      // איפוס מלא של כל הנתונים כולל הגיוס
                      itemUpgrades = { knight: { hp: 0, atk: 0, def: 0, move: 0, range: 0 }, archer: { hp: 0, atk: 0, def: 0, move: 0, range: 0 }, spearman: { hp: 0, atk: 0, def: 0, move: 0, range: 0 }, mage: { hp: 0, atk: 0, def: 0, move: 0, range: 0 }, elfRanger: { hp: 0, atk: 0, def: 0, move: 0, range: 0 } };
                      unitProgress = { knight: { level: 1, xp: 0, nextLevelXp: 1000 }, archer: { level: 1, xp: 0, nextLevelXp: 1000 }, spearman: { level: 1, xp: 0, nextLevelXp: 1000, recruited: false }, mage: { level: 1, xp: 0, nextLevelXp: 1000, recruited: false }, elfRanger: { level: 1, xp: 0, nextLevelXp: 1000, recruited: false } };
                      gold = 0;
                      // שמירה רק אם יש db
                      if(db) saveGold();
                      initGame();
                 } else {
                      // אם Firebase לא מוכן, נסה להפעיל את ה-setup שוב, אבל הכפתור אמור להיות כבוי
                      STATUS_MESSAGE.textContent = "טוען נתונים. המתן רגע...";
                      setupFirebase();
                 }
            };

            // NEW: לוגיקת קליק של כפתור הסיפור
            if (TOGGLE_STORY_BTN) {
                TOGGLE_STORY_BTN.onclick = () => {
                    if (STORY_PANEL.style.display === 'none' || STORY_PANEL.style.display === '') {
                        STORY_PANEL.style.display = 'block';
                        TOGGLE_STORY_BTN.textContent = "סגור סיפור ומדריך";
                    } else {
                        STORY_PANEL.style.display = 'none';
                        TOGGLE_STORY_BTN.textContent = "סיפור ומדריך";
                    }
                };
            }


            // NEW: הגדרת קליקים של חנות חפצים - דרישת רמה מיושמת כאן
            
            // Items
            const buyKnightIronSwordBtn = document.getElementById('buy-knight-iron-sword');
            const buyKnightSteelSwordBtn = document.getElementById('buy-knight-steel-sword');
            const buyKnightSteelArmorBtn = document.getElementById('buy-knight-steel-armor');
            const buyArcherIronBowBtn = document.getElementById('buy-archer-iron-bow');
            const buyArcherSteelBowBtn = document.getElementById('buy-archer-steel-bow');
            const buyArcherMoveBtn = document.getElementById('buy-archer-move');
            
            // Recruits
            const recruitSpearmanBtn = document.getElementById('recruit-spearman');
            const recruitMageBtn = document.getElementById('recruit-mage');
            const recruitElfRangerBtn = document.getElementById('recruit-elfRanger'); // NEW HANDLER


            if (buyKnightIronSwordBtn) {
                 // אביר: חרב ברזל (רמה 1, +10 התקפה)
                 buyKnightIronSwordBtn.onclick = () => buyItem('knight', 1500, { atk: 10 }, 'חרב ברזל', 1);
            }
            if (buyKnightSteelSwordBtn) {
                 // אביר: חרב פלדה (רמה 3, +20 התקפה, +1 טווח)
                 buyKnightSteelSwordBtn.onclick = () => buyItem('knight', 2500, { atk: 20, range: 1 }, 'חרב פלדה', 3);
            }
            if (buyKnightSteelArmorBtn) {
                 // אביר: שריון פלדה (רמה 3, +50 חיים, +5 הגנה) - שריון חדש מחליף ישן
                 buyKnightSteelArmorBtn.onclick = () => buyItem('knight', 2000, { hp: 50, def: 5 }, 'שריון פלדה', 3);
            }
            if (buyArcherIronBowBtn) {
                 // קשת: קשת ברזל (רמה 1, +15 התקפה)
                 buyArcherIronBowBtn.onclick = () => buyItem('archer', 1800, { atk: 15 }, 'קשת ברזל', 1);
            }
            if (buyArcherSteelBowBtn) {
                 // קשת: קשת פלדה (רמה 3, +20 התקפה, +1 טווח)
                 buyArcherSteelBowBtn.onclick = () => buyItem('archer', 2500, { atk: 20, range: 1 }, 'קשת פלדה', 3);
            }
            if (buyArcherMoveBtn) {
                 // קשת: מגפי עור (רמה 1, +1 תנועה) - פריט Toggle
                 buyArcherMoveBtn.onclick = () => buyItem('archer', 1500, { move: 1 }, 'מגפי עור', 1);
            }

            // NEW: גיוס יחידות
            if (recruitSpearmanBtn) {
                recruitSpearmanBtn.onclick = () => recruitUnit('spearman', 2000, 'לוחם מגן');
            }
            // UPDATED: Recruit Mage
            if (recruitMageBtn) {
                recruitMageBtn.onclick = () => recruitUnit('mage', 2200, 'מכשף');
            }
            // NEW: Recruit Elven Ranger
            if (recruitElfRangerBtn) {
                recruitElfRangerBtn.onclick = () => recruitUnit('elfRanger', 2100, 'סייר אלפים');
            }


            // הלחצנים לא מבצעים פעולה ישירה יותר, אלא רק מציגים את הסטטוס
            if(MOVE_BTN) MOVE_BTN.onclick = () => { if (selectedUnit) showAvailableActions(); };
            if(ATTACK_BTN) ATTACK_BTN.onclick = () => { if (selectedUnit) showAvailableActions(); };
            
            // הגדרת לוגיקה לכפתור סיום תור
            END_TURN_BTN.onclick = () => {
                if (gameState === 'upgradePhase') {
                    initGame(); // התחל קרב חדש עם שדרוגים חדשים
                } else {
                    startGameTurn();
                }
            };
        };

    </script>
</body>
</html>
